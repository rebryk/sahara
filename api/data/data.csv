id,name,description,query
621785,[STEPN] Active Users 24H / 7D,,"SELECT 
    COUNT(DISTINCT signer) filter (where (now() - block_time) <= interval '24 hours') AS Active_Users_24H,
    COUNT(DISTINCT signer) filter (where (now() - block_time) <= interval '1 week') AS Active_Users_7D
FROM 
    solana.transactions
WHERE
    array_contains(account_keys, ""STEPNq2UGeGSzCyGVr2nMQAzf8xuejwqebd84wcksCK"")
    AND block_date >= (CURRENT_DATE - '7 days'::INTERVAL)
    AND error is NULL"
596593,[STEPN] Deposits & Withdrawal Transactions,,"SELECT
    block_date, 
    SUM(CASE WHEN account_keys[1] = ""STEPNq2UGeGSzCyGVr2nMQAzf8xuejwqebd84wcksCK"" AND size(account_keys) = 3
             THEN 1 ELSE 0 END) AS Deposits_Transactions,
    SUM(CASE WHEN account_keys[0] = ""STEPNq2UGeGSzCyGVr2nMQAzf8xuejwqebd84wcksCK"" 
             THEN 1 ELSE 0 END) AS Withdrawals_Transactions
FROM 
    solana.transactions
WHERE 
    block_date >= (CURRENT_DATE - '60 days'::INTERVAL)
    AND array_contains(account_keys, 'STEPNq2UGeGSzCyGVr2nMQAzf8xuejwqebd84wcksCK')
    AND error is NULL
GROUP BY 
    block_date
ORDER BY 
    block_date DESC"
588826,[STEPN] Daily Users,,"SELECT
    new_users_table.time,
    new_users AS New,
    (unique_users - new_users) AS Existing
FROM (
    SELECT
        unique_users_table.time,
        COUNT(*) AS new_users
    FROM (
        SELECT 
            signer as unique_users,
            MIN(block_date) AS time
        FROM 
            solana.transactions
        WHERE
            block_date >= (CURRENT_DATE - '60 days'::INTERVAL)
            AND block_date < CURRENT_DATE
            AND account_keys[1] = ""STEPNq2UGeGSzCyGVr2nMQAzf8xuejwqebd84wcksCK""
            AND size(account_keys) = 3
            AND error is NULL
        GROUP BY 
            signer
    ) unique_users_table
    GROUP BY
        unique_users_table.time
    ) new_users_table

LEFT JOIN (
    SELECT
        block_date AS time,
        COUNT(DISTINCT signer) AS unique_users
    FROM 
        solana.transactions
    WHERE 
        block_date >= (CURRENT_DATE - '60 days'::INTERVAL)
        AND block_date < CURRENT_DATE
        AND account_keys[1] = ""STEPNq2UGeGSzCyGVr2nMQAzf8xuejwqebd84wcksCK""
        AND size(account_keys) = 3
        AND error is NULL
    GROUP BY 
        time
) table2 ON table2.time = new_users_table.time

ORDER BY
    1 DESC"
625111,[STEPN] Life Time Users,,"SELECT
    COUNT(*) AS cumu_users
FROM 
    solana.transactions
WHERE 
    account_keys[0] = 'STEPNq2UGeGSzCyGVr2nMQAzf8xuejwqebd84wcksCK'
    AND size(account_keys) = 3
    AND block_date >= (CURRENT_DATE - '60 days'::INTERVAL)
    AND success = TRUE"
621861,[STEPN] GST Transferred in BSC Chain,,"SELECT
    date_trunc('day', evt_block_time) AS Time,
    SUM(value / (10 ^ 8)) AS GST_transferred
FROM 
    bep20.""BEP20_evt_Transfer""
WHERE
    contract_address = '\x4a2c860cEC6471b9F5F5a336eB4F38bb21683c98'
GROUP BY
    Time"
621899,[STEPN] GMT Transferred in BSC Chain,,"SELECT
    date_trunc('day', evt_block_time) AS Time,
    SUM(value / (10 ^ 8)) AS GMT_transferred
FROM 
    bep20.""BEP20_evt_Transfer""
WHERE
    contract_address = '\x3019BF2a2eF8040C242C9a4c5c4BD4C81678b2A1'
GROUP BY
    Time"
627689,[STEPN] Cumulated Shoes Minted,,"SELECT
    first_time,
    COUNT(distinct Minted_Shoes) AS New_Shoes,
    SUM(COUNT(distinct Minted_Shoes)) OVER (ORDER BY first_time) as Cumu_Shoes
FROM (
    SELECT
        MIN(block_date) AS first_time,
        post_token_balance['mint'] AS Minted_Shoes
    FROM
        solana.transactions
        LATERAL VIEW explode(post_token_balances) AS post_token_balance
    WHERE 
        block_date >= (CURRENT_DATE - '60 days'::INTERVAL)
        AND signer = 'STEPNq2UGeGSzCyGVr2nMQAzf8xuejwqebd84wcksCK'
        AND array_contains(log_messages, 'Program TokenkegQfeZyiNwAJbNbGKPFXCWuBvf9Ss623VQ5DA invoke [1]')
        AND array_contains(log_messages, 'Program log: Instruction: InitializeMint')
        AND success is true
        AND error is NULL
    GROUP BY 
        Minted_Shoes
)
GROUP BY 
    first_time
"
604562,[STEPN] GMT Deposits & Withdrawals,,"SELECT
    block_date,
    SUM(CASE WHEN post_token_balance.amount - pre_token_balance.amount > 0 THEN post_token_balance.amount - pre_token_balance.amount ELSE 0 END) AS GMT_Deposits,
    SUM(CASE WHEN post_token_balance.amount - pre_token_balance.amount < 0 THEN post_token_balance.amount - pre_token_balance.amount ELSE 0 END) AS GMT_Withdrawals
FROM 
    solana.transactions
    LATERAL VIEW explode(account_keys) t1 AS account 
    LATERAL VIEW explode(pre_token_balances) t2 AS pre_token_balance 
    LATERAL VIEW explode(post_token_balances) t3 AS post_token_balance
WHERE
    block_date >= (CURRENT_DATE - '30 days'::INTERVAL)
    AND account = 'HhXAKYmRzBNi7BjkDs2fbwJ49mnpWUtzyXEf8PAMArs4'
    and pre_token_balance.mint='7i5KKsX2weiTkry7jA4ZwSuXGhs5eJBEjY8vVxR4pfRx'
    and post_token_balance.mint='7i5KKsX2weiTkry7jA4ZwSuXGhs5eJBEjY8vVxR4pfRx'
    and pre_token_balance.account = ""HhXAKYmRzBNi7BjkDs2fbwJ49mnpWUtzyXEf8PAMArs4""
    and post_token_balance.account = ""HhXAKYmRzBNi7BjkDs2fbwJ49mnpWUtzyXEf8PAMArs4""
    AND error is NULL
GROUP BY 
    block_date
ORDER BY 
    block_date DESC"
604436,[STEPN] GST Deposits & Withdrawals,,"SELECT
    block_date,
    SUM(CASE WHEN post_token_balance.amount - pre_token_balance.amount > 0 THEN post_token_balance.amount - pre_token_balance.amount ELSE 0 END) AS GST_Deposits,
    SUM(CASE WHEN post_token_balance.amount - pre_token_balance.amount < 0 THEN post_token_balance.amount - pre_token_balance.amount ELSE 0 END) AS GST_Withdrawals
FROM 
    solana.transactions
    LATERAL VIEW explode(account_keys) t1 AS account 
    LATERAL VIEW explode(pre_token_balances) t2 AS pre_token_balance 
    LATERAL VIEW explode(post_token_balances) t3 AS post_token_balance
WHERE
    block_date >= (CURRENT_DATE - '30 days'::INTERVAL)
    AND account = 'HLS5Y68QSQgJP7wUbbbbCjEnMknVZrHXYDwwVaDcsdK7'
    and pre_token_balance.mint='AFbX8oGjGpmVFywbVouvhQSRmiW2aR1mohfahi4Y2AdB'
    and post_token_balance.mint='AFbX8oGjGpmVFywbVouvhQSRmiW2aR1mohfahi4Y2AdB'
    and pre_token_balance.account = ""HLS5Y68QSQgJP7wUbbbbCjEnMknVZrHXYDwwVaDcsdK7""
    and post_token_balance.account = ""HLS5Y68QSQgJP7wUbbbbCjEnMknVZrHXYDwwVaDcsdK7""
    AND error is NULL
GROUP BY 
    block_date
ORDER BY 
    block_date DESC"
604672,[STEPN] Cumulated Users,,"SELECT 
    first_time,
    COUNT(distinct user_authority) AS new_users,
    SUM(COUNT(distinct user_authority)) OVER (ORDER BY first_time) as cumu_users
FROM (
    SELECT
        account_keys[0] AS user_authority,
        MIN(block_date) AS first_time
    FROM 
        solana.transactions
    WHERE 
        array_contains(account_keys, 'STEPNq2UGeGSzCyGVr2nMQAzf8xuejwqebd84wcksCK')
        AND block_date >= (CURRENT_DATE - '60 days'::INTERVAL)
        AND success = TRUE
    GROUP BY 
        user_authority
    ) 
GROUP BY 
    first_time"
621785,[STEPN] Active Users 24H / 7D,,"SELECT 
    COUNT(DISTINCT signer) filter (where (now() - block_time) <= interval '24 hours') AS Active_Users_24H,
    COUNT(DISTINCT signer) filter (where (now() - block_time) <= interval '1 week') AS Active_Users_7D
FROM 
    solana.transactions
WHERE
    array_contains(account_keys, ""STEPNq2UGeGSzCyGVr2nMQAzf8xuejwqebd84wcksCK"")
    AND block_date >= (CURRENT_DATE - '7 days'::INTERVAL)
    AND error is NULL"
627933,[STEPN] New Shoes Minted 24H / 7D,,"SELECT
    COUNT(distinct post_token_balance['mint']) filter (where (now() - block_time) <= interval '24 hours') AS New_Shoes_24H,
    COUNT(distinct post_token_balance['mint']) filter (where (now() - block_time) <= interval '1 week') AS New_Shoes_7D
FROM
    solana.transactions
    LATERAL VIEW explode(post_token_balances) AS post_token_balance
WHERE 
    block_date >= (CURRENT_DATE - '7 days'::INTERVAL)
    AND signer = 'STEPNq2UGeGSzCyGVr2nMQAzf8xuejwqebd84wcksCK'
    AND array_contains(log_messages, 'Program TokenkegQfeZyiNwAJbNbGKPFXCWuBvf9Ss623VQ5DA invoke [1]')
    AND array_contains(log_messages, 'Program log: Instruction: InitializeMint')
    AND success is true
    AND error is NULL"
627933,[STEPN] New Shoes Minted 24H / 7D,,"SELECT
    COUNT(distinct post_token_balance['mint']) filter (where (now() - block_time) <= interval '24 hours') AS New_Shoes_24H,
    COUNT(distinct post_token_balance['mint']) filter (where (now() - block_time) <= interval '1 week') AS New_Shoes_7D
FROM
    solana.transactions
    LATERAL VIEW explode(post_token_balances) AS post_token_balance
WHERE 
    block_date >= (CURRENT_DATE - '7 days'::INTERVAL)
    AND signer = 'STEPNq2UGeGSzCyGVr2nMQAzf8xuejwqebd84wcksCK'
    AND array_contains(log_messages, 'Program TokenkegQfeZyiNwAJbNbGKPFXCWuBvf9Ss623VQ5DA invoke [1]')
    AND array_contains(log_messages, 'Program log: Instruction: InitializeMint')
    AND success is true
    AND error is NULL"
627907,[STEPN] Shoes Per User,,"WITH Shoe_Table AS (
    SELECT
        first_time,
        SUM(COUNT(distinct Minted_Shoes)) OVER (ORDER BY first_time) as Cumu_Shoes
    FROM (
        SELECT
            MIN(block_date) AS first_time,
            post_token_balance['mint'] AS Minted_Shoes
        FROM
            solana.transactions
            LATERAL VIEW explode(post_token_balances) AS post_token_balance
        WHERE 
            block_date >= (CURRENT_DATE - '60 days'::INTERVAL)
            AND signer = 'STEPNq2UGeGSzCyGVr2nMQAzf8xuejwqebd84wcksCK'
            AND array_contains(log_messages, 'Program TokenkegQfeZyiNwAJbNbGKPFXCWuBvf9Ss623VQ5DA invoke [1]')
            AND array_contains(log_messages, 'Program log: Instruction: InitializeMint')
            AND success is true
            AND error is NULL
        GROUP BY 
            Minted_Shoes
    )
    GROUP BY 
        first_time
),
User_Table AS (
    SELECT 
        first_time,
        SUM(COUNT(distinct user_authority)) OVER (ORDER BY first_time) as Cumu_Users
    FROM (
        SELECT
            account_keys[0] AS user_authority,
            MIN(block_date) AS first_time
        FROM 
            solana.transactions
        WHERE 
            array_contains(account_keys, 'STEPNq2UGeGSzCyGVr2nMQAzf8xuejwqebd84wcksCK')
            AND block_date >= (CURRENT_DATE - '60 days'::INTERVAL)
            AND success = TRUE
        GROUP BY 
            user_authority
        ) 
    GROUP BY 
        first_time
)

SELECT
    Shoe_Table.first_time,
    Cumu_Shoes,
    Cumu_Users,
    ROUND(Cumu_Shoes/Cumu_Users, 3) AS Shoes_Per_User
FROM
    Shoe_Table
JOIN
    User_Table
ON
    Shoe_Table.first_time = User_Table.first_time"
627963,[STEPN] Total Minted Shoes,,"SELECT
    COUNT(DISTINCT post_token_balance['mint']) AS Cumu_Shoes
FROM
    solana.transactions
    LATERAL VIEW explode(post_token_balances) AS post_token_balance
WHERE
    signer = 'STEPNq2UGeGSzCyGVr2nMQAzf8xuejwqebd84wcksCK'
    AND array_contains(log_messages, 'Program TokenkegQfeZyiNwAJbNbGKPFXCWuBvf9Ss623VQ5DA invoke [1]')
    AND array_contains(log_messages, 'Program log: Instruction: InitializeMint')
    AND success is true
    AND error is NULL"
596630,[STEPN] Top 100 SOL Depositors,,"SELECT
    address,
    ROUND(deposited_SOL, 0) AS deposited_SOL,
    CONCAT(ROUND(deposited_SOL * 100 / SUM(deposited_SOL) OVER (), 3), '%') AS percent_of_volume
FROM (
    SELECT 
        signer AS address,
        SUM(CASE WHEN account_keys[1] = ""STEPNq2UGeGSzCyGVr2nMQAzf8xuejwqebd84wcksCK"" AND size(account_keys) = 3
                 THEN (pre_balances[0] - post_balances[0])/power(10,9) ELSE 0 END) AS deposited_SOL
    FROM
        solana.transactions
    WHERE 
        block_date >= (CURRENT_DATE - '60 days'::INTERVAL)
        AND array_contains(account_keys, 'STEPNq2UGeGSzCyGVr2nMQAzf8xuejwqebd84wcksCK')
        AND error is NULL
    GROUP BY
        address
) deposit_table
ORDER BY 
    deposited_SOL DESC
LIMIT 100"
600737,[STEPN] Most Active Addresses,,"SELECT 
    signer AS address,
    COUNT(signatures) As Transactions
FROM
    solana.transactions
WHERE 
    block_date >= (CURRENT_DATE - '60 days'::INTERVAL)
    AND signer != 'STEPNq2UGeGSzCyGVr2nMQAzf8xuejwqebd84wcksCK'
    AND array_contains(account_keys, 'STEPNq2UGeGSzCyGVr2nMQAzf8xuejwqebd84wcksCK')
    AND error is NULL
GROUP BY
    signer
ORDER BY
    Transactions DESC"
588572,[STEPN] Sol Deposits & Withdrawals,,"SELECT
    block_date, 
    SUM(CASE WHEN account_keys[1] = ""STEPNq2UGeGSzCyGVr2nMQAzf8xuejwqebd84wcksCK"" AND size(account_keys) = 3
             THEN (pre_balances[0] - post_balances[0])/power(10,9) ELSE 0 END) AS SOL_Deposits, 
    SUM(CASE WHEN account_keys[0] = ""STEPNq2UGeGSzCyGVr2nMQAzf8xuejwqebd84wcksCK"" 
             THEN (pre_balances[0] - post_balances[0])/power(10,9) ELSE 0 END) AS SOL_Withdrawals
FROM 
    solana.transactions
WHERE 
    block_date >= (CURRENT_DATE - '60 days'::INTERVAL)
    AND array_contains(account_keys, 'STEPNq2UGeGSzCyGVr2nMQAzf8xuejwqebd84wcksCK')
    AND error is NULL
GROUP BY 
    block_date
ORDER BY 
    block_date DESC"
588691,[STEPN] Sol Deposits & Withdrawals in USDC,,"WITH SOL_IN_OUT_FLOW AS (
    SELECT
        block_date, 
        SUM(CASE WHEN account_keys[1] = ""STEPNq2UGeGSzCyGVr2nMQAzf8xuejwqebd84wcksCK"" AND size(account_keys) = 3
                 THEN (pre_balances[0] - post_balances[0])/power(10,9) ELSE 0 END) AS SOL_Deposits, 
        SUM(CASE WHEN account_keys[0] = ""STEPNq2UGeGSzCyGVr2nMQAzf8xuejwqebd84wcksCK"" 
                 THEN (pre_balances[0] - post_balances[0])/power(10,9) ELSE 0 END) AS SOL_Withdrawals
    FROM 
        solana.transactions
    WHERE 
        block_date >= (CURRENT_DATE - '60 days'::INTERVAL)
        AND array_contains(account_keys, 'STEPNq2UGeGSzCyGVr2nMQAzf8xuejwqebd84wcksCK')
        AND error is NULL
    GROUP BY 
        block_date
),
SOL_USDC_SERUM_POOL AS (
    SELECT
        block_date, 
        if(post_token_balance.mint ='EPjFWdd5AufqSSqeM2qN1xzybapC8G4wEGGkZwyTDt1v', SUM(post_token_balance.amount), 1/SUM(post_token_balance.amount)) as tmp
    FROM 
        solana.transactions
        LATERAL VIEW explode(post_token_balances) t3 AS post_token_balance
    WHERE 
        block_date >= (CURRENT_DATE - '60 days'::INTERVAL)
        AND ARRAY_CONTAINS(account_keys, ""9wFFyRfZBsuAha4YcuxcXLKwMxJR43S7fPfQLusDBzvT"")
        AND (post_token_balance.mint = ""So11111111111111111111111111111111111111112"" or post_token_balance.mint = ""EPjFWdd5AufqSSqeM2qN1xzybapC8G4wEGGkZwyTDt1v"")
    GROUP BY
        block_date, 
        post_token_balance.mint
),
SOL_DAILY_PRICE AS (
    SELECT 
        block_date, 
        exp(sum(log(tmp))) as SOL_Price
    FROM 
        SOL_USDC_SERUM_POOL
    GROUP BY 
        block_date
)

SELECT
    block_date,
    SOL_Deposits * SOL_Price AS USDC_Deposits,
    SOL_Withdrawals * SOL_Price AS USDC_Withdrawals
FROM 
    SOL_IN_OUT_FLOW
JOIN 
    SOL_DAILY_PRICE using(block_date)
ORDER BY 
    block_date DESC"
669356,Total Cumulated GMT burn (Worth in $),,"WITH gmt_usdc_orca_pool AS
  (SELECT block_date,
          post_token_balance.mint AS token_address,
          SUM(post_token_balance.amount) AS token_size,
          IF (post_token_balance.mint ='EPjFWdd5AufqSSqeM2qN1xzybapC8G4wEGGkZwyTDt1v', -- USDC contract
 SUM(post_token_balance.amount),
 1/SUM(post_token_balance.amount)) AS tmp
   FROM `solana`.`transactions` LATERAL VIEW EXPLODE(post_token_balances) t3 AS post_token_balance
   WHERE block_date >= '2022-04-01'
     AND ARRAY_CONTAINS(account_keys, ""3HGGVGTXbqT49PG3L8JQYH4jCeP5CNBG6CpJniZ434an"") --usdc/gmt pool
     AND ((post_token_balance.mint = ""7i5KKsX2weiTkry7jA4ZwSuXGhs5eJBEjY8vVxR4pfRx"" -- GMT contract
     AND post_token_balance.account = ""BTpvbpTArnekGgbXRqjfSvp7gENtHXvZCAwuUKQNYMeN"")
        OR (post_token_balance.mint = ""EPjFWdd5AufqSSqeM2qN1xzybapC8G4wEGGkZwyTDt1v"" -- USDC mint 
     AND post_token_balance.account = ""DdBTJuiAXQQ7gLVXBXNPbVEG8g1avRxiJXhH5LhBytYW""))-- USDC contract

   GROUP BY block_date,
            post_token_balance.mint),
     gmt_price AS
  (SELECT block_date,
          round(EXP(SUM(LOG(tmp))), 2) AS gmt_price
   FROM gmt_usdc_orca_pool
   GROUP BY block_date )
   
  , pre_balances AS (
    SELECT date_trunc('day', block_time) AS d, 
    SUM(pre_token_balance.amount) as total_pre_balance
    FROM solana.transactions
    LATERAL VIEW explode(pre_token_balances) t1 AS pre_token_balance
    WHERE block_time >= '2022-04-01'
        AND block_time < CURRENT_DATE
        AND array_contains(account_keys, '7i5KKsX2weiTkry7jA4ZwSuXGhs5eJBEjY8vVxR4pfRx') -- gmt contract
        AND CAST(log_messages AS STRING) LIKE '%Program log: Instruction: Burn%'
        AND success = TRUE
    GROUP BY 1
),
post_balances AS (
    SELECT date_trunc('day', block_time) AS d, 
    SUM(post_token_balance.amount) as total_post_balance
    FROM solana.transactions
    LATERAL VIEW explode(post_token_balances) t2 AS post_token_balance
    WHERE 
        block_time >= '2022-04-01'
        AND array_contains(account_keys, '7i5KKsX2weiTkry7jA4ZwSuXGhs5eJBEjY8vVxR4pfRx')
        AND CAST(log_messages AS STRING) LIKE '%Program log: Instruction: Burn%'
        AND success = TRUE
    GROUP BY 1
)
, total_burn AS (SELECT *, 
    -(total_post_balance - total_pre_balance) as total_burn
FROM (
    SELECT pre_balances.d, total_pre_balance, total_post_balance
    FROM pre_balances
    LEFT JOIN post_balances ON pre_balances.d = post_balances.d
) as t ) 

, gmt_value AS (
SELECT block_date, gmt_price*total_burn as gmt_worth_burn
FROM total_burn t
JOIN gmt_price g ON  t.d = g.block_date 
) 

SELECT sum(gmt_worth_burn) AS gmt_worth_burn 
FROM gmt_value"
669617,STEPN Shoes/Sneakers Minted in Last 24 Hours,,"SELECT
    block_date,
    COUNT(distinct post_token_balance['mint']) as shoes
    -- COUNT(distinct post_token_balance['mint']) filter (where (now() - block_time) <= interval '1 week') AS New_Shoes_7D
FROM
    solana.transactions
    LATERAL VIEW explode(post_token_balances) AS post_token_balance
WHERE 1=1
    AND block_date >= (CURRENT_DATE - '1 days'::INTERVAL)
    AND block_date < CURRENT_DATE
    AND signer = 'STEPNq2UGeGSzCyGVr2nMQAzf8xuejwqebd84wcksCK'
    AND array_contains(log_messages, 'Program TokenkegQfeZyiNwAJbNbGKPFXCWuBvf9Ss623VQ5DA invoke [1]')
    AND array_contains(log_messages, 'Program log: Instruction: InitializeMint')
    AND success is true
    AND error is NULL
GROUP BY  1 "
823839,STEPN Monthly Active User (MAU),,"SELECT
    date_trunc('month',block_date) as month,
    COUNT(distinct signer) as active_users
FROM
    solana.transactions
WHERE 1=1
        AND block_date >= '2022-01-01'
        AND block_date < CURRENT_DATE
        AND (ARRAY_CONTAINS(account_keys,""STEPNq2UGeGSzCyGVr2nMQAzf8xuejwqebd84wcksCK"") -- Address deposit SOL from Wallet to Spending
        OR ARRAY_CONTAINS(account_keys,""HLS5Y68QSQgJP7wUbbbbCjEnMknVZrHXYDwwVaDcsdK7"")  -- GST Address of STEPN 
        OR ARRAY_CONTAINS(account_keys,""7i5KKsX2weiTkry7jA4ZwSuXGhs5eJBEjY8vVxR4pfRx"") -- GMT 
        OR ARRAY_CONTAINS(account_keys,""AFbX8oGjGpmVFywbVouvhQSRmiW2aR1mohfahi4Y2AdB"") -- GST
            ) AND success = 'true'
GROUP BY  1 "
539984,Active Deposit Users (SOL to STEPN) ,,"SELECT 
    block_date, 
    COUNT(distinct account_keys[0]) as active_deposit_users
FROM solana.transactions
WHERE 
    block_date >= (CURRENT_DATE - '30 days'::INTERVAL)
    AND block_date < CURRENT_DATE
    AND account_keys[1] = ""STEPNq2UGeGSzCyGVr2nMQAzf8xuejwqebd84wcksCK"" -- Address deposit SOL from Wallet to Spending
    AND size(account_keys) = 3
    AND error is NULL
GROUP BY
    block_date
ORDER BY 
    block_date desc"
621702,STEPN Daily Transactions (90 Days),,"SELECT 
    block_date, 
    COUNT(distinct account_keys[0]) as active_users,
    COUNT(signer) as transactions, 
    COUNT(signer)/COUNT(distinct account_keys[0]) as trans_per_users, 
    ROUND((COUNT(signer) - LAG(COUNT(signer)) OVER(ORDER BY block_date ASC)) / LAG(COUNT(signer)) OVER(ORDER BY block_date ASC) * 100,2) AS growth_transactions,
    ROUND((COUNT(distinct account_keys[0]) - LAG(COUNT(distinct account_keys[0])) OVER(ORDER BY block_date ASC)) / LAG(COUNT(distinct account_keys[0])) OVER(ORDER BY block_date ASC) * 100,2) AS growth_users
FROM solana.transactions
WHERE 
    block_date >= (CURRENT_DATE - '90 days'::INTERVAL)
    AND block_date < CURRENT_DATE
    AND ( ARRAY_CONTAINS(account_keys,""STEPNq2UGeGSzCyGVr2nMQAzf8xuejwqebd84wcksCK"") -- Address deposit SOL from Wallet to Spending
    OR ARRAY_CONTAINS(account_keys,""HLS5Y68QSQgJP7wUbbbbCjEnMknVZrHXYDwwVaDcsdK7"")  -- GST Address of STEPN 
    OR ARRAY_CONTAINS(account_keys,""7i5KKsX2weiTkry7jA4ZwSuXGhs5eJBEjY8vVxR4pfRx"") -- GMT 
    OR ARRAY_CONTAINS(account_keys,""AFbX8oGjGpmVFywbVouvhQSRmiW2aR1mohfahi4Y2AdB"") ) -- GST
    AND error is NULL
GROUP BY
    block_date
ORDER BY 
    block_date desc"
549549,New & Existing Daily Active Users on STEPN,,"SELECT
    ssq.time,
    new_users AS New,
    (unique_users - new_users) AS Existing
FROM (
SELECT
    sq.time,
    COUNT(*) AS new_users
FROM (
    SELECT 
        signer as unique_users,
        MIN(date_trunc('day', block_time)) AS time
    FROM `solana`.`transactions`
   WHERE 
    block_date >= '2022-01-01'
    AND block_date < CURRENT_DATE
    AND (ARRAY_CONTAINS(account_keys,""STEPNq2UGeGSzCyGVr2nMQAzf8xuejwqebd84wcksCK"") -- Address deposit SOL from Wallet to Spending
    OR ARRAY_CONTAINS(account_keys,""HLS5Y68QSQgJP7wUbbbbCjEnMknVZrHXYDwwVaDcsdK7"")  -- GST Address of STEPN 
    OR ARRAY_CONTAINS(account_keys,""7i5KKsX2weiTkry7jA4ZwSuXGhs5eJBEjY8vVxR4pfRx"") -- GMT 
    OR ARRAY_CONTAINS(account_keys,""AFbX8oGjGpmVFywbVouvhQSRmiW2aR1mohfahi4Y2AdB"") ) -- GST
    AND error is NULL
    GROUP BY 1
    ORDER BY 1
) sq
GROUP BY 1
ORDER BY 1 DESC 
) ssq
LEFT JOIN (
    SELECT
        date_trunc('day', block_time) AS time,
        COUNT(DISTINCT signer) AS unique_users
    FROM `solana`.`transactions`
    WHERE 
    block_date >= '2022-01-01'
    AND block_date < CURRENT_DATE
    AND ( ARRAY_CONTAINS(account_keys,""STEPNq2UGeGSzCyGVr2nMQAzf8xuejwqebd84wcksCK"") -- Address deposit SOL from Wallet to Spending
    OR ARRAY_CONTAINS(account_keys,""HLS5Y68QSQgJP7wUbbbbCjEnMknVZrHXYDwwVaDcsdK7"")  -- GST Address of STEPN 
    OR ARRAY_CONTAINS(account_keys,""7i5KKsX2weiTkry7jA4ZwSuXGhs5eJBEjY8vVxR4pfRx"") -- GMT 
    OR ARRAY_CONTAINS(account_keys,""AFbX8oGjGpmVFywbVouvhQSRmiW2aR1mohfahi4Y2AdB"") ) -- GST
    AND error is NULL
    GROUP BY 1
    ORDER BY 1
) t2 ON t2.time = ssq.time
ORDER BY 1 DESC"
830534,DAU Daily Active Users - STEPN vs non-STEPN users on Solana,,"SELECT
    date_trunc('day',block_date) as day,
    case when (ARRAY_CONTAINS(account_keys,""STEPNq2UGeGSzCyGVr2nMQAzf8xuejwqebd84wcksCK"") -- Address deposit SOL from Wallet to Spending
    OR ARRAY_CONTAINS(account_keys,""HLS5Y68QSQgJP7wUbbbbCjEnMknVZrHXYDwwVaDcsdK7"")  -- GST Address of STEPN 
    OR ARRAY_CONTAINS(account_keys,""7i5KKsX2weiTkry7jA4ZwSuXGhs5eJBEjY8vVxR4pfRx"") -- GMT 
    OR ARRAY_CONTAINS(account_keys,""AFbX8oGjGpmVFywbVouvhQSRmiW2aR1mohfahi4Y2AdB"") ) -- GST 
    then 'STEPN' else 'NON_STEPN' end as user_type,
    COUNT(DISTINCT signer) as active_users, 
    COUNT(signer) as transactions
FROM
    solana.transactions
WHERE 1=1
        AND block_date >= '2022-01-01'
        AND block_date < CURRENT_DATE
        AND success = 'true'
GROUP BY  1,2 
"
540064,Top 100 Wallets Deposited SOL of STEPN in 30 Days,,"WITH top_deposit AS (
SELECT 
    signer as address,
    sum(case when account_keys[1] = ""STEPNq2UGeGSzCyGVr2nMQAzf8xuejwqebd84wcksCK"" and size(account_keys) = 3
             then (pre_balances[0] - post_balances[0])/power(10,9) else 0 end) as deposited_SOL 
    -- ,sum(case when account_keys[0] = ""STEPNq2UGeGSzCyGVr2nMQAzf8xuejwqebd84wcksCK"" 
    --          then (pre_balances[0] - post_balances[0])/power(10,9) else 0 end) as withdrawn_SOL
FROM solana.transactions
WHERE 
    block_date >= (CURRENT_DATE - '30 days'::INTERVAL)
    and block_date <= CURRENT_DATE
    AND (account_keys[1] = ""STEPNq2UGeGSzCyGVr2nMQAzf8xuejwqebd84wcksCK""
    OR account_keys[0] = ""STEPNq2UGeGSzCyGVr2nMQAzf8xuejwqebd84wcksCK"" )
    AND error is NULL
GROUP BY 1
) 

SELECT 
 *, CONCAT(ROUND(deposited_SOL*100/SUM(deposited_SOL) OVER (),3),'%') AS percent_of_volume
FROM 
 top_deposit
ORDER BY 
 deposited_SOL DESC
LIMIT 100"
669627,STEPN Active Users in Last 24 Hours,,"SELECT 
    block_date, 
    COUNT(distinct account_keys[0]) as active_users,
    COUNT(signer) as transactions, 
    COUNT(signer)/COUNT(distinct account_keys[0]) as trans_per_users, 
    ROUND((COUNT(signer) - LAG(COUNT(signer)) OVER(ORDER BY block_date ASC)) / LAG(COUNT(signer)) OVER(ORDER BY block_date ASC) * 100,2) AS growth_transactions,
    ROUND((COUNT(distinct account_keys[0]) - LAG(COUNT(distinct account_keys[0])) OVER(ORDER BY block_date ASC)) / LAG(COUNT(distinct account_keys[0])) OVER(ORDER BY block_date ASC) * 100,2) AS growth_users
FROM solana.transactions
WHERE 
    block_date >= (CURRENT_DATE - '1 days'::INTERVAL)
    AND block_date < CURRENT_DATE
    AND ( ARRAY_CONTAINS(account_keys,""STEPNq2UGeGSzCyGVr2nMQAzf8xuejwqebd84wcksCK"") -- Address deposit SOL from Wallet to Spending
    OR ARRAY_CONTAINS(account_keys,""HLS5Y68QSQgJP7wUbbbbCjEnMknVZrHXYDwwVaDcsdK7"") 
    OR ARRAY_CONTAINS(account_keys,""7i5KKsX2weiTkry7jA4ZwSuXGhs5eJBEjY8vVxR4pfRx"") 
    OR ARRAY_CONTAINS(account_keys,""AFbX8oGjGpmVFywbVouvhQSRmiW2aR1mohfahi4Y2AdB"") )
    AND error is NULL
GROUP BY
    block_date
ORDER BY 
    block_date desc"
549549,New & Existing Daily Active Users on STEPN,,"SELECT
    ssq.time,
    new_users AS New,
    (unique_users - new_users) AS Existing
FROM (
SELECT
    sq.time,
    COUNT(*) AS new_users
FROM (
    SELECT 
        signer as unique_users,
        MIN(date_trunc('day', block_time)) AS time
    FROM `solana`.`transactions`
   WHERE 
    block_date >= '2022-01-01'
    AND block_date < CURRENT_DATE
    AND (ARRAY_CONTAINS(account_keys,""STEPNq2UGeGSzCyGVr2nMQAzf8xuejwqebd84wcksCK"") -- Address deposit SOL from Wallet to Spending
    OR ARRAY_CONTAINS(account_keys,""HLS5Y68QSQgJP7wUbbbbCjEnMknVZrHXYDwwVaDcsdK7"")  -- GST Address of STEPN 
    OR ARRAY_CONTAINS(account_keys,""7i5KKsX2weiTkry7jA4ZwSuXGhs5eJBEjY8vVxR4pfRx"") -- GMT 
    OR ARRAY_CONTAINS(account_keys,""AFbX8oGjGpmVFywbVouvhQSRmiW2aR1mohfahi4Y2AdB"") ) -- GST
    AND error is NULL
    GROUP BY 1
    ORDER BY 1
) sq
GROUP BY 1
ORDER BY 1 DESC 
) ssq
LEFT JOIN (
    SELECT
        date_trunc('day', block_time) AS time,
        COUNT(DISTINCT signer) AS unique_users
    FROM `solana`.`transactions`
    WHERE 
    block_date >= '2022-01-01'
    AND block_date < CURRENT_DATE
    AND ( ARRAY_CONTAINS(account_keys,""STEPNq2UGeGSzCyGVr2nMQAzf8xuejwqebd84wcksCK"") -- Address deposit SOL from Wallet to Spending
    OR ARRAY_CONTAINS(account_keys,""HLS5Y68QSQgJP7wUbbbbCjEnMknVZrHXYDwwVaDcsdK7"")  -- GST Address of STEPN 
    OR ARRAY_CONTAINS(account_keys,""7i5KKsX2weiTkry7jA4ZwSuXGhs5eJBEjY8vVxR4pfRx"") -- GMT 
    OR ARRAY_CONTAINS(account_keys,""AFbX8oGjGpmVFywbVouvhQSRmiW2aR1mohfahi4Y2AdB"") ) -- GST
    AND error is NULL
    GROUP BY 1
    ORDER BY 1
) t2 ON t2.time = ssq.time
ORDER BY 1 DESC"
640224,GMT Daily Burn,"1st Burn from Apr 13, 2022","WITH pre_balances AS (
    SELECT date_trunc('day', block_time) AS d, 
    SUM(pre_token_balance.amount) as total_pre_balance
    FROM solana.transactions
    LATERAL VIEW explode(pre_token_balances) t1 AS pre_token_balance
    WHERE block_time >= '2022-04-01'
        AND block_time < CURRENT_DATE
        AND array_contains(account_keys, '7i5KKsX2weiTkry7jA4ZwSuXGhs5eJBEjY8vVxR4pfRx') -- gmt contract
        AND CAST(log_messages AS STRING) LIKE '%Program log: Instruction: Burn%'
        AND success = TRUE
    GROUP BY 1
),
post_balances AS (
    SELECT date_trunc('day', block_time) AS d, 
    SUM(post_token_balance.amount) as total_post_balance
    FROM solana.transactions
    LATERAL VIEW explode(post_token_balances) t2 AS post_token_balance
    WHERE 
        block_time >= '2022-04-01'
        AND array_contains(account_keys, '7i5KKsX2weiTkry7jA4ZwSuXGhs5eJBEjY8vVxR4pfRx')
        AND CAST(log_messages AS STRING) LIKE '%Program log: Instruction: Burn%'
        AND success = TRUE
    GROUP BY 1
)
SELECT *, 
    -(total_post_balance - total_pre_balance) as total_burn
FROM (
    SELECT pre_balances.d, total_pre_balance, total_post_balance
    FROM pre_balances
    LEFT JOIN post_balances ON pre_balances.d = post_balances.d
) as t"
690837,(BNB Chain) Average Deposited BNB per User in STEPN,,"SELECT date_trunc('day', b.block_time),
       count(b.""from"") AS transactions,
       count(DISTINCT b.""from"") AS deposit_users, 
       sum(b.value)/1e18 as bnb_deposit, 
       (sum(b.value)/1e18)/count(DISTINCT b.""from"") as bnb_per_user
FROM bsc.""transactions"" b
LEFT JOIN bsc.""logs"" l ON b.block_hash = l.block_hash
WHERE 1=1
  AND b.block_time >= (CURRENT_DATE - '30 days'::INTERVAL)
  AND b.block_time < CURRENT_DATE
  AND l.block_time >= (CURRENT_DATE - '30 days'::INTERVAL)
  AND l.block_time < CURRENT_DATE
  AND b.success = true
  AND b.""to"" = '\x6238872a0bd9f0e19073695532a7ed77ce93c69e' -- STEPN HotWallet @BSC
  AND l.contract_address = '\xbb4cdb9cbd36b01bd1cbaebf2de08d9173bc095c'
GROUP BY 1
"
540557,Total Accumulated Deposited Active Users of STEPN,,"WITH firstseen AS (
  SELECT account_keys[0] as account_id, MIN(block_date) as block_date
  FROM `solana`.`transactions`
  WHERE 1=1 
    AND block_date >= '2022-01-01'
    AND block_date < CURRENT_DATE
    AND ( ARRAY_CONTAINS(account_keys,""STEPNq2UGeGSzCyGVr2nMQAzf8xuejwqebd84wcksCK"") -- Address deposit SOL from Wallet to Spending
    OR ARRAY_CONTAINS(account_keys,""HLS5Y68QSQgJP7wUbbbbCjEnMknVZrHXYDwwVaDcsdK7"") 
    OR ARRAY_CONTAINS(account_keys,""7i5KKsX2weiTkry7jA4ZwSuXGhs5eJBEjY8vVxR4pfRx"") 
    OR ARRAY_CONTAINS(account_keys,""AFbX8oGjGpmVFywbVouvhQSRmiW2aR1mohfahi4Y2AdB"") )
    AND error is NULL
  GROUP BY 1
)
SELECT DISTINCT block_date, COUNT(account_id) OVER (ORDER BY block_date) as active_users 
FROM firstseen
"
673471,GMT Total Token Supply,,"WITH pre_balances AS (
    SELECT date_trunc('day', block_time) AS d, 
    SUM(pre_token_balance.amount) as total_pre_balance
    FROM solana.transactions
    LATERAL VIEW explode(pre_token_balances) t1 AS pre_token_balance
    WHERE block_time >= '2022-04-01'
        AND array_contains(account_keys, '7i5KKsX2weiTkry7jA4ZwSuXGhs5eJBEjY8vVxR4pfRx') -- gmt contract
        AND CAST(log_messages AS STRING) LIKE '%Program log: Instruction: Burn%'
        AND success = TRUE
    GROUP BY 1
),
post_balances AS (
    SELECT date_trunc('day', block_time) AS d, 
    SUM(post_token_balance.amount) as total_post_balance
    FROM solana.transactions
    LATERAL VIEW explode(post_token_balances) t2 AS post_token_balance
    WHERE 
        block_time >= '2022-04-01'
        AND array_contains(account_keys, '7i5KKsX2weiTkry7jA4ZwSuXGhs5eJBEjY8vVxR4pfRx')
        AND CAST(log_messages AS STRING) LIKE '%Program log: Instruction: Burn%'
        AND success = TRUE
    GROUP BY 1
)
, total_burn AS (SELECT *, 
    -(total_post_balance - total_pre_balance) as total_burn
FROM (
    SELECT pre_balances.d, total_pre_balance, total_post_balance
    FROM pre_balances
    LEFT JOIN post_balances ON pre_balances.d = post_balances.d
) as t ) 

SELECT 6e9 - sum(total_burn) as total_supply, 100*sum(total_burn)/6e9 as rate_burn, 
6e8 - sum(total_burn) as circulating_supply, 100*sum(total_burn)/6e8 as rate_burn_circulating
FROM total_burn"
621702,STEPN Daily Transactions (90 Days),,"SELECT 
    block_date, 
    COUNT(distinct account_keys[0]) as active_users,
    COUNT(signer) as transactions, 
    COUNT(signer)/COUNT(distinct account_keys[0]) as trans_per_users, 
    ROUND((COUNT(signer) - LAG(COUNT(signer)) OVER(ORDER BY block_date ASC)) / LAG(COUNT(signer)) OVER(ORDER BY block_date ASC) * 100,2) AS growth_transactions,
    ROUND((COUNT(distinct account_keys[0]) - LAG(COUNT(distinct account_keys[0])) OVER(ORDER BY block_date ASC)) / LAG(COUNT(distinct account_keys[0])) OVER(ORDER BY block_date ASC) * 100,2) AS growth_users
FROM solana.transactions
WHERE 
    block_date >= (CURRENT_DATE - '90 days'::INTERVAL)
    AND block_date < CURRENT_DATE
    AND ( ARRAY_CONTAINS(account_keys,""STEPNq2UGeGSzCyGVr2nMQAzf8xuejwqebd84wcksCK"") -- Address deposit SOL from Wallet to Spending
    OR ARRAY_CONTAINS(account_keys,""HLS5Y68QSQgJP7wUbbbbCjEnMknVZrHXYDwwVaDcsdK7"")  -- GST Address of STEPN 
    OR ARRAY_CONTAINS(account_keys,""7i5KKsX2weiTkry7jA4ZwSuXGhs5eJBEjY8vVxR4pfRx"") -- GMT 
    OR ARRAY_CONTAINS(account_keys,""AFbX8oGjGpmVFywbVouvhQSRmiW2aR1mohfahi4Y2AdB"") ) -- GST
    AND error is NULL
GROUP BY
    block_date
ORDER BY 
    block_date desc"
690871,(BNB Chain) GST Withdrawn Amount ,,"SELECT date_trunc('day', b.block_time) as day,
       count(b.`from`) AS transactions,
       count(DISTINCT b.`to`) AS withdraw_users, 
       sum(b.value)/1e18 as gst_withdraw, 
       (sum(b.value)/1e18)/count(DISTINCT b.`to`) as gst_per_user
FROM bnb.transactions b
LEFT JOIN bnb.logs l ON b.block_hash = l.block_hash
WHERE 1=1
  AND b.block_time >= (CURRENT_DATE - '30 days'::INTERVAL)
  AND b.block_time < CURRENT_DATE
  AND l.block_time >= (CURRENT_DATE - '30 days'::INTERVAL)
  AND l.block_time < CURRENT_DATE
  AND b.success = true
  AND b.`from` = '0x6238872a0bd9f0e19073695532a7ed77ce93c69e' -- STEPN HotWallet @BSC
--   AND l.contract_address = '0x4a2c860cec6471b9f5f5a336eb4f38bb21683c98' -- GMT Address
GROUP BY 1
"
690871,(BNB Chain) GST Withdrawn Amount ,,"SELECT date_trunc('day', b.block_time) as day,
       count(b.`from`) AS transactions,
       count(DISTINCT b.`to`) AS withdraw_users, 
       sum(b.value)/1e18 as gst_withdraw, 
       (sum(b.value)/1e18)/count(DISTINCT b.`to`) as gst_per_user
FROM bnb.transactions b
LEFT JOIN bnb.logs l ON b.block_hash = l.block_hash
WHERE 1=1
  AND b.block_time >= (CURRENT_DATE - '30 days'::INTERVAL)
  AND b.block_time < CURRENT_DATE
  AND l.block_time >= (CURRENT_DATE - '30 days'::INTERVAL)
  AND l.block_time < CURRENT_DATE
  AND b.success = true
  AND b.`from` = '0x6238872a0bd9f0e19073695532a7ed77ce93c69e' -- STEPN HotWallet @BSC
--   AND l.contract_address = '0x4a2c860cec6471b9f5f5a336eb4f38bb21683c98' -- GMT Address
GROUP BY 1
"
609255,SOL Price (in USD),,"select 
    date_trunc('day', hour) as day,
    max(round(median_price::numeric,2)) as SOL_price
from dex.""view_token_prices"" d
left join erc20.tokens e on d.contract_address = e.contract_address
WHERE symbol = 'SOL'
and hour >= '2022-01-01'
and hour <= current_date
group by 1 
"
621702,STEPN Daily Transactions (90 Days),,"SELECT 
    block_date, 
    COUNT(distinct account_keys[0]) as active_users,
    COUNT(signer) as transactions, 
    COUNT(signer)/COUNT(distinct account_keys[0]) as trans_per_users, 
    ROUND((COUNT(signer) - LAG(COUNT(signer)) OVER(ORDER BY block_date ASC)) / LAG(COUNT(signer)) OVER(ORDER BY block_date ASC) * 100,2) AS growth_transactions,
    ROUND((COUNT(distinct account_keys[0]) - LAG(COUNT(distinct account_keys[0])) OVER(ORDER BY block_date ASC)) / LAG(COUNT(distinct account_keys[0])) OVER(ORDER BY block_date ASC) * 100,2) AS growth_users
FROM solana.transactions
WHERE 
    block_date >= (CURRENT_DATE - '90 days'::INTERVAL)
    AND block_date < CURRENT_DATE
    AND ( ARRAY_CONTAINS(account_keys,""STEPNq2UGeGSzCyGVr2nMQAzf8xuejwqebd84wcksCK"") -- Address deposit SOL from Wallet to Spending
    OR ARRAY_CONTAINS(account_keys,""HLS5Y68QSQgJP7wUbbbbCjEnMknVZrHXYDwwVaDcsdK7"")  -- GST Address of STEPN 
    OR ARRAY_CONTAINS(account_keys,""7i5KKsX2weiTkry7jA4ZwSuXGhs5eJBEjY8vVxR4pfRx"") -- GMT 
    OR ARRAY_CONTAINS(account_keys,""AFbX8oGjGpmVFywbVouvhQSRmiW2aR1mohfahi4Y2AdB"") ) -- GST
    AND error is NULL
GROUP BY
    block_date
ORDER BY 
    block_date desc"
538347,GST Price (in USDC),,"WITH gst_usdc_orca_pool AS
  (SELECT block_date,
          post_token_balance.mint AS token_address,
          SUM(post_token_balance.amount) AS token_size,
          IF (post_token_balance.mint ='EPjFWdd5AufqSSqeM2qN1xzybapC8G4wEGGkZwyTDt1v', -- USDC contract
          SUM(post_token_balance.amount),
          1/SUM(post_token_balance.amount)) AS tmp
   FROM `solana`.`transactions` LATERAL VIEW EXPLODE(post_token_balances) t3 AS post_token_balance
   WHERE block_date >= (CURRENT_DATE - '30 days'::INTERVAL)
     AND ARRAY_CONTAINS(account_keys, ""CwwMfXPXfRT5H5JUatpBctASRGhKW2SqLWWGU3eX5Zgo"") --usdc/gst pool
     AND ((post_token_balance.mint = ""AFbX8oGjGpmVFywbVouvhQSRmiW2aR1mohfahi4Y2AdB"" -- GST contract
           AND post_token_balance.account = ""9r39vqrJuubgafaJ5aQyDWYAUQVJeyZyveBXeRqp7xev"")
          OR (post_token_balance.mint = ""EPjFWdd5AufqSSqeM2qN1xzybapC8G4wEGGkZwyTDt1v"" -- USDC contract
              AND post_token_balance.account = ""7LFnr5YgUyEgPMCLGNQ9N7wM5MFRNqCuRawLZTe5q4c7"")) -- USDC mint
   GROUP BY block_date,
            post_token_balance.mint)
SELECT block_date,
       round(EXP(SUM(LOG(tmp))), 2) AS gst_price
FROM gst_usdc_orca_pool
GROUP BY block_date"
630635,STEPN Daily Shoes/Sneakers Minted,,"SELECT
    block_date,
    COUNT(distinct post_token_balance['mint']) as shoes
    -- COUNT(distinct post_token_balance['mint']) filter (where (now() - block_time) <= interval '1 week') AS New_Shoes_7D
FROM
    solana.transactions
    LATERAL VIEW explode(post_token_balances) AS post_token_balance
WHERE 1=1
    AND block_date >= (CURRENT_DATE - '90 days'::INTERVAL)
    AND block_date < CURRENT_DATE
    AND signer = 'STEPNq2UGeGSzCyGVr2nMQAzf8xuejwqebd84wcksCK'
    AND array_contains(log_messages, 'Program TokenkegQfeZyiNwAJbNbGKPFXCWuBvf9Ss623VQ5DA invoke [1]')
    AND array_contains(log_messages, 'Program log: Instruction: InitializeMint')
    AND success is true
    AND error is NULL
GROUP BY  1 "
621702,STEPN Daily Transactions (90 Days),,"SELECT 
    block_date, 
    COUNT(distinct account_keys[0]) as active_users,
    COUNT(signer) as transactions, 
    COUNT(signer)/COUNT(distinct account_keys[0]) as trans_per_users, 
    ROUND((COUNT(signer) - LAG(COUNT(signer)) OVER(ORDER BY block_date ASC)) / LAG(COUNT(signer)) OVER(ORDER BY block_date ASC) * 100,2) AS growth_transactions,
    ROUND((COUNT(distinct account_keys[0]) - LAG(COUNT(distinct account_keys[0])) OVER(ORDER BY block_date ASC)) / LAG(COUNT(distinct account_keys[0])) OVER(ORDER BY block_date ASC) * 100,2) AS growth_users
FROM solana.transactions
WHERE 
    block_date >= (CURRENT_DATE - '90 days'::INTERVAL)
    AND block_date < CURRENT_DATE
    AND ( ARRAY_CONTAINS(account_keys,""STEPNq2UGeGSzCyGVr2nMQAzf8xuejwqebd84wcksCK"") -- Address deposit SOL from Wallet to Spending
    OR ARRAY_CONTAINS(account_keys,""HLS5Y68QSQgJP7wUbbbbCjEnMknVZrHXYDwwVaDcsdK7"")  -- GST Address of STEPN 
    OR ARRAY_CONTAINS(account_keys,""7i5KKsX2weiTkry7jA4ZwSuXGhs5eJBEjY8vVxR4pfRx"") -- GMT 
    OR ARRAY_CONTAINS(account_keys,""AFbX8oGjGpmVFywbVouvhQSRmiW2aR1mohfahi4Y2AdB"") ) -- GST
    AND error is NULL
GROUP BY
    block_date
ORDER BY 
    block_date desc"
673471,GMT Total Token Supply,,"WITH pre_balances AS (
    SELECT date_trunc('day', block_time) AS d, 
    SUM(pre_token_balance.amount) as total_pre_balance
    FROM solana.transactions
    LATERAL VIEW explode(pre_token_balances) t1 AS pre_token_balance
    WHERE block_time >= '2022-04-01'
        AND array_contains(account_keys, '7i5KKsX2weiTkry7jA4ZwSuXGhs5eJBEjY8vVxR4pfRx') -- gmt contract
        AND CAST(log_messages AS STRING) LIKE '%Program log: Instruction: Burn%'
        AND success = TRUE
    GROUP BY 1
),
post_balances AS (
    SELECT date_trunc('day', block_time) AS d, 
    SUM(post_token_balance.amount) as total_post_balance
    FROM solana.transactions
    LATERAL VIEW explode(post_token_balances) t2 AS post_token_balance
    WHERE 
        block_time >= '2022-04-01'
        AND array_contains(account_keys, '7i5KKsX2weiTkry7jA4ZwSuXGhs5eJBEjY8vVxR4pfRx')
        AND CAST(log_messages AS STRING) LIKE '%Program log: Instruction: Burn%'
        AND success = TRUE
    GROUP BY 1
)
, total_burn AS (SELECT *, 
    -(total_post_balance - total_pre_balance) as total_burn
FROM (
    SELECT pre_balances.d, total_pre_balance, total_post_balance
    FROM pre_balances
    LEFT JOIN post_balances ON pre_balances.d = post_balances.d
) as t ) 

SELECT 6e9 - sum(total_burn) as total_supply, 100*sum(total_burn)/6e9 as rate_burn, 
6e8 - sum(total_burn) as circulating_supply, 100*sum(total_burn)/6e8 as rate_burn_circulating
FROM total_burn"
673471,GMT Total Token Supply,,"WITH pre_balances AS (
    SELECT date_trunc('day', block_time) AS d, 
    SUM(pre_token_balance.amount) as total_pre_balance
    FROM solana.transactions
    LATERAL VIEW explode(pre_token_balances) t1 AS pre_token_balance
    WHERE block_time >= '2022-04-01'
        AND array_contains(account_keys, '7i5KKsX2weiTkry7jA4ZwSuXGhs5eJBEjY8vVxR4pfRx') -- gmt contract
        AND CAST(log_messages AS STRING) LIKE '%Program log: Instruction: Burn%'
        AND success = TRUE
    GROUP BY 1
),
post_balances AS (
    SELECT date_trunc('day', block_time) AS d, 
    SUM(post_token_balance.amount) as total_post_balance
    FROM solana.transactions
    LATERAL VIEW explode(post_token_balances) t2 AS post_token_balance
    WHERE 
        block_time >= '2022-04-01'
        AND array_contains(account_keys, '7i5KKsX2weiTkry7jA4ZwSuXGhs5eJBEjY8vVxR4pfRx')
        AND CAST(log_messages AS STRING) LIKE '%Program log: Instruction: Burn%'
        AND success = TRUE
    GROUP BY 1
)
, total_burn AS (SELECT *, 
    -(total_post_balance - total_pre_balance) as total_burn
FROM (
    SELECT pre_balances.d, total_pre_balance, total_post_balance
    FROM pre_balances
    LEFT JOIN post_balances ON pre_balances.d = post_balances.d
) as t ) 

SELECT 6e9 - sum(total_burn) as total_supply, 100*sum(total_burn)/6e9 as rate_burn, 
6e8 - sum(total_burn) as circulating_supply, 100*sum(total_burn)/6e8 as rate_burn_circulating
FROM total_burn"
810928,STEPN Shoe-Minting Costs by USD,,"WITH gst_usdc_orca_pool AS
  (SELECT block_date,
          post_token_balance.mint AS token_address,
          SUM(post_token_balance.amount) AS token_size,
          IF (post_token_balance.mint ='EPjFWdd5AufqSSqeM2qN1xzybapC8G4wEGGkZwyTDt1v', -- USDC contract
          SUM(post_token_balance.amount),
          1/SUM(post_token_balance.amount)) AS tmp
   FROM `solana`.`transactions` LATERAL VIEW EXPLODE(post_token_balances) t3 AS post_token_balance
   WHERE block_date = CURRENT_DATE - '1 day'::INTERVAL
     AND ARRAY_CONTAINS(account_keys, ""CwwMfXPXfRT5H5JUatpBctASRGhKW2SqLWWGU3eX5Zgo"") --usdc/gst pool
     AND ((post_token_balance.mint = ""AFbX8oGjGpmVFywbVouvhQSRmiW2aR1mohfahi4Y2AdB"" -- GST contract
           AND post_token_balance.account = ""9r39vqrJuubgafaJ5aQyDWYAUQVJeyZyveBXeRqp7xev"")
          OR (post_token_balance.mint = ""EPjFWdd5AufqSSqeM2qN1xzybapC8G4wEGGkZwyTDt1v"" -- USDC contract
              AND post_token_balance.account = ""7LFnr5YgUyEgPMCLGNQ9N7wM5MFRNqCuRawLZTe5q4c7"")) -- USDC mint
   GROUP BY block_date,
            post_token_balance.mint), 

gst_price AS
  (SELECT block_date,
          round(EXP(SUM(LOG(tmp))), 2) AS gst_price
   FROM gst_usdc_orca_pool
   GROUP BY block_date)

, gmt_usdc_orca_pool AS
  (SELECT block_date,
          post_token_balance.mint AS token_address,
          SUM(post_token_balance.amount) AS token_size,
          IF (post_token_balance.mint ='EPjFWdd5AufqSSqeM2qN1xzybapC8G4wEGGkZwyTDt1v', -- USDC contract
 SUM(post_token_balance.amount),
 1/SUM(post_token_balance.amount)) AS tmp
   FROM `solana`.`transactions` LATERAL VIEW EXPLODE(post_token_balances) t3 AS post_token_balance
   WHERE block_date = CURRENT_DATE - '1 day'::INTERVAL
     AND ARRAY_CONTAINS(account_keys, ""3HGGVGTXbqT49PG3L8JQYH4jCeP5CNBG6CpJniZ434an"") --usdc/gmt pool
     AND ((post_token_balance.mint = ""7i5KKsX2weiTkry7jA4ZwSuXGhs5eJBEjY8vVxR4pfRx"" -- GMT contract
     AND post_token_balance.account = ""BTpvbpTArnekGgbXRqjfSvp7gENtHXvZCAwuUKQNYMeN"")
        OR (post_token_balance.mint = ""EPjFWdd5AufqSSqeM2qN1xzybapC8G4wEGGkZwyTDt1v"" -- USDC mint 
     AND post_token_balance.account = ""DdBTJuiAXQQ7gLVXBXNPbVEG8g1avRxiJXhH5LhBytYW""))-- USDC contract

   GROUP BY block_date,
            post_token_balance.mint),
gmt_price AS
  (SELECT block_date,
          round(EXP(SUM(LOG(tmp))), 2) AS gmt_price
   FROM gmt_usdc_orca_pool
   GROUP BY block_date)
   
SELECT gst.block_date,
       gst_price, 
      CASE WHEN gst_price < 2 then 200*gst_price
          WHEN gst_price < 3 then 160*gst_price + 40*gmt_price
          WHEN gst_price < 4 THEN 120*gst_price + 80*gmt_price
          WHEN gst_price < 8 THEN 100*gst_price + 100*gmt_price
          WHEN gst_price < 10 THEN 80*gst_price + 120*gmt_price
          WHEN gst_price >= 10 THEN 40*gst_price + 160*gmt_price
          END AS minting_cost_USD
FROM gst_price gst
JOIN gmt_price gmt ON gst.block_date = gmt.block_date
"
602110,SOL Deposited Amount to STEPN,,"SELECT 
    block_date, 
    sum(case when account_keys[1] = ""STEPNq2UGeGSzCyGVr2nMQAzf8xuejwqebd84wcksCK"" and size(account_keys) = 3
             then (pre_balances[0] - post_balances[0])/power(10,9) else 0 end) as deposited_SOL
FROM solana.transactions
WHERE 
    block_date >= (CURRENT_DATE - '30 days'::INTERVAL)
    AND block_date < CURRENT_DATE
    AND (account_keys[1] = ""STEPNq2UGeGSzCyGVr2nMQAzf8xuejwqebd84wcksCK""
    OR account_keys[0] = ""STEPNq2UGeGSzCyGVr2nMQAzf8xuejwqebd84wcksCK"" )
    -- AND size(account_keys) = 3
    AND error is NULL
GROUP BY
    block_date
ORDER BY 
    block_date desc
"
621702,STEPN Daily Transactions (90 Days),,"SELECT 
    block_date, 
    COUNT(distinct account_keys[0]) as active_users,
    COUNT(signer) as transactions, 
    COUNT(signer)/COUNT(distinct account_keys[0]) as trans_per_users, 
    ROUND((COUNT(signer) - LAG(COUNT(signer)) OVER(ORDER BY block_date ASC)) / LAG(COUNT(signer)) OVER(ORDER BY block_date ASC) * 100,2) AS growth_transactions,
    ROUND((COUNT(distinct account_keys[0]) - LAG(COUNT(distinct account_keys[0])) OVER(ORDER BY block_date ASC)) / LAG(COUNT(distinct account_keys[0])) OVER(ORDER BY block_date ASC) * 100,2) AS growth_users
FROM solana.transactions
WHERE 
    block_date >= (CURRENT_DATE - '90 days'::INTERVAL)
    AND block_date < CURRENT_DATE
    AND ( ARRAY_CONTAINS(account_keys,""STEPNq2UGeGSzCyGVr2nMQAzf8xuejwqebd84wcksCK"") -- Address deposit SOL from Wallet to Spending
    OR ARRAY_CONTAINS(account_keys,""HLS5Y68QSQgJP7wUbbbbCjEnMknVZrHXYDwwVaDcsdK7"")  -- GST Address of STEPN 
    OR ARRAY_CONTAINS(account_keys,""7i5KKsX2weiTkry7jA4ZwSuXGhs5eJBEjY8vVxR4pfRx"") -- GMT 
    OR ARRAY_CONTAINS(account_keys,""AFbX8oGjGpmVFywbVouvhQSRmiW2aR1mohfahi4Y2AdB"") ) -- GST
    AND error is NULL
GROUP BY
    block_date
ORDER BY 
    block_date desc"
621826,STEPN Daily Transactions by Time of Day (GMT+0),,"SELECT 
    block_date, 
    case when extract(hour from block_time) <= 4 then '0AM-4AM' 
         when extract(hour from block_time) <= 8 then '5AM-8AM'
         when extract(hour from block_time) <= 12 then '9AM-12PM'
         when extract(hour from block_time) <= 16 then '1PM-4PM'
         when extract(hour from block_time) <= 20 then '5PM-8PM'
         when extract(hour from block_time) <= 24 then '9PM-12AM'
    end as hour_transaction, 
    count(signer) as transactions
FROM solana.transactions
WHERE 
    block_date >= (CURRENT_DATE - '30 days'::INTERVAL)
    AND block_date < CURRENT_DATE
    AND ( ARRAY_CONTAINS(account_keys,""STEPNq2UGeGSzCyGVr2nMQAzf8xuejwqebd84wcksCK"") -- Address deposit SOL from Wallet to Spending
    OR ARRAY_CONTAINS(account_keys,""HLS5Y68QSQgJP7wUbbbbCjEnMknVZrHXYDwwVaDcsdK7"") 
    OR ARRAY_CONTAINS(account_keys,""7i5KKsX2weiTkry7jA4ZwSuXGhs5eJBEjY8vVxR4pfRx"") 
    OR ARRAY_CONTAINS(account_keys,""AFbX8oGjGpmVFywbVouvhQSRmiW2aR1mohfahi4Y2AdB"") )
    AND error is NULL
GROUP BY 1, 2"
690820,(BNB Chain) STEPN Daily Shoes/Sneakers Minted,,"SELECT 
    date_trunc('day', evt_block_time) AS block_date,
    COUNT(*) AS shoe_minted
FROM
    erc721.""ERC721_evt_Transfer""
WHERE
    ""contract_address"" ='\x69D60ad11fEB699fE5fEEeB16AC691dF090bfd50' -- STEPNNFT (SNFT)
    AND
    ""from"" = '\x0000000000000000000000000000000000000000'
    AND 
    evt_block_time > '2022-04-01'  
GROUP BY block_date"
690871,(BNB Chain) GST Withdrawn Amount ,,"SELECT date_trunc('day', b.block_time) as day,
       count(b.`from`) AS transactions,
       count(DISTINCT b.`to`) AS withdraw_users, 
       sum(b.value)/1e18 as gst_withdraw, 
       (sum(b.value)/1e18)/count(DISTINCT b.`to`) as gst_per_user
FROM bnb.transactions b
LEFT JOIN bnb.logs l ON b.block_hash = l.block_hash
WHERE 1=1
  AND b.block_time >= (CURRENT_DATE - '30 days'::INTERVAL)
  AND b.block_time < CURRENT_DATE
  AND l.block_time >= (CURRENT_DATE - '30 days'::INTERVAL)
  AND l.block_time < CURRENT_DATE
  AND b.success = true
  AND b.`from` = '0x6238872a0bd9f0e19073695532a7ed77ce93c69e' -- STEPN HotWallet @BSC
--   AND l.contract_address = '0x4a2c860cec6471b9f5f5a336eb4f38bb21683c98' -- GMT Address
GROUP BY 1
"
544447,"STEPN Churn, Retention, Active & Re-Engagement Users in 30 Days",,"with monthly_usage as (
  select 
    signer as who_identifier, 
    cast((cast(block_date as date) - cast((CURRENT_DATE - '31 days'::INTERVAL) as date)) as integer) as time_period
  from `solana`.`transactions`
  where block_date >= (CURRENT_DATE - '31 days'::INTERVAL)
  and block_date < CURRENT_DATE
  and  ARRAY_CONTAINS(account_keys, ""HLS5Y68QSQgJP7wUbbbbCjEnMknVZrHXYDwwVaDcsdK7"") group by 1,2 order by 1,2),
 
lag_lead as (
  select who_identifier, time_period,
    lag(time_period,1) over (partition by who_identifier order by who_identifier, time_period) as lag,
    lead(time_period,1) over (partition by who_identifier order by who_identifier, time_period) as lead
  from monthly_usage),
 
lag_lead_with_diffs as (
  select who_identifier, time_period,  lag, lead, 
    time_period-lag lag_size, 
    lead-time_period lead_size 
  from lag_lead),
 
calculated as (select time_period,
  case when lag is null then 'NEW'
     when lag_size = 1 then 'ACTIVE'
     when lag_size > 1 then 'RETURN'
  end as this_month_value,
 
  case when (lead_size > 1 OR lead_size IS NULL) then 'CHURN'
     else NULL
  end as next_month_churn,
 
  count(distinct who_identifier) as count 
   from lag_lead_with_diffs
  group by 1,2,3)
 
select time_period, this_month_value, sum(count)  as count
  from calculated group by 1,2
union
select time_period+1, 'CHURN', count 
  from calculated where next_month_churn is not null
order by 1"
535866,GST Withdrawn/Deposited Amount (in USDC),,"WITH gst_from_treasury_table AS
  (SELECT block_date,
          case when (pre_token_balance.amount - post_token_balance.amount) > 0 
               then (pre_token_balance.amount - post_token_balance.amount) else 0 end as gst_from_treasury, 
          case when (pre_token_balance.amount - post_token_balance.amount) < 0 
               then -1*(pre_token_balance.amount - post_token_balance.amount) else 0 end as gst_to_treasury

   FROM `solana`.`transactions` LATERAL VIEW EXPLODE(account_keys) t1 AS account LATERAL VIEW EXPLODE(pre_token_balances) t2 AS pre_token_balance LATERAL VIEW EXPLODE(post_token_balances) t3 AS post_token_balance
   WHERE block_date >= (CURRENT_DATE - '30 days'::INTERVAL)
     AND block_date < CURRENT_DATE
     AND ARRAY_CONTAINS(account_keys, ""HLS5Y68QSQgJP7wUbbbbCjEnMknVZrHXYDwwVaDcsdK7"")
     AND account = ""HLS5Y68QSQgJP7wUbbbbCjEnMknVZrHXYDwwVaDcsdK7""
     AND pre_token_balance.account = account
     AND post_token_balance.account = account
     AND error IS NULL
     AND pre_token_balance.mint = ""AFbX8oGjGpmVFywbVouvhQSRmiW2aR1mohfahi4Y2AdB""
     AND post_token_balance.mint = ""AFbX8oGjGpmVFywbVouvhQSRmiW2aR1mohfahi4Y2AdB""
    --  AND (pre_token_balance.amount - post_token_balance.amount) > 0 -- 100-99 -> output 1
 ),
     gst_usdc_orca_pool AS
  (SELECT block_date,
          post_token_balance.mint AS token_address,
          SUM(post_token_balance.amount) AS token_size,
          IF (post_token_balance.mint ='EPjFWdd5AufqSSqeM2qN1xzybapC8G4wEGGkZwyTDt1v',
              SUM(post_token_balance.amount),
              1/SUM(post_token_balance.amount)) AS tmp
   FROM `solana`.`transactions` LATERAL VIEW EXPLODE(post_token_balances) t3 AS post_token_balance
   WHERE block_date >= (CURRENT_DATE - '30 days'::INTERVAL)
     AND block_date < CURRENT_DATE
     AND ARRAY_CONTAINS(account_keys, ""CwwMfXPXfRT5H5JUatpBctASRGhKW2SqLWWGU3eX5Zgo"") --usdc/gst pool

     AND ((post_token_balance.mint = ""AFbX8oGjGpmVFywbVouvhQSRmiW2aR1mohfahi4Y2AdB""
           AND post_token_balance.account = ""9r39vqrJuubgafaJ5aQyDWYAUQVJeyZyveBXeRqp7xev"")
          OR (post_token_balance.mint = ""EPjFWdd5AufqSSqeM2qN1xzybapC8G4wEGGkZwyTDt1v""
              AND post_token_balance.account = ""7LFnr5YgUyEgPMCLGNQ9N7wM5MFRNqCuRawLZTe5q4c7""))
   GROUP BY block_date,
            post_token_balance.mint),
     gst_price_per_day AS
  (SELECT block_date,
          EXP(SUM(LOG(tmp))) AS gst_price
   FROM gst_usdc_orca_pool
   GROUP BY block_date),
     daily_release_gst_from_treasury AS
  (SELECT block_date,
          SUM(gst_from_treasury) AS gst_from_treasury, 
          SUM(gst_to_treasury) AS get_to_treasury
   FROM gst_from_treasury_table
   GROUP BY 1),
     cost AS
  (SELECT block_date,
        --   gst_release_amount,
          gst_price,
          gst_from_treasury*gst_price AS withdrawn_GST, 
          get_to_treasury*gst_price AS deposited_GST
   FROM daily_release_gst_from_treasury
   JOIN gst_price_per_day USING (block_date))
SELECT block_date,
       withdrawn_GST, 
       deposited_GST
FROM cost
ORDER BY block_date DESC"
630695, STEPN Monthly Shoes/Sneakers Minted,,"SELECT
    date_trunc('month',block_date) as month,
    COUNT(distinct post_token_balance['mint']) as shoes
FROM
    solana.transactions
    LATERAL VIEW explode(post_token_balances) AS post_token_balance
WHERE 1=1
    AND block_date >= '2022-01-01'
    AND block_date < CURRENT_DATE
    AND signer = 'STEPNq2UGeGSzCyGVr2nMQAzf8xuejwqebd84wcksCK'
    AND array_contains(log_messages, 'Program TokenkegQfeZyiNwAJbNbGKPFXCWuBvf9Ss623VQ5DA invoke [1]')
    AND array_contains(log_messages, 'Program log: Instruction: InitializeMint')
    AND success is true
    AND error is NULL
GROUP BY  1 "
536190,SOL Withdrawn/Deposited Amount from STEPN,,"SELECT 
    block_date, 
    sum(case when account_keys[1] = ""STEPNq2UGeGSzCyGVr2nMQAzf8xuejwqebd84wcksCK"" and size(account_keys) = 3
             then (pre_balances[0] - post_balances[0])/power(10,9) else 0 end) as deposited_SOL, 
    sum(case when account_keys[0] = ""STEPNq2UGeGSzCyGVr2nMQAzf8xuejwqebd84wcksCK"" 
             then (pre_balances[0] - post_balances[0])/power(10,9) else 0 end) as withdrawn_SOL
FROM solana.transactions
WHERE 
    block_date >= (CURRENT_DATE - '30 days'::INTERVAL)
    AND block_date < CURRENT_DATE
    AND (account_keys[1] = ""STEPNq2UGeGSzCyGVr2nMQAzf8xuejwqebd84wcksCK""
    OR account_keys[0] = ""STEPNq2UGeGSzCyGVr2nMQAzf8xuejwqebd84wcksCK"" )
    -- AND size(account_keys) = 3
    AND error is NULL
GROUP BY
    block_date
ORDER BY 
    block_date desc
"
544059,STEPN Active Deposit Users Growth Rate Today,,"SELECT
((SELECT 
    COUNT(distinct account_keys[0]) as active_deposit_users
FROM `solana`.`transactions`
WHERE 
    block_date = (CURRENT_DATE - '1 days'::INTERVAL)
    AND block_date <= CURRENT_DATE
    AND account_keys[1] = ""STEPNq2UGeGSzCyGVr2nMQAzf8xuejwqebd84wcksCK"" -- Address deposit SOL from Wallet to Spending
    AND size(account_keys) = 3
    AND error is NULL
GROUP BY
    block_date) *100/ 
(SELECT 
    COUNT(distinct account_keys[0]) as active_deposit_users
FROM `solana`.`transactions`
WHERE 
    block_date = (CURRENT_DATE - '2 days'::INTERVAL)
    AND block_date <= CURRENT_DATE
    AND account_keys[1] = ""STEPNq2UGeGSzCyGVr2nMQAzf8xuejwqebd84wcksCK"" -- Address deposit SOL from Wallet to Spending
    AND size(account_keys) = 3
    AND error is NULL
GROUP BY
    block_date)) - 100
    "
898203,DAU Daily Active Users - STEPN vs non-STEPN users on BNB Chain,,"WITH
  A AS (
    SELECT
      date_trunc('day', block_time) AS day,
      `from` AS address
    FROM
      bnb.transactions
    WHERE
      1 = 1
      AND block_time >= now() - interval '60 days'
      AND block_time <= now()
  ),
  B AS (
    SELECT
      date_trunc('day', block_time) AS day,
      `to` AS address
    FROM
      bnb.transactions
    WHERE
      1 = 1
      AND block_time >= now() - interval '60 days'
      AND block_time <= now()
  ),
  C AS (
    SELECT
      *
    FROM
      A
    UNION ALL
    SELECT
      *
    FROM
      B
  ),
  D AS (
    SELECT
      day,
      COUNT(DISTINCT address) as address
    FROM
      C
    GROUP BY
      1
  ),
  E (
    SELECT
      date_trunc('day', block_time) AS day,
      COUNT(
        DISTINCT(
          CASE
            WHEN `to` = '0x6238872a0bd9f0e19073695532a7ed77ce93c69e' THEN `from`
            ELSE `to`
          END
        )
      ) AS address
    FROM
      `bnb`.`transactions`
    WHERE
      block_time >= now() - interval '60 days'
      AND block_time <= now()
      AND (
        `from` = '0x6238872a0bd9f0e19073695532a7ed77ce93c69e'
        OR `to` = '0x6238872a0bd9f0e19073695532a7ed77ce93c69e'
      ) -- StepN Wallet
      AND `from` != '0x0000000000000000000000000000000000000000'
      AND `from` != '0x0000000000000000000000000000000000000000' -- remove mint
      AND `to` != '0x000000000000000000000000000000000000dEaD' -- remove burn
      AND `to` != '0x0000000000000000000000000000000000000000' -- remove burn
      AND `from` != '0xfcfc7130e8af8c016823fa06d00d7c512c61ac7f' -- remove offical add liquid wallet
      AND `to` != '0xfcfc7130e8af8c016823fa06d00d7c512c61ac7f' -- remove offical add liquid wallet
      AND success
    group by
      1
  )
SELECT
  d.day, e.address as STEPN, d.address - e.address as NON_STEPN
FROM d 
JOIN e ON d.day = e.day "
673471,GMT Total Token Supply,,"WITH pre_balances AS (
    SELECT date_trunc('day', block_time) AS d, 
    SUM(pre_token_balance.amount) as total_pre_balance
    FROM solana.transactions
    LATERAL VIEW explode(pre_token_balances) t1 AS pre_token_balance
    WHERE block_time >= '2022-04-01'
        AND array_contains(account_keys, '7i5KKsX2weiTkry7jA4ZwSuXGhs5eJBEjY8vVxR4pfRx') -- gmt contract
        AND CAST(log_messages AS STRING) LIKE '%Program log: Instruction: Burn%'
        AND success = TRUE
    GROUP BY 1
),
post_balances AS (
    SELECT date_trunc('day', block_time) AS d, 
    SUM(post_token_balance.amount) as total_post_balance
    FROM solana.transactions
    LATERAL VIEW explode(post_token_balances) t2 AS post_token_balance
    WHERE 
        block_time >= '2022-04-01'
        AND array_contains(account_keys, '7i5KKsX2weiTkry7jA4ZwSuXGhs5eJBEjY8vVxR4pfRx')
        AND CAST(log_messages AS STRING) LIKE '%Program log: Instruction: Burn%'
        AND success = TRUE
    GROUP BY 1
)
, total_burn AS (SELECT *, 
    -(total_post_balance - total_pre_balance) as total_burn
FROM (
    SELECT pre_balances.d, total_pre_balance, total_post_balance
    FROM pre_balances
    LEFT JOIN post_balances ON pre_balances.d = post_balances.d
) as t ) 

SELECT 6e9 - sum(total_burn) as total_supply, 100*sum(total_burn)/6e9 as rate_burn, 
6e8 - sum(total_burn) as circulating_supply, 100*sum(total_burn)/6e8 as rate_burn_circulating
FROM total_burn"
690189,STEPN Shoe-Minting Costs ,,"WITH gst_usdc_orca_pool AS
  (SELECT block_date,
          post_token_balance.mint AS token_address,
          SUM(post_token_balance.amount) AS token_size,
          IF (post_token_balance.mint ='EPjFWdd5AufqSSqeM2qN1xzybapC8G4wEGGkZwyTDt1v', -- USDC contract
          SUM(post_token_balance.amount),
          1/SUM(post_token_balance.amount)) AS tmp
   FROM `solana`.`transactions` LATERAL VIEW EXPLODE(post_token_balances) t3 AS post_token_balance
   WHERE block_date = CURRENT_DATE - '1 day'::INTERVAL
     AND ARRAY_CONTAINS(account_keys, ""CwwMfXPXfRT5H5JUatpBctASRGhKW2SqLWWGU3eX5Zgo"") --usdc/gst pool
     AND ((post_token_balance.mint = ""AFbX8oGjGpmVFywbVouvhQSRmiW2aR1mohfahi4Y2AdB"" -- GST contract
           AND post_token_balance.account = ""9r39vqrJuubgafaJ5aQyDWYAUQVJeyZyveBXeRqp7xev"")
          OR (post_token_balance.mint = ""EPjFWdd5AufqSSqeM2qN1xzybapC8G4wEGGkZwyTDt1v"" -- USDC contract
              AND post_token_balance.account = ""7LFnr5YgUyEgPMCLGNQ9N7wM5MFRNqCuRawLZTe5q4c7"")) -- USDC mint
   GROUP BY block_date,
            post_token_balance.mint)
SELECT block_date,
       round(EXP(SUM(LOG(tmp))), 2) AS gst_price, 
      CASE WHEN round(EXP(SUM(LOG(tmp))), 2) < 2 then '200 GST'
          WHEN round(EXP(SUM(LOG(tmp))), 2) < 3 then '160 GST & 40 GMT'
          WHEN round(EXP(SUM(LOG(tmp))), 2) < 4 THEN '120 GST & 80 GMT'
          WHEN round(EXP(SUM(LOG(tmp))), 2) < 8 THEN '100 GST & 100 GMT'
          WHEN round(EXP(SUM(LOG(tmp))), 2) < 10 THEN '80 GST & 120 GMT'
          WHEN round(EXP(SUM(LOG(tmp))), 2) >= 10 THEN '40 GST & 160 GMT'
          END AS minting_cost
FROM gst_usdc_orca_pool
GROUP BY block_date"
811095,STEPN Shoe-Minting Costs by USD,,"WITH gst_usdc_orca_pool AS
  (SELECT block_date,
          post_token_balance.mint AS token_address,
          SUM(post_token_balance.amount) AS token_size,
          IF (post_token_balance.mint ='EPjFWdd5AufqSSqeM2qN1xzybapC8G4wEGGkZwyTDt1v', -- USDC contract
          SUM(post_token_balance.amount),
          1/SUM(post_token_balance.amount)) AS tmp
   FROM `solana`.`transactions` LATERAL VIEW EXPLODE(post_token_balances) t3 AS post_token_balance
   WHERE block_date >= (CURRENT_DATE - '30 days'::INTERVAL)
     AND ARRAY_CONTAINS(account_keys, ""CwwMfXPXfRT5H5JUatpBctASRGhKW2SqLWWGU3eX5Zgo"") --usdc/gst pool
     AND ((post_token_balance.mint = ""AFbX8oGjGpmVFywbVouvhQSRmiW2aR1mohfahi4Y2AdB"" -- GST contract
           AND post_token_balance.account = ""9r39vqrJuubgafaJ5aQyDWYAUQVJeyZyveBXeRqp7xev"")
          OR (post_token_balance.mint = ""EPjFWdd5AufqSSqeM2qN1xzybapC8G4wEGGkZwyTDt1v"" -- USDC contract
              AND post_token_balance.account = ""7LFnr5YgUyEgPMCLGNQ9N7wM5MFRNqCuRawLZTe5q4c7"")) -- USDC mint
   GROUP BY block_date,
            post_token_balance.mint), 

gst_price AS
  (SELECT block_date,
          round(EXP(SUM(LOG(tmp))), 2) AS gst_price
   FROM gst_usdc_orca_pool
   GROUP BY block_date)

, gmt_usdc_orca_pool AS
  (SELECT block_date,
          post_token_balance.mint AS token_address,
          SUM(post_token_balance.amount) AS token_size,
          IF (post_token_balance.mint ='EPjFWdd5AufqSSqeM2qN1xzybapC8G4wEGGkZwyTDt1v', -- USDC contract
 SUM(post_token_balance.amount),
 1/SUM(post_token_balance.amount)) AS tmp
   FROM `solana`.`transactions` LATERAL VIEW EXPLODE(post_token_balances) t3 AS post_token_balance
   WHERE block_date >= (CURRENT_DATE - '30 days'::INTERVAL)
     AND ARRAY_CONTAINS(account_keys, ""3HGGVGTXbqT49PG3L8JQYH4jCeP5CNBG6CpJniZ434an"") --usdc/gmt pool
     AND ((post_token_balance.mint = ""7i5KKsX2weiTkry7jA4ZwSuXGhs5eJBEjY8vVxR4pfRx"" -- GMT contract
     AND post_token_balance.account = ""BTpvbpTArnekGgbXRqjfSvp7gENtHXvZCAwuUKQNYMeN"")
        OR (post_token_balance.mint = ""EPjFWdd5AufqSSqeM2qN1xzybapC8G4wEGGkZwyTDt1v"" -- USDC mint 
     AND post_token_balance.account = ""DdBTJuiAXQQ7gLVXBXNPbVEG8g1avRxiJXhH5LhBytYW""))-- USDC contract

   GROUP BY block_date,
            post_token_balance.mint),
gmt_price AS
  (SELECT block_date,
          round(EXP(SUM(LOG(tmp))), 2) AS gmt_price
   FROM gmt_usdc_orca_pool
   GROUP BY block_date)
   
SELECT gst.block_date,
       gst_price, 
      CASE WHEN gst_price < 2 then 200*gst_price
          WHEN gst_price < 3 then 160*gst_price + 40*gmt_price
          WHEN gst_price < 4 THEN 120*gst_price + 80*gmt_price
          WHEN gst_price < 8 THEN 100*gst_price + 100*gmt_price
          WHEN gst_price < 10 THEN 80*gst_price + 120*gmt_price
          WHEN gst_price >= 10 THEN 40*gst_price + 160*gmt_price
          END AS minting_cost_USD
FROM gst_price gst
JOIN gmt_price gmt ON gst.block_date = gmt.block_date
"
655824,STEPN Sneakers' Floor Price (SOL) on Magic Eden,,"SELECT
    day,
    PERCENTILE_CONT(0.10) WITHIN GROUP (ORDER BY price) AS `Floor Price`,
    PERCENTILE_CONT(0.50) WITHIN GROUP (ORDER BY price) AS `Average Price`, 
    PERCENTILE_CONT(0.90) WITHIN GROUP (ORDER BY price) AS `Max Price`
FROM (
    SELECT
        DATE_TRUNC('day', block_time) AS day,
        ABS(post_balances[0] / 1e9 - pre_balances[0] / 1e9) AS price
    FROM `solana`.`transactions`
    WHERE 1=1
    AND block_date >= (CURRENT_DATE - '30 days'::INTERVAL)
    AND array_contains(account_keys, ""STEPNq2UGeGSzCyGVr2nMQAzf8xuejwqebd84wcksCK"")
    AND (
        account_keys[size(account_keys)-1] = 'M2mx93ekt1fmXSVkTrUL9xVFHkmME8HTUi5Cyc5aF7K' --ME V2
        OR account_keys[size(account_keys)-1] = 'MEisE1HzehtrDpAAT8PnLHjpSSkRYakotTuJRPjTpo8' --ME V1 
    )
    AND ABS(post_balances[0] / 1e9 - pre_balances[0] / 1e9) > 0.1
)
GROUP BY 1"
540046,Average Withdrawn/Deposited SOL per Active User in STEPN,,"WITH sol_users AS (
SELECT 
    date_trunc('day',block_date) as block_date, 
    sum(case when account_keys[1] = ""STEPNq2UGeGSzCyGVr2nMQAzf8xuejwqebd84wcksCK"" and size(account_keys) = 3
             then (pre_balances[0] - post_balances[0])/power(10,9) else 0 end) as deposited_SOL, 
    sum(case when account_keys[0] = ""STEPNq2UGeGSzCyGVr2nMQAzf8xuejwqebd84wcksCK"" 
             then (pre_balances[0] - post_balances[0])/power(10,9) else 0 end) as withdrawn_SOL,
    count(distinct case when account_keys[1] = ""STEPNq2UGeGSzCyGVr2nMQAzf8xuejwqebd84wcksCK"" and size(account_keys) = 3
                then (account_keys[0]) else null end)  as active_deposit_users
FROM solana.transactions
WHERE 
    block_date >= (CURRENT_DATE - '30 days'::INTERVAL)
    AND block_date <= CURRENT_DATE
    AND (account_keys[1] = ""STEPNq2UGeGSzCyGVr2nMQAzf8xuejwqebd84wcksCK""
    OR account_keys[0] = ""STEPNq2UGeGSzCyGVr2nMQAzf8xuejwqebd84wcksCK"" )
    AND error is NULL
GROUP BY
    block_date

 )

SELECT 
 block_date, round(deposited_SOL/active_deposit_users, 2) as avg_deposited_SOL, round(withdrawn_SOL/active_deposit_users, 2) as avg_withdrawn_SOL
FROM
 sol_users"
640309,GMT Total Token Burn,,"WITH pre_balances AS (
    SELECT date_trunc('day', block_time) AS d, 
    SUM(pre_token_balance.amount) as total_pre_balance
    FROM solana.transactions
    LATERAL VIEW explode(pre_token_balances) t1 AS pre_token_balance
    WHERE block_time >= '2022-04-01'
        AND array_contains(account_keys, '7i5KKsX2weiTkry7jA4ZwSuXGhs5eJBEjY8vVxR4pfRx') -- gmt contract
        AND CAST(log_messages AS STRING) LIKE '%Program log: Instruction: Burn%'
        AND success = TRUE
    GROUP BY 1
),
post_balances AS (
    SELECT date_trunc('day', block_time) AS d, 
    SUM(post_token_balance.amount) as total_post_balance
    FROM solana.transactions
    LATERAL VIEW explode(post_token_balances) t2 AS post_token_balance
    WHERE 
        block_time >= '2022-04-01'
        AND array_contains(account_keys, '7i5KKsX2weiTkry7jA4ZwSuXGhs5eJBEjY8vVxR4pfRx')
        AND CAST(log_messages AS STRING) LIKE '%Program log: Instruction: Burn%'
        AND success = TRUE
    GROUP BY 1
)
, total_burn AS (SELECT *, 
    -(total_post_balance - total_pre_balance) as total_burn
FROM (
    SELECT pre_balances.d, total_pre_balance, total_post_balance
    FROM pre_balances
    LEFT JOIN post_balances ON pre_balances.d = post_balances.d
) as t ) 

SELECT sum(total_burn) as total_burn
FROM total_burn"
658804,GMT & GST Price (in 30 Days),,"WITH gmt_usdc_orca_pool AS
  (SELECT block_date,
          post_token_balance.mint AS token_address,
          SUM(post_token_balance.amount) AS token_size,
          IF (post_token_balance.mint ='EPjFWdd5AufqSSqeM2qN1xzybapC8G4wEGGkZwyTDt1v', -- USDC contract
 SUM(post_token_balance.amount),
 1/SUM(post_token_balance.amount)) AS tmp
   FROM `solana`.`transactions` LATERAL VIEW EXPLODE(post_token_balances) t3 AS post_token_balance
   WHERE block_date >= (CURRENT_DATE - '30 days'::INTERVAL)
     AND ARRAY_CONTAINS(account_keys, ""3HGGVGTXbqT49PG3L8JQYH4jCeP5CNBG6CpJniZ434an"") --usdc/gmt pool
     AND ((post_token_balance.mint = ""7i5KKsX2weiTkry7jA4ZwSuXGhs5eJBEjY8vVxR4pfRx"" -- GMT contract
     AND post_token_balance.account = ""BTpvbpTArnekGgbXRqjfSvp7gENtHXvZCAwuUKQNYMeN"")
        OR (post_token_balance.mint = ""EPjFWdd5AufqSSqeM2qN1xzybapC8G4wEGGkZwyTDt1v"" -- USDC mint 
     AND post_token_balance.account = ""DdBTJuiAXQQ7gLVXBXNPbVEG8g1avRxiJXhH5LhBytYW""))-- USDC contract

   GROUP BY block_date,
            post_token_balance.mint),
     gmt_price AS
  (SELECT block_date,
          round(EXP(SUM(LOG(tmp))), 2) AS gmt_price
   FROM gmt_usdc_orca_pool
   GROUP BY block_date) ,
     gst_usdc_orca_pool AS
  (SELECT block_date,
          post_token_balance.mint AS token_address,
          SUM(post_token_balance.amount) AS token_size,
          IF (post_token_balance.mint ='EPjFWdd5AufqSSqeM2qN1xzybapC8G4wEGGkZwyTDt1v', -- USDC contract
 SUM(post_token_balance.amount),
 1/SUM(post_token_balance.amount)) AS tmp
   FROM `solana`.`transactions` LATERAL VIEW EXPLODE(post_token_balances) t3 AS post_token_balance
   WHERE block_date >= (CURRENT_DATE - '30 days'::INTERVAL)
     AND ARRAY_CONTAINS(account_keys, ""CwwMfXPXfRT5H5JUatpBctASRGhKW2SqLWWGU3eX5Zgo"") --usdc/gst pool
     AND ((post_token_balance.mint = ""AFbX8oGjGpmVFywbVouvhQSRmiW2aR1mohfahi4Y2AdB"" -- GST contract
     AND post_token_balance.account = ""9r39vqrJuubgafaJ5aQyDWYAUQVJeyZyveBXeRqp7xev"")
          OR (post_token_balance.mint = ""EPjFWdd5AufqSSqeM2qN1xzybapC8G4wEGGkZwyTDt1v"" -- USDC contract
     AND post_token_balance.account = ""7LFnr5YgUyEgPMCLGNQ9N7wM5MFRNqCuRawLZTe5q4c7""))-- USDC mint

   GROUP BY block_date,
            post_token_balance.mint),
     gst_price AS
  (SELECT block_date,
          round(EXP(SUM(LOG(tmp))), 2) AS gst_price
   FROM gst_usdc_orca_pool
   GROUP BY block_date)
SELECT m.block_date,
       gmt_price,
       gst_price
FROM gst_price s
JOIN gmt_price m ON s.block_date = m.block_date"
898203,DAU Daily Active Users - STEPN vs non-STEPN users on BNB Chain,,"WITH
  A AS (
    SELECT
      date_trunc('day', block_time) AS day,
      `from` AS address
    FROM
      bnb.transactions
    WHERE
      1 = 1
      AND block_time >= now() - interval '60 days'
      AND block_time <= now()
  ),
  B AS (
    SELECT
      date_trunc('day', block_time) AS day,
      `to` AS address
    FROM
      bnb.transactions
    WHERE
      1 = 1
      AND block_time >= now() - interval '60 days'
      AND block_time <= now()
  ),
  C AS (
    SELECT
      *
    FROM
      A
    UNION ALL
    SELECT
      *
    FROM
      B
  ),
  D AS (
    SELECT
      day,
      COUNT(DISTINCT address) as address
    FROM
      C
    GROUP BY
      1
  ),
  E (
    SELECT
      date_trunc('day', block_time) AS day,
      COUNT(
        DISTINCT(
          CASE
            WHEN `to` = '0x6238872a0bd9f0e19073695532a7ed77ce93c69e' THEN `from`
            ELSE `to`
          END
        )
      ) AS address
    FROM
      `bnb`.`transactions`
    WHERE
      block_time >= now() - interval '60 days'
      AND block_time <= now()
      AND (
        `from` = '0x6238872a0bd9f0e19073695532a7ed77ce93c69e'
        OR `to` = '0x6238872a0bd9f0e19073695532a7ed77ce93c69e'
      ) -- StepN Wallet
      AND `from` != '0x0000000000000000000000000000000000000000'
      AND `from` != '0x0000000000000000000000000000000000000000' -- remove mint
      AND `to` != '0x000000000000000000000000000000000000dEaD' -- remove burn
      AND `to` != '0x0000000000000000000000000000000000000000' -- remove burn
      AND `from` != '0xfcfc7130e8af8c016823fa06d00d7c512c61ac7f' -- remove offical add liquid wallet
      AND `to` != '0xfcfc7130e8af8c016823fa06d00d7c512c61ac7f' -- remove offical add liquid wallet
      AND success
    group by
      1
  )
SELECT
  d.day, e.address as STEPN, d.address - e.address as NON_STEPN
FROM d 
JOIN e ON d.day = e.day "
830534,DAU Daily Active Users - STEPN vs non-STEPN users on Solana,,"SELECT
    date_trunc('day',block_date) as day,
    case when (ARRAY_CONTAINS(account_keys,""STEPNq2UGeGSzCyGVr2nMQAzf8xuejwqebd84wcksCK"") -- Address deposit SOL from Wallet to Spending
    OR ARRAY_CONTAINS(account_keys,""HLS5Y68QSQgJP7wUbbbbCjEnMknVZrHXYDwwVaDcsdK7"")  -- GST Address of STEPN 
    OR ARRAY_CONTAINS(account_keys,""7i5KKsX2weiTkry7jA4ZwSuXGhs5eJBEjY8vVxR4pfRx"") -- GMT 
    OR ARRAY_CONTAINS(account_keys,""AFbX8oGjGpmVFywbVouvhQSRmiW2aR1mohfahi4Y2AdB"") ) -- GST 
    then 'STEPN' else 'NON_STEPN' end as user_type,
    COUNT(DISTINCT signer) as active_users, 
    COUNT(signer) as transactions
FROM
    solana.transactions
WHERE 1=1
        AND block_date >= '2022-01-01'
        AND block_date < CURRENT_DATE
        AND success = 'true'
GROUP BY  1,2 
"
509947,STEPN_accumulated_deposited_unique_user,,"WITH firstseen AS (
  SELECT account_keys[0] as account_id, MIN(block_date) as block_date
  FROM solana.transactions
  WHERE 
    block_date >= (CURRENT_DATE - '90 days'::INTERVAL)
    -- size(account_keys) = 3
    AND account_keys[1] = ""STEPNq2UGeGSzCyGVr2nMQAzf8xuejwqebd84wcksCK""
    AND error is NULL
  GROUP BY 1
)
SELECT DISTINCT block_date, COUNT(account_id) OVER (ORDER BY block_date) total_unique_deposited_accounts 
FROM firstseen
ORDER BY 1
"
510071,STEPN_deposited_new_user_increment,,"WITH firstseen AS (
  SELECT account_keys[0] as account_id, MIN(block_date) as block_date
  FROM solana.transactions
  WHERE 
    block_date >= (CURRENT_DATE - '80 days'::INTERVAL)
    -- size(account_keys) = 3
    AND account_keys[1] = ""STEPNq2UGeGSzCyGVr2nMQAzf8xuejwqebd84wcksCK""
    AND error is NULL
  GROUP BY 1
)
SELECT DISTINCT block_date, COUNT(account_id) OVER (PARTITION BY block_date ORDER BY block_date) daily_new_deposited_accounts 
FROM firstseen
ORDER BY 1
"
511601,STEPN_daily_deposit_unique_user,,"SELECT 
    block_date, 
    COUNT(distinct account_keys[0]) as unique_deposit_accounts
FROM solana.transactions
WHERE 
    block_date >= (CURRENT_DATE - '90 days'::INTERVAL)
    AND account_keys[1] = ""STEPNq2UGeGSzCyGVr2nMQAzf8xuejwqebd84wcksCK""
    AND size(account_keys) = 3
    AND error is NULL
    -- AND ARRAY_CONTAINS(account_keys, ""STEPNq2UGeGSzCyGVr2nMQAzf8xuejwqebd84wcksCK"")
GROUP BY
    block_date
ORDER BY 
    block_date desc


-- select * 
-- from solana.transactions
-- where 
-- block_date >= (CURRENT_DATE - '1 days'::INTERVAL)
-- AND ARRAY_CONTAINS(account_keys, ""36U6HnMCGtR5ViKZbeA27HDRzc7oNCftcW4GtTfVvA8Y"")
-- limit 10
-- SELECT
--     block_date,
--     account_keys,
--     instructions,
--     instruction
-- FROM solana.transactions
-- LATERAL VIEW explode(instructions) instructions AS instruction
-- WHERE
--     block_date >= (CURRENT_DATE - '1 days'::INTERVAL)
--     AND block_date < CURRENT_DATE
--     AND NOT ARRAY_CONTAINS(account_keys, ""Vote111111111111111111111111111111111111111"")
--     and account_keys[instruction['program_id_index']] = 'TokenkegQfeZyiNwAJbNbGKPFXCWuBvf9Ss623VQ5DA'
-- limit 10
-- SELECT
--     block_date
--     , SUM(CASE
--             WHEN account_keys[instruction['program_id_index']] = 'TokenkegQfeZyiNwAJbNbGKPFXCWuBvf9Ss623VQ5DA' THEN 1
--             ELSE 0
--         END) AS STEPN
-- FROM solana.transactions
-- LATERAL VIEW explode(instructions) instructions AS instruction
-- WHERE
--     block_date >= (CURRENT_DATE - '1 days'::INTERVAL)
--     AND block_date < CURRENT_DATE
--     AND NOT ARRAY_CONTAINS(account_keys, ""Vote111111111111111111111111111111111111111"")
--     and account_keys[instruction['program_id_index']] = 'TokenkegQfeZyiNwAJbNbGKPFXCWuBvf9Ss623VQ5DA'
-- GROUP BY 1
-- ORDER BY 1 DESC

-- SELECT
--     block_date
--     , SUM(CASE
--             WHEN account_keys[instruction['program_id_index']] = 'TokenkegQfeZyiNwAJbNbGKPFXCWuBvf9Ss623VQ5DA' THEN 1
--             ELSE 0
--         END) AS STEPN
-- FROM solana.transactions
-- LATERAL VIEW explode(instructions) instructions AS instruction
-- WHERE
--     block_date >= (CURRENT_DATE - '90 days'::INTERVAL)
--     AND block_date < CURRENT_DATE
--     AND NOT ARRAY_CONTAINS(account_keys, ""Vote111111111111111111111111111111111111111"")
--     and account_keys[instruction['program_id_index']] = 'TokenkegQfeZyiNwAJbNbGKPFXCWuBvf9Ss623VQ5DA'
-- GROUP BY 1
-- ORDER BY 1 DESC"
594165,STEPN Spending address withdraw & deposit,,"WITH
deposit_table as (
    SELECT 
        block_date, 
        sum(pre_balances[0] - post_balances[0])/power(10,9) as deposit_sol
    FROM solana.transactions
    WHERE 
        block_date >= (CURRENT_DATE - '14 days'::INTERVAL)
        AND account_keys[1] = ""STEPNq2UGeGSzCyGVr2nMQAzf8xuejwqebd84wcksCK""
        AND size(account_keys) = 3
        AND error is NULL
    GROUP BY
        block_date
    ORDER BY 
        block_date desc
), 
large_deposit_table as (
    SELECT 
        block_date, 
        sum(pre_balances[0] - post_balances[0])/power(10,9) as large_deposit_sol
    FROM solana.transactions
    WHERE 
        block_date >= (CURRENT_DATE - '14 days'::INTERVAL)
        AND account_keys[1] = ""STEPNq2UGeGSzCyGVr2nMQAzf8xuejwqebd84wcksCK""
        AND size(account_keys) = 3
        AND ((pre_balances[0] - post_balances[0])/power(10,9)) > 500
        AND error is NULL
    GROUP BY
        block_date
    ORDER BY 
        block_date desc
), 
withdraw_table as (
SELECT 
    block_date, 
    sum(pre_balances[0] - post_balances[0])/power(10,9) as withdraw_sol
FROM solana.transactions
WHERE 
    block_date >= (CURRENT_DATE - '14 days'::INTERVAL)
    -- AND size(account_keys) = 3 
    AND account_keys[0] = ""STEPNq2UGeGSzCyGVr2nMQAzf8xuejwqebd84wcksCK""
    AND error is NULL
GROUP BY
    block_date
ORDER BY 
    block_date desc
),

large_withdraw_table as (
SELECT 
    block_date, 
    sum(pre_balances[0] - post_balances[0])/power(10,9) as large_withdraw_sol
FROM solana.transactions
WHERE 
    block_date >= (CURRENT_DATE - '14 days'::INTERVAL)
    -- AND size(account_keys) = 3 
    AND account_keys[0] = ""STEPNq2UGeGSzCyGVr2nMQAzf8xuejwqebd84wcksCK""
    AND ((pre_balances[0] - post_balances[0])/power(10,9)) > 500
    AND error is NULL
GROUP BY
    block_date
ORDER BY 
    block_date desc
),

tmp_table_1 as (
    SELECT deposit_table.block_date as block_date,
            deposit_table.deposit_sol as deposit_sol,
            withdraw_table.withdraw_sol as withdraw_sol
    FROM deposit_table, withdraw_table
    WHERE deposit_table.block_date = withdraw_table.block_date
    order by block_date desc
),

tmp_table_2 as (
    SELECT 
        tmp_table_1.block_date as block_date,
        tmp_table_1.deposit_sol as deposit_sol,
        tmp_table_1.withdraw_sol as withdraw_sol,
        large_deposit_table.large_deposit_sol as large_deposit_sol
    from tmp_table_1 
    LEFT JOIN large_deposit_table
    ON tmp_table_1.block_date = large_deposit_table.block_date
)

SELECT 
        tmp_table_2.block_date as block_date,
        tmp_table_2.block_date as groupby,
        tmp_table_2.deposit_sol as deposit_sol,
        tmp_table_2.withdraw_sol as withdraw_sol,
        tmp_table_2.large_deposit_sol as large_deposit_sol,
        large_withdraw_table.large_withdraw_sol as large_withdraw_sol
from tmp_table_2
LEFT JOIN large_withdraw_table
ON tmp_table_2.block_date = large_withdraw_table.block_date
ORDER BY block_date

    
"
594162,STEPN_usdc_pool_withdraw_deposit_Plus,,"WITH 
usdc_orca_pool_tran AS (
  SELECT
    block_date,
    pre_token_balance.amount AS pre_amount, 
    post_token_balance.amount AS post_amount
  FROM
    `solana`.`transactions` 
    LATERAL VIEW explode(account_keys) t1 AS account 
    LATERAL VIEW explode(pre_token_balances) t2 AS pre_token_balance 
    LATERAL VIEW explode(post_token_balances) t3 AS post_token_balance
  WHERE
    block_date >= (CURRENT_DATE - '14 days'::INTERVAL)
    AND ARRAY_CONTAINS(account_keys,
      ""7LFnr5YgUyEgPMCLGNQ9N7wM5MFRNqCuRawLZTe5q4c7"")
    -- AND id = ""5iVHcnNWN9DDJe7T5JkAC43dgAkT1oZvDPqX9WhE4mcjGDayjtiVGDjBYfB92Rpj9L5uq4p19nob4ebSFhV4CNoz""
    AND account = ""7LFnr5YgUyEgPMCLGNQ9N7wM5MFRNqCuRawLZTe5q4c7""
    AND pre_token_balance.account = account
    AND post_token_balance.account = account
    AND error IS NULL
    AND pre_token_balance.mint = ""EPjFWdd5AufqSSqeM2qN1xzybapC8G4wEGGkZwyTDt1v""
    AND post_token_balance.mint = ""EPjFWdd5AufqSSqeM2qN1xzybapC8G4wEGGkZwyTDt1v""
    -- AND (pre_token_balance.amount - post_token_balance.amount) > 0 
),
  daily_withdraw_usdc AS(
  SELECT
    block_date,
    SUM(pre_amount - post_amount) AS withdraw_usdc_amount
  FROM
    usdc_orca_pool_tran
  WHERE pre_amount > post_amount
  GROUP BY
    block_date
),
  daily_large_withdraw_usdc AS(
  SELECT
    block_date,
    SUM(pre_amount - post_amount) AS withdraw_usdc_amount
  FROM
    usdc_orca_pool_tran
  WHERE pre_amount - post_amount >= 10000
  GROUP BY
    block_date
),
  daily_deposit_usdc AS(
  SELECT
    block_date,
    SUM(post_amount - pre_amount) AS deposit_usdc_amount
  FROM
    usdc_orca_pool_tran
  WHERE pre_amount < post_amount
  GROUP BY
    block_date
),
  daily_large_deposit_usdc AS(
  SELECT
    block_date,
    SUM(post_amount - pre_amount) AS deposit_usdc_amount
  FROM
    usdc_orca_pool_tran
  WHERE post_amount - pre_amount >= 10000
  GROUP BY
    block_date
),
usdc_in_pool AS (
SELECT
    block_date,
    amount
FROM (
    SELECT 
        block_date, 
        post_token_balance.amount as amount,
        row_number() over (partition by block_date order by block_time DESC) as r
    FROM
        `solana`.`transactions` 
        LATERAL VIEW explode(account_keys) t1 AS account 
        LATERAL VIEW explode(pre_token_balances) t2 AS pre_token_balance 
        LATERAL VIEW explode(post_token_balances) t3 AS post_token_balance
      WHERE
        block_date >= (CURRENT_DATE - '14 days'::INTERVAL)
        AND ARRAY_CONTAINS(account_keys,
          ""7LFnr5YgUyEgPMCLGNQ9N7wM5MFRNqCuRawLZTe5q4c7"")
        -- AND id = ""5iVHcnNWN9DDJe7T5JkAC43dgAkT1oZvDPqX9WhE4mcjGDayjtiVGDjBYfB92Rpj9L5uq4p19nob4ebSFhV4CNoz""
        AND account = ""7LFnr5YgUyEgPMCLGNQ9N7wM5MFRNqCuRawLZTe5q4c7""
        AND pre_token_balance.account = account
        AND post_token_balance.account = account
        AND error IS NULL
        AND pre_token_balance.mint = ""EPjFWdd5AufqSSqeM2qN1xzybapC8G4wEGGkZwyTDt1v""
        AND post_token_balance.mint = ""EPjFWdd5AufqSSqeM2qN1xzybapC8G4wEGGkZwyTDt1v""
    )
    where r = 1
    ORDER BY 
        block_date desc
)

select 
usdc_in_pool.block_date AS block_date,
daily_withdraw_usdc.withdraw_usdc_amount AS withdraw_usdc_amount,
daily_deposit_usdc.deposit_usdc_amount AS deposit_usdc_amount,
daily_large_withdraw_usdc.withdraw_usdc_amount as large_withdraw_usdc_amount,
daily_large_deposit_usdc.deposit_usdc_amount as large_deposit_usdc_amount,
usdc_in_pool.amount AS post_amount
from 
    usdc_in_pool LEFT JOIN daily_withdraw_usdc ON usdc_in_pool.block_date == daily_withdraw_usdc.block_date
    LEFT JOIN daily_deposit_usdc ON usdc_in_pool.block_date == daily_deposit_usdc.block_date
    LEFT JOIN daily_large_withdraw_usdc ON usdc_in_pool.block_date == daily_large_withdraw_usdc.block_date
    LEFT JOIN daily_large_deposit_usdc ON usdc_in_pool.block_date == daily_large_deposit_usdc.block_date
order by block_date desc"
835951,STEPN BSC spending address withdraw & deposit (Fork from @Levi),,"WITH daily_bsc_withdraw_stepn AS (
SELECT
        -- block_time,
        
        -- block_time + '8 hours'::INTERVAL AS fixed_block_time,
        
        date_trunc('day', block_time + '5 hours'::INTERVAL) + '3 hours'::INTERVAL AS fixed_block_date,
        
        round(SUM(value * pow(10, -18))) AS amount,

        'withdraw' AS tran_type

    FROM
    `bnb`.`transactions`
    WHERE 
        block_time >= date_trunc('day', NOW() + '5 hours'::INTERVAL) - '28 days'::INTERVAL
        AND from = '0x6238872a0bd9f0e19073695532a7ed77ce93c69e'
        AND value > 0
        AND success = 'true'
    GROUP BY fixed_block_date
)

, daily_bsc_deposit_stepn AS (
    SELECT 
        date_trunc('day', block_time + '5 hours'::INTERVAL) + '3 hours'::INTERVAL AS fixed_block_date,
        
        round(SUM(value * pow(10, -18))) AS amount,

        'deposit' AS tran_type
    FROM 
    `bnb`.`transactions`
    WHERE 
        block_time >= date_trunc('day', NOW() + '5 hours'::INTERVAL) - '28 days'::INTERVAL
        AND to = '0x6238872a0bd9f0e19073695532a7ed77ce93c69e'
        AND value > 0
        AND success = 'true'
    GROUP BY fixed_block_date
)

SELECT * FROM daily_bsc_withdraw_stepn
UNION
SELECT * FROM daily_bsc_deposit_stepn"
419076,STEPN_total_sol,the total sol in STEPNq2UGeGSzCyGVr2nMQAzf8xuejwqebd84wcksCK,"SELECT
    block_date,
    total_sol
FROM (
    SELECT 
        block_date, 
        (post_balances[1])/power(10,9) as total_sol,
        row_number() over (partition by block_date order by block_time DESC) as r
    FROM solana.transactions
    WHERE 
        block_date >= (CURRENT_DATE - '{{interval}}'::INTERVAL)
        AND size(account_keys) = 3 
        AND account_keys[1] = ""STEPNq2UGeGSzCyGVr2nMQAzf8xuejwqebd84wcksCK""
        AND error is NULL
)
where r = 1
ORDER BY 
    block_date desc



-- select * 
-- from solana.transactions
-- where 
-- block_date >= (CURRENT_DATE - '2 days'::INTERVAL)
-- AND account_keys[1] = ""STEPNq2UGeGSzCyGVr2nMQAzf8xuejwqebd84wcksCK""
-- ORDER BY block_time DESC
-- limit 10
-- SELECT
--     block_date,
--     account_keys,
--     instructions,
--     instruction
-- FROM solana.transactions
-- LATERAL VIEW explode(instructions) instructions AS instruction
-- WHERE
--     block_date >= (CURRENT_DATE - '1 days'::INTERVAL)
--     AND block_date < CURRENT_DATE
--     AND NOT ARRAY_CONTAINS(account_keys, ""Vote111111111111111111111111111111111111111"")
--     and account_keys[instruction['program_id_index']] = 'TokenkegQfeZyiNwAJbNbGKPFXCWuBvf9Ss623VQ5DA'
-- limit 10
-- SELECT
--     block_date
--     , SUM(CASE
--             WHEN account_keys[instruction['program_id_index']] = 'TokenkegQfeZyiNwAJbNbGKPFXCWuBvf9Ss623VQ5DA' THEN 1
--             ELSE 0
--         END) AS STEPN
-- FROM solana.transactions
-- LATERAL VIEW explode(instructions) instructions AS instruction
-- WHERE
--     block_date >= (CURRENT_DATE - '1 days'::INTERVAL)
--     AND block_date < CURRENT_DATE
--     AND NOT ARRAY_CONTAINS(account_keys, ""Vote111111111111111111111111111111111111111"")
--     and account_keys[instruction['program_id_index']] = 'TokenkegQfeZyiNwAJbNbGKPFXCWuBvf9Ss623VQ5DA'
-- GROUP BY 1
-- ORDER BY 1 DESC

-- SELECT
--     block_date
--     , SUM(CASE
--             WHEN account_keys[instruction['program_id_index']] = 'TokenkegQfeZyiNwAJbNbGKPFXCWuBvf9Ss623VQ5DA' THEN 1
--             ELSE 0
--         END) AS STEPN
-- FROM solana.transactions
-- LATERAL VIEW explode(instructions) instructions AS instruction
-- WHERE
--     block_date >= (CURRENT_DATE - '90 days'::INTERVAL)
--     AND block_date < CURRENT_DATE
--     AND NOT ARRAY_CONTAINS(account_keys, ""Vote111111111111111111111111111111111111111"")
--     and account_keys[instruction['program_id_index']] = 'TokenkegQfeZyiNwAJbNbGKPFXCWuBvf9Ss623VQ5DA'
-- GROUP BY 1
-- ORDER BY 1 DESC"
423740,STEPN_profit_indicator_usdc,daily profit(usdc): SOL net inflow - GST net outflow. Another way to estimate the profit is to use daily_deposited_SOL(assume all deposited sol are used to buy shoes)*6%(marketplace fee)*sol price,"WITH
  gst_net_outflow_treasury_table AS(
  SELECT
    block_date,
    (pre_token_balance.amount - post_token_balance.amount) AS gst_net_outflow_treasury --ex: 100-99=1
  FROM
    `solana`.`transactions` 
    LATERAL VIEW explode(account_keys) t1 AS account 
    LATERAL VIEW explode(pre_token_balances) t2 AS pre_token_balance 
    LATERAL VIEW explode(post_token_balances) t3 AS post_token_balance
  WHERE
    block_date >= (CURRENT_DATE - '{{interval}}'::INTERVAL)
    AND ARRAY_CONTAINS(account_keys,
      ""HLS5Y68QSQgJP7wUbbbbCjEnMknVZrHXYDwwVaDcsdK7"")
    AND account = ""HLS5Y68QSQgJP7wUbbbbCjEnMknVZrHXYDwwVaDcsdK7""
    AND pre_token_balance.account = account
    AND post_token_balance.account = account
    AND error IS NULL
    AND pre_token_balance.mint = ""AFbX8oGjGpmVFywbVouvhQSRmiW2aR1mohfahi4Y2AdB""
    AND post_token_balance.mint = ""AFbX8oGjGpmVFywbVouvhQSRmiW2aR1mohfahi4Y2AdB""
    ),
  gst_usdc_orca_pool AS (
  SELECT
    block_date,
    post_token_balance.mint AS token_address,
    SUM(post_token_balance.amount) AS token_size,
  IF
    (post_token_balance.mint ='EPjFWdd5AufqSSqeM2qN1xzybapC8G4wEGGkZwyTDt1v',
      SUM(post_token_balance.amount),
      1/SUM(post_token_balance.amount)) AS tmp
  FROM
    `solana`.`transactions` LATERAL VIEW explode(post_token_balances) t3 AS post_token_balance
  WHERE
    block_date >= (CURRENT_DATE - '30 days'::INTERVAL)
    AND ARRAY_CONTAINS(account_keys,
      ""CwwMfXPXfRT5H5JUatpBctASRGhKW2SqLWWGU3eX5Zgo"") --usdc/gst pool
    AND ((post_token_balance.mint = ""AFbX8oGjGpmVFywbVouvhQSRmiW2aR1mohfahi4Y2AdB""
        AND post_token_balance.account = ""9r39vqrJuubgafaJ5aQyDWYAUQVJeyZyveBXeRqp7xev"")
      OR (post_token_balance.mint = ""EPjFWdd5AufqSSqeM2qN1xzybapC8G4wEGGkZwyTDt1v""
        AND post_token_balance.account = ""7LFnr5YgUyEgPMCLGNQ9N7wM5MFRNqCuRawLZTe5q4c7""))
  GROUP BY
    block_date,
    post_token_balance.mint ),
  gst_price_per_day AS (
  SELECT
    block_date,
    EXP(SUM(LOG(tmp))) AS gst_price
  FROM
    gst_usdc_orca_pool
  GROUP BY
    block_date ),
  daily_release_gst_net_outflow_treasury AS(
  SELECT
    block_date,
    SUM(gst_net_outflow_treasury) AS gst_release_amount
  FROM
    gst_net_outflow_treasury_table
  GROUP BY
    1 ),
  cost AS (
  SELECT
    block_date,
    gst_release_amount,
    gst_price,
    gst_release_amount*gst_price AS cost_usdc
  FROM
    daily_release_gst_net_outflow_treasury
  JOIN
    gst_price_per_day
  USING
    (block_date) ),
despsit as (
SELECT 
    block_date, 
    sum(pre_balances[0] - post_balances[0])/power(10,9) as deposit_sol
FROM solana.transactions
WHERE 
    block_date >= (CURRENT_DATE - '30 days'::INTERVAL)
    AND account_keys[1] = ""STEPNq2UGeGSzCyGVr2nMQAzf8xuejwqebd84wcksCK""
    AND size(account_keys) = 3
    AND error is NULL
GROUP BY
    block_date
),
withdraw as (
SELECT 
    block_date, 
    sum(pre_balances[0] - post_balances[0])/power(10,9) as withdraw_sol
FROM solana.transactions
WHERE 
    block_date >= (CURRENT_DATE - '30 days'::INTERVAL)
    AND account_keys[0] = ""STEPNq2UGeGSzCyGVr2nMQAzf8xuejwqebd84wcksCK""
    AND error is NULL
GROUP BY
    block_date
),
sol_usdc_orca_pool as (
SELECT
    block_date, 
    post_token_balance.mint as token_address, 
    SUM(post_token_balance.amount) as token_size,
    if(post_token_balance.mint ='EPjFWdd5AufqSSqeM2qN1xzybapC8G4wEGGkZwyTDt1v', SUM(post_token_balance.amount), 1/SUM(post_token_balance.amount)) as tmp
FROM 
    solana.transactions
    LATERAL VIEW explode(post_token_balances) t3 AS post_token_balance
WHERE 
    block_date >= (CURRENT_DATE - '30 days'::INTERVAL)
    AND ARRAY_CONTAINS(account_keys, ""B52XRdfTsh8iUGbGEBJLHyDMjhaTW8cAFCmpASGJtnNK"")
    AND (post_token_balance.mint = ""So11111111111111111111111111111111111111112"" or post_token_balance.mint = ""EPjFWdd5AufqSSqeM2qN1xzybapC8G4wEGGkZwyTDt1v"")
GROUP BY
    block_date, 
    post_token_balance.mint
),
sol_price_per_day as (
SELECT 
    block_date, 
    exp(sum(log(tmp))) as sol_price
FROM sol_usdc_orca_pool
GROUP BY block_date
)

select 
block_date,
(deposit_sol-withdraw_sol)*sol_price - cost_usdc as profit
from cost join despsit using(block_date) join withdraw using(block_date) join sol_price_per_day using(block_date)
order by block_date desc
"
424344,daily_withdrawn_GST_usdc(move to earn or withdraw extra deposited GST),,"WITH
gst_from_treasury_table AS(
  SELECT
    block_date,
    (pre_token_balance.amount - post_token_balance.amount) AS gst_from_treasury --ex: 100-99=1
  FROM
    `solana`.`transactions` 
    LATERAL VIEW explode(account_keys) t1 AS account 
    LATERAL VIEW explode(pre_token_balances) t2 AS pre_token_balance 
    LATERAL VIEW explode(post_token_balances) t3 AS post_token_balance
  WHERE
    block_date >= (CURRENT_DATE - '{{interval}}'::INTERVAL)
    AND ARRAY_CONTAINS(account_keys,
      ""HLS5Y68QSQgJP7wUbbbbCjEnMknVZrHXYDwwVaDcsdK7"")
    AND account = ""HLS5Y68QSQgJP7wUbbbbCjEnMknVZrHXYDwwVaDcsdK7""
    AND pre_token_balance.account = account
    AND post_token_balance.account = account
    AND error IS NULL
    AND pre_token_balance.mint = ""AFbX8oGjGpmVFywbVouvhQSRmiW2aR1mohfahi4Y2AdB""
    AND post_token_balance.mint = ""AFbX8oGjGpmVFywbVouvhQSRmiW2aR1mohfahi4Y2AdB""
    AND (pre_token_balance.amount - post_token_balance.amount) > 0 -- 100-99 -> output 1
),
gst_usdc_orca_pool AS (
  SELECT
    block_date,
    post_token_balance.mint AS token_address,
    SUM(post_token_balance.amount) AS token_size,
  IF
    (post_token_balance.mint ='EPjFWdd5AufqSSqeM2qN1xzybapC8G4wEGGkZwyTDt1v',
      SUM(post_token_balance.amount),
      1/SUM(post_token_balance.amount)) AS tmp
  FROM
    `solana`.`transactions` LATERAL VIEW explode(post_token_balances) t3 AS post_token_balance
  WHERE
    block_date >= (CURRENT_DATE - '{{interval}}'::INTERVAL)
    AND ARRAY_CONTAINS(account_keys,
      ""CwwMfXPXfRT5H5JUatpBctASRGhKW2SqLWWGU3eX5Zgo"") --usdc/gst pool
    AND ((post_token_balance.mint = ""AFbX8oGjGpmVFywbVouvhQSRmiW2aR1mohfahi4Y2AdB""
        AND post_token_balance.account = ""9r39vqrJuubgafaJ5aQyDWYAUQVJeyZyveBXeRqp7xev"")
      OR (post_token_balance.mint = ""EPjFWdd5AufqSSqeM2qN1xzybapC8G4wEGGkZwyTDt1v""
        AND post_token_balance.account = ""7LFnr5YgUyEgPMCLGNQ9N7wM5MFRNqCuRawLZTe5q4c7""))
  GROUP BY
    block_date,
    post_token_balance.mint
),
gst_price_per_day AS (
  SELECT
    block_date,
    EXP(SUM(LOG(tmp))) AS gst_price
  FROM
    gst_usdc_orca_pool
  GROUP BY
    block_date
),
daily_release_gst_from_treasury AS(
  SELECT
    block_date,
    SUM(gst_from_treasury) AS gst_release_amount
  FROM
    gst_from_treasury_table
  GROUP BY
    1
),
cost AS (
  SELECT
    block_date,
    gst_release_amount,
    gst_price,
    gst_release_amount*gst_price AS withdrawn_GST_usdc
  FROM
    daily_release_gst_from_treasury
  JOIN
    gst_price_per_day
  USING
    (block_date)
)

select 
    block_date,
    withdrawn_GST_usdc
from
    cost 
order by
    block_date desc
"
419089,daily_withdrawn_SOL(sell shoes or withdraw extra deposited SOL),,"SELECT 
    block_date, 
    sum(pre_balances[0] - post_balances[0])/power(10,9) as withdraw_sol
FROM solana.transactions
WHERE 
    block_date >= (CURRENT_DATE - '{{interval}}'::INTERVAL)
    -- AND size(account_keys) = 3 
    AND account_keys[0] = ""STEPNq2UGeGSzCyGVr2nMQAzf8xuejwqebd84wcksCK""
    AND error is NULL
GROUP BY
    block_date
ORDER BY 
    block_date desc


-- select * 
-- from solana.transactions
-- where 
-- block_date >= (CURRENT_DATE - '1 days'::INTERVAL)
-- AND ARRAY_CONTAINS(account_keys, ""36U6HnMCGtR5ViKZbeA27HDRzc7oNCftcW4GtTfVvA8Y"")
-- limit 10
-- SELECT
--     block_date,
--     account_keys,
--     instructions,
--     instruction
-- FROM solana.transactions
-- LATERAL VIEW explode(instructions) instructions AS instruction
-- WHERE
--     block_date >= (CURRENT_DATE - '1 days'::INTERVAL)
--     AND block_date < CURRENT_DATE
--     AND NOT ARRAY_CONTAINS(account_keys, ""Vote111111111111111111111111111111111111111"")
--     and account_keys[instruction['program_id_index']] = 'TokenkegQfeZyiNwAJbNbGKPFXCWuBvf9Ss623VQ5DA'
-- limit 10
-- SELECT
--     block_date
--     , SUM(CASE
--             WHEN account_keys[instruction['program_id_index']] = 'TokenkegQfeZyiNwAJbNbGKPFXCWuBvf9Ss623VQ5DA' THEN 1
--             ELSE 0
--         END) AS STEPN
-- FROM solana.transactions
-- LATERAL VIEW explode(instructions) instructions AS instruction
-- WHERE
--     block_date >= (CURRENT_DATE - '1 days'::INTERVAL)
--     AND block_date < CURRENT_DATE
--     AND NOT ARRAY_CONTAINS(account_keys, ""Vote111111111111111111111111111111111111111"")
--     and account_keys[instruction['program_id_index']] = 'TokenkegQfeZyiNwAJbNbGKPFXCWuBvf9Ss623VQ5DA'
-- GROUP BY 1
-- ORDER BY 1 DESC

-- SELECT
--     block_date
--     , SUM(CASE
--             WHEN account_keys[instruction['program_id_index']] = 'TokenkegQfeZyiNwAJbNbGKPFXCWuBvf9Ss623VQ5DA' THEN 1
--             ELSE 0
--         END) AS STEPN
-- FROM solana.transactions
-- LATERAL VIEW explode(instructions) instructions AS instruction
-- WHERE
--     block_date >= (CURRENT_DATE - '90 days'::INTERVAL)
--     AND block_date < CURRENT_DATE
--     AND NOT ARRAY_CONTAINS(account_keys, ""Vote111111111111111111111111111111111111111"")
--     and account_keys[instruction['program_id_index']] = 'TokenkegQfeZyiNwAJbNbGKPFXCWuBvf9Ss623VQ5DA'
-- GROUP BY 1
-- ORDER BY 1 DESC"
419344,STEPN_daily_deposited_SOL_unique_user,,"SELECT 
    block_date, 
    COUNT(distinct account_keys[0]) as unique_deposit_accounts
FROM solana.transactions
WHERE 
    block_date >= (CURRENT_DATE - '{{interval}}'::INTERVAL)
    AND account_keys[1] = ""STEPNq2UGeGSzCyGVr2nMQAzf8xuejwqebd84wcksCK""
    AND size(account_keys) = 3
    AND error is NULL
    -- AND ARRAY_CONTAINS(account_keys, ""STEPNq2UGeGSzCyGVr2nMQAzf8xuejwqebd84wcksCK"")
GROUP BY
    block_date
ORDER BY 
    block_date desc


-- select * 
-- from solana.transactions
-- where 
-- block_date >= (CURRENT_DATE - '1 days'::INTERVAL)
-- AND ARRAY_CONTAINS(account_keys, ""36U6HnMCGtR5ViKZbeA27HDRzc7oNCftcW4GtTfVvA8Y"")
-- limit 10
-- SELECT
--     block_date,
--     account_keys,
--     instructions,
--     instruction
-- FROM solana.transactions
-- LATERAL VIEW explode(instructions) instructions AS instruction
-- WHERE
--     block_date >= (CURRENT_DATE - '1 days'::INTERVAL)
--     AND block_date < CURRENT_DATE
--     AND NOT ARRAY_CONTAINS(account_keys, ""Vote111111111111111111111111111111111111111"")
--     and account_keys[instruction['program_id_index']] = 'TokenkegQfeZyiNwAJbNbGKPFXCWuBvf9Ss623VQ5DA'
-- limit 10
-- SELECT
--     block_date
--     , SUM(CASE
--             WHEN account_keys[instruction['program_id_index']] = 'TokenkegQfeZyiNwAJbNbGKPFXCWuBvf9Ss623VQ5DA' THEN 1
--             ELSE 0
--         END) AS STEPN
-- FROM solana.transactions
-- LATERAL VIEW explode(instructions) instructions AS instruction
-- WHERE
--     block_date >= (CURRENT_DATE - '1 days'::INTERVAL)
--     AND block_date < CURRENT_DATE
--     AND NOT ARRAY_CONTAINS(account_keys, ""Vote111111111111111111111111111111111111111"")
--     and account_keys[instruction['program_id_index']] = 'TokenkegQfeZyiNwAJbNbGKPFXCWuBvf9Ss623VQ5DA'
-- GROUP BY 1
-- ORDER BY 1 DESC

-- SELECT
--     block_date
--     , SUM(CASE
--             WHEN account_keys[instruction['program_id_index']] = 'TokenkegQfeZyiNwAJbNbGKPFXCWuBvf9Ss623VQ5DA' THEN 1
--             ELSE 0
--         END) AS STEPN
-- FROM solana.transactions
-- LATERAL VIEW explode(instructions) instructions AS instruction
-- WHERE
--     block_date >= (CURRENT_DATE - '90 days'::INTERVAL)
--     AND block_date < CURRENT_DATE
--     AND NOT ARRAY_CONTAINS(account_keys, ""Vote111111111111111111111111111111111111111"")
--     and account_keys[instruction['program_id_index']] = 'TokenkegQfeZyiNwAJbNbGKPFXCWuBvf9Ss623VQ5DA'
-- GROUP BY 1
-- ORDER BY 1 DESC"
489930,STEPN_accumulated_deposited_SOL_unique_user,,"WITH firstseen AS (
  SELECT account_keys[0] as account_id, MIN(block_date) as block_date
  FROM solana.transactions
  WHERE 
    block_date >= (CURRENT_DATE - '{{interval}}'::INTERVAL) AND 
    size(account_keys) = 3
    AND account_keys[1] = ""STEPNq2UGeGSzCyGVr2nMQAzf8xuejwqebd84wcksCK""
    AND error is NULL
  GROUP BY 1
)
SELECT DISTINCT block_date, COUNT(account_id) OVER (ORDER BY block_date) total_unique_deposited_accounts 
FROM firstseen
ORDER BY 1
"
418006,daily_deposited_SOL(buy shoes),,"SELECT 
    block_date, 
    sum(pre_balances[0] - post_balances[0])/power(10,9) as deposit_sol
FROM solana.transactions
WHERE 
    block_date >= (CURRENT_DATE - '{{interval}}'::INTERVAL)
    AND account_keys[1] = ""STEPNq2UGeGSzCyGVr2nMQAzf8xuejwqebd84wcksCK""
    AND size(account_keys) = 3
    AND error is NULL
    -- AND ARRAY_CONTAINS(account_keys, ""STEPNq2UGeGSzCyGVr2nMQAzf8xuejwqebd84wcksCK"")
GROUP BY
    block_date
ORDER BY 
    block_date desc


-- select * 
-- from solana.transactions
-- where 
-- block_date >= (CURRENT_DATE - '1 days'::INTERVAL)
-- AND ARRAY_CONTAINS(account_keys, ""36U6HnMCGtR5ViKZbeA27HDRzc7oNCftcW4GtTfVvA8Y"")
-- limit 10
-- SELECT
--     block_date,
--     account_keys,
--     instructions,
--     instruction
-- FROM solana.transactions
-- LATERAL VIEW explode(instructions) instructions AS instruction
-- WHERE
--     block_date >= (CURRENT_DATE - '1 days'::INTERVAL)
--     AND block_date < CURRENT_DATE
--     AND NOT ARRAY_CONTAINS(account_keys, ""Vote111111111111111111111111111111111111111"")
--     and account_keys[instruction['program_id_index']] = 'TokenkegQfeZyiNwAJbNbGKPFXCWuBvf9Ss623VQ5DA'
-- limit 10
-- SELECT
--     block_date
--     , SUM(CASE
--             WHEN account_keys[instruction['program_id_index']] = 'TokenkegQfeZyiNwAJbNbGKPFXCWuBvf9Ss623VQ5DA' THEN 1
--             ELSE 0
--         END) AS STEPN
-- FROM solana.transactions
-- LATERAL VIEW explode(instructions) instructions AS instruction
-- WHERE
--     block_date >= (CURRENT_DATE - '1 days'::INTERVAL)
--     AND block_date < CURRENT_DATE
--     AND NOT ARRAY_CONTAINS(account_keys, ""Vote111111111111111111111111111111111111111"")
--     and account_keys[instruction['program_id_index']] = 'TokenkegQfeZyiNwAJbNbGKPFXCWuBvf9Ss623VQ5DA'
-- GROUP BY 1
-- ORDER BY 1 DESC

-- SELECT
--     block_date
--     , SUM(CASE
--             WHEN account_keys[instruction['program_id_index']] = 'TokenkegQfeZyiNwAJbNbGKPFXCWuBvf9Ss623VQ5DA' THEN 1
--             ELSE 0
--         END) AS STEPN
-- FROM solana.transactions
-- LATERAL VIEW explode(instructions) instructions AS instruction
-- WHERE
--     block_date >= (CURRENT_DATE - '90 days'::INTERVAL)
--     AND block_date < CURRENT_DATE
--     AND NOT ARRAY_CONTAINS(account_keys, ""Vote111111111111111111111111111111111111111"")
--     and account_keys[instruction['program_id_index']] = 'TokenkegQfeZyiNwAJbNbGKPFXCWuBvf9Ss623VQ5DA'
-- GROUP BY 1
-- ORDER BY 1 DESC"
520005,daily_deposited_GST_usdc(upgrade or mint shoes),,"WITH
  gst_to_treasury_table AS(
  SELECT
    block_date,
    -1*(pre_token_balance.amount - post_token_balance.amount) AS gst_to_treasury -- 99-100 -> increase 1, means deposit 1 gst
  FROM
    `solana`.`transactions` 
    LATERAL VIEW explode(account_keys) t1 AS account 
    LATERAL VIEW explode(pre_token_balances) t2 AS pre_token_balance 
    LATERAL VIEW explode(post_token_balances) t3 AS post_token_balance
  WHERE
    block_date >= (CURRENT_DATE - '{{interval}}'::INTERVAL)
    AND ARRAY_CONTAINS(account_keys,
      ""HLS5Y68QSQgJP7wUbbbbCjEnMknVZrHXYDwwVaDcsdK7"")
    AND account = ""HLS5Y68QSQgJP7wUbbbbCjEnMknVZrHXYDwwVaDcsdK7""
    AND pre_token_balance.account = account
    AND post_token_balance.account = account
    AND error IS NULL
    AND pre_token_balance.mint = ""AFbX8oGjGpmVFywbVouvhQSRmiW2aR1mohfahi4Y2AdB""
    AND post_token_balance.mint = ""AFbX8oGjGpmVFywbVouvhQSRmiW2aR1mohfahi4Y2AdB""
    AND (pre_token_balance.amount - post_token_balance.amount) < 0 -- 99-100 -> increase 1, means deposit 1 gst
    ),
  gst_usdc_orca_pool AS (
  SELECT
    block_date,
    post_token_balance.mint AS token_address,
    SUM(post_token_balance.amount) AS token_size,
  IF
    (post_token_balance.mint ='EPjFWdd5AufqSSqeM2qN1xzybapC8G4wEGGkZwyTDt1v',
      SUM(post_token_balance.amount),
      1/SUM(post_token_balance.amount)) AS tmp
  FROM
    `solana`.`transactions` LATERAL VIEW explode(post_token_balances) t3 AS post_token_balance
  WHERE
    block_date >= (CURRENT_DATE - '{{interval}}'::INTERVAL)
    AND ARRAY_CONTAINS(account_keys,
      ""CwwMfXPXfRT5H5JUatpBctASRGhKW2SqLWWGU3eX5Zgo"") --usdc/gst pool
    AND ((post_token_balance.mint = ""AFbX8oGjGpmVFywbVouvhQSRmiW2aR1mohfahi4Y2AdB""
        AND post_token_balance.account = ""9r39vqrJuubgafaJ5aQyDWYAUQVJeyZyveBXeRqp7xev"")
      OR (post_token_balance.mint = ""EPjFWdd5AufqSSqeM2qN1xzybapC8G4wEGGkZwyTDt1v""
        AND post_token_balance.account = ""7LFnr5YgUyEgPMCLGNQ9N7wM5MFRNqCuRawLZTe5q4c7""))
  GROUP BY
    block_date,
    post_token_balance.mint ),
  gst_price_per_day AS (
  SELECT
    block_date,
    EXP(SUM(LOG(tmp))) AS gst_price
  FROM
    gst_usdc_orca_pool
  GROUP BY
    block_date ),
  daily_release_gst_to_treasury AS(
  SELECT
    block_date,
    SUM(gst_to_treasury) AS gst_release_amount
  FROM
    gst_to_treasury_table
  GROUP BY
    1 ),
  cost AS (
  SELECT
    block_date,
    gst_release_amount,
    gst_price,
    gst_release_amount*gst_price AS deposited_GST_usdc
  FROM
    daily_release_gst_to_treasury
  JOIN
    gst_price_per_day
  USING
    (block_date) )

select 
block_date,
deposited_GST_usdc
from cost 
order by block_date desc
"
520167,daily_net_outflow_GST_usdc,the daily usdc value of GST net outflow to STEPNq2UGeGSzCyGVr2nMQAzf8xuejwqebd84wcksCK,"WITH
  gst_to_treasury_table AS(
  SELECT
    block_date,
    -1*(pre_token_balance.amount - post_token_balance.amount) AS gst_to_treasury -- 99-100 -> increase 1, means deposit 1 gst
  FROM
    `solana`.`transactions` 
    LATERAL VIEW explode(account_keys) t1 AS account 
    LATERAL VIEW explode(pre_token_balances) t2 AS pre_token_balance 
    LATERAL VIEW explode(post_token_balances) t3 AS post_token_balance
  WHERE
    block_date >= (CURRENT_DATE - '{{interval}}'::INTERVAL)
    AND ARRAY_CONTAINS(account_keys,
      ""HLS5Y68QSQgJP7wUbbbbCjEnMknVZrHXYDwwVaDcsdK7"")
    AND account = ""HLS5Y68QSQgJP7wUbbbbCjEnMknVZrHXYDwwVaDcsdK7""
    AND pre_token_balance.account = account
    AND post_token_balance.account = account
    AND error IS NULL
    AND pre_token_balance.mint = ""AFbX8oGjGpmVFywbVouvhQSRmiW2aR1mohfahi4Y2AdB""
    AND post_token_balance.mint = ""AFbX8oGjGpmVFywbVouvhQSRmiW2aR1mohfahi4Y2AdB""
    ),
  gst_usdc_orca_pool AS (
  SELECT
    block_date,
    post_token_balance.mint AS token_address,
    SUM(post_token_balance.amount) AS token_size,
  IF
    (post_token_balance.mint ='EPjFWdd5AufqSSqeM2qN1xzybapC8G4wEGGkZwyTDt1v',
      SUM(post_token_balance.amount),
      1/SUM(post_token_balance.amount)) AS tmp
  FROM
    `solana`.`transactions` LATERAL VIEW explode(post_token_balances) t3 AS post_token_balance
  WHERE
    block_date >= (CURRENT_DATE - '{{interval}}'::INTERVAL)
    AND ARRAY_CONTAINS(account_keys,
      ""CwwMfXPXfRT5H5JUatpBctASRGhKW2SqLWWGU3eX5Zgo"") --usdc/gst pool
    AND ((post_token_balance.mint = ""AFbX8oGjGpmVFywbVouvhQSRmiW2aR1mohfahi4Y2AdB""
        AND post_token_balance.account = ""9r39vqrJuubgafaJ5aQyDWYAUQVJeyZyveBXeRqp7xev"")
      OR (post_token_balance.mint = ""EPjFWdd5AufqSSqeM2qN1xzybapC8G4wEGGkZwyTDt1v""
        AND post_token_balance.account = ""7LFnr5YgUyEgPMCLGNQ9N7wM5MFRNqCuRawLZTe5q4c7""))
  GROUP BY
    block_date,
    post_token_balance.mint ),
  gst_price_per_day AS (
  SELECT
    block_date,
    EXP(SUM(LOG(tmp))) AS gst_price
  FROM
    gst_usdc_orca_pool
  GROUP BY
    block_date ),
  daily_release_gst_to_treasury AS(
  SELECT
    block_date,
    SUM(gst_to_treasury) AS gst_release_amount
  FROM
    gst_to_treasury_table
  GROUP BY
    1 ),
  cost AS (
  SELECT
    block_date,
    gst_release_amount,
    gst_price,
    gst_release_amount*gst_price AS cost_usdc
  FROM
    daily_release_gst_to_treasury
  JOIN
    gst_price_per_day
  USING
    (block_date) )

select 
block_date,
cost_usdc as cost_usdc
from cost 
order by block_date desc
"
424315,daily_net_inflow_SOL,the daily net inflow of SOL to STEPNq2UGeGSzCyGVr2nMQAzf8xuejwqebd84wcksCK,"WITH
deposit as (
SELECT 
    block_date, 
    sum(pre_balances[0] - post_balances[0])/power(10,9) as deposit_sol
FROM solana.transactions
WHERE 
    block_date >= (CURRENT_DATE - '{{interval}}'::INTERVAL)
    AND account_keys[1] = ""STEPNq2UGeGSzCyGVr2nMQAzf8xuejwqebd84wcksCK""
    AND size(account_keys) = 3
    AND error is NULL
    -- AND ARRAY_CONTAINS(account_keys, ""STEPNq2UGeGSzCyGVr2nMQAzf8xuejwqebd84wcksCK"")
GROUP BY
    block_date
),
withdraw as (
SELECT 
    block_date, 
    sum(pre_balances[0] - post_balances[0])/power(10,9) as withdraw_sol
FROM solana.transactions
WHERE 
    block_date >= (CURRENT_DATE - '{{interval}}'::INTERVAL)
    -- AND size(account_keys) = 3 
    AND account_keys[0] = ""STEPNq2UGeGSzCyGVr2nMQAzf8xuejwqebd84wcksCK""
    AND error is NULL
GROUP BY
    block_date

)

select 
block_date,
(deposit_sol-withdraw_sol) as revenue_sol
from deposit join withdraw using(block_date)
order by block_date desc
"
483254,withdraw_large_amount_sol,,"SELECT 
    block_time,
    account_keys[1] as account, 
    (pre_balances[0] - post_balances[0])/power(10,9) as withdraw_sol
FROM solana.transactions
WHERE 
    block_date >= (CURRENT_DATE - '30 days'::INTERVAL)
    -- AND size(account_keys) = 3 
    AND account_keys[0] = ""STEPNq2UGeGSzCyGVr2nMQAzf8xuejwqebd84wcksCK""
    AND error is NULL
    AND (pre_balances[0] - post_balances[0])/power(10,9) > 10000 -- withdraw sol > 10000
ORDER BY 
    block_time desc


-- select * 
-- from solana.transactions
-- where 
-- block_date >= (CURRENT_DATE - '1 days'::INTERVAL)
-- AND ARRAY_CONTAINS(account_keys, ""36U6HnMCGtR5ViKZbeA27HDRzc7oNCftcW4GtTfVvA8Y"")
-- limit 10
-- SELECT
--     block_date,
--     account_keys,
--     instructions,
--     instruction
-- FROM solana.transactions
-- LATERAL VIEW explode(instructions) instructions AS instruction
-- WHERE
--     block_date >= (CURRENT_DATE - '1 days'::INTERVAL)
--     AND block_date < CURRENT_DATE
--     AND NOT ARRAY_CONTAINS(account_keys, ""Vote111111111111111111111111111111111111111"")
--     and account_keys[instruction['program_id_index']] = 'TokenkegQfeZyiNwAJbNbGKPFXCWuBvf9Ss623VQ5DA'
-- limit 10
-- SELECT
--     block_date
--     , SUM(CASE
--             WHEN account_keys[instruction['program_id_index']] = 'TokenkegQfeZyiNwAJbNbGKPFXCWuBvf9Ss623VQ5DA' THEN 1
--             ELSE 0
--         END) AS STEPN
-- FROM solana.transactions
-- LATERAL VIEW explode(instructions) instructions AS instruction
-- WHERE
--     block_date >= (CURRENT_DATE - '1 days'::INTERVAL)
--     AND block_date < CURRENT_DATE
--     AND NOT ARRAY_CONTAINS(account_keys, ""Vote111111111111111111111111111111111111111"")
--     and account_keys[instruction['program_id_index']] = 'TokenkegQfeZyiNwAJbNbGKPFXCWuBvf9Ss623VQ5DA'
-- GROUP BY 1
-- ORDER BY 1 DESC

-- SELECT
--     block_date
--     , SUM(CASE
--             WHEN account_keys[instruction['program_id_index']] = 'TokenkegQfeZyiNwAJbNbGKPFXCWuBvf9Ss623VQ5DA' THEN 1
--             ELSE 0
--         END) AS STEPN
-- FROM solana.transactions
-- LATERAL VIEW explode(instructions) instructions AS instruction
-- WHERE
--     block_date >= (CURRENT_DATE - '90 days'::INTERVAL)
--     AND block_date < CURRENT_DATE
--     AND NOT ARRAY_CONTAINS(account_keys, ""Vote111111111111111111111111111111111111111"")
--     and account_keys[instruction['program_id_index']] = 'TokenkegQfeZyiNwAJbNbGKPFXCWuBvf9Ss623VQ5DA'
-- GROUP BY 1
-- ORDER BY 1 DESC"
557265,STEPN DAU,,"WITH 
orca_tran_table AS (
  SELECT 
    -- id,
    block_date,
    -- account,
    signer as user
    -- pre_token_balance,
    -- post_token_balance
    -- pre_token_balance.amount AS pre_amount, 
    -- post_token_balance.amount AS post_amount
  FROM
    solana.transactions 
    LATERAL VIEW explode(account_keys) t1 AS account 
    LATERAL VIEW explode(pre_token_balances) t2 AS pre_token_balance 
    LATERAL VIEW explode(post_token_balances) t3 AS post_token_balance
  WHERE
    block_date >= (CURRENT_DATE - '14 days'::INTERVAL)
    AND 
        (
            (
                ARRAY_CONTAINS(account_keys,""7LFnr5YgUyEgPMCLGNQ9N7wM5MFRNqCuRawLZTe5q4c7"")
                AND 
                account = ""7LFnr5YgUyEgPMCLGNQ9N7wM5MFRNqCuRawLZTe5q4c7""
            )
            OR
            (
                ARRAY_CONTAINS(account_keys,""DdBTJuiAXQQ7gLVXBXNPbVEG8g1avRxiJXhH5LhBytYW"")
                AND 
                account = ""DdBTJuiAXQQ7gLVXBXNPbVEG8g1avRxiJXhH5LhBytYW""
            )
        )
    AND pre_token_balance.account = account
    AND post_token_balance.account = account
    AND error IS NULL
    AND pre_token_balance.mint = ""EPjFWdd5AufqSSqeM2qN1xzybapC8G4wEGGkZwyTDt1v""
    AND post_token_balance.mint = ""EPjFWdd5AufqSSqeM2qN1xzybapC8G4wEGGkZwyTDt1v""
    -- AND (pre_token_balance.amount - post_token_balance.amount) > 0 --出金
    -- AND (pre_token_balance.amount - post_token_balance.amount) < 0 --入金
),
spendding_daily_deposit_user as (
    SELECT 
        block_date, 
        account_keys[0] AS user
    FROM solana.transactions
    WHERE 
        block_date >= (CURRENT_DATE - '14 days'::INTERVAL)
        AND account_keys[1] = ""STEPNq2UGeGSzCyGVr2nMQAzf8xuejwqebd84wcksCK""
        AND size(account_keys) = 3
        AND error is NULL
    ORDER BY 
        block_date desc
),
spendding_daily_withdraw_user as (
    SELECT 
        block_date, 
        account_keys[1] AS user
    FROM solana.transactions
    WHERE 
        block_date >= (CURRENT_DATE - '14 days'::INTERVAL)
        AND account_keys[0] = ""STEPNq2UGeGSzCyGVr2nMQAzf8xuejwqebd84wcksCK""
        AND size(account_keys) = 3
        AND error is NULL
    ORDER BY 
        block_date desc
),
owner_mapping_table AS (
  SELECT 
    distinct signer as owner,
    pre_token_balance.account as taccount
  FROM
    solana.transactions 
    LATERAL VIEW explode(pre_token_balances) t2 AS pre_token_balance 
  WHERE
    block_date >= (CURRENT_DATE - '14 days'::INTERVAL)
    AND 
    (
        (
            ARRAY_CONTAINS(account_keys,""HLS5Y68QSQgJP7wUbbbbCjEnMknVZrHXYDwwVaDcsdK7"")
            AND pre_token_balance.account <> ""HLS5Y68QSQgJP7wUbbbbCjEnMknVZrHXYDwwVaDcsdK7""
            AND pre_token_balance.mint = ""AFbX8oGjGpmVFywbVouvhQSRmiW2aR1mohfahi4Y2AdB""
        )
        OR
        (
            ARRAY_CONTAINS(account_keys,""HhXAKYmRzBNi7BjkDs2fbwJ49mnpWUtzyXEf8PAMArs4"")
            AND pre_token_balance.account <> ""HhXAKYmRzBNi7BjkDs2fbwJ49mnpWUtzyXEf8PAMArs4""
            AND pre_token_balance.mint = ""7i5KKsX2weiTkry7jA4ZwSuXGhs5eJBEjY8vVxR4pfRx""
        )
    )
    AND error IS NULL
    AND signer <> ""STEPNq2UGeGSzCyGVr2nMQAzf8xuejwqebd84wcksCK""
),
spendding_gst_daily_withdraw_user_raw AS (
  SELECT 
    block_date,
    post_token_balance.account as taccount
  FROM
    solana.transactions 
    LATERAL VIEW explode(post_token_balances) t3 AS post_token_balance
  WHERE
    block_date >= (CURRENT_DATE - '14 days'::INTERVAL)
    AND ARRAY_CONTAINS(account_keys,
      ""HLS5Y68QSQgJP7wUbbbbCjEnMknVZrHXYDwwVaDcsdK7"")
    AND post_token_balance.account <> ""HLS5Y68QSQgJP7wUbbbbCjEnMknVZrHXYDwwVaDcsdK7""
    AND error IS NULL
    AND post_token_balance.mint = ""AFbX8oGjGpmVFywbVouvhQSRmiW2aR1mohfahi4Y2AdB""
    AND signer = ""STEPNq2UGeGSzCyGVr2nMQAzf8xuejwqebd84wcksCK""
),

spendding_gst_daily_withdraw_user AS (
    SELECT 
        spendding_gst_daily_withdraw_user_raw.block_date,
        owner_mapping_table.owner as user
    FROM
        spendding_gst_daily_withdraw_user_raw
    JOIN
        owner_mapping_table
    ON
        spendding_gst_daily_withdraw_user_raw.taccount = owner_mapping_table.taccount
),
spendding_gst_daily_deposit_user AS (
  SELECT 
    block_date,
    signer as user
  FROM
    solana.transactions 
    LATERAL VIEW explode(pre_token_balances) t2 AS pre_token_balance 
  WHERE
    block_date >= (CURRENT_DATE - '14 days'::INTERVAL)
    AND ARRAY_CONTAINS(account_keys,
      ""HLS5Y68QSQgJP7wUbbbbCjEnMknVZrHXYDwwVaDcsdK7"")
    AND pre_token_balance.account <> ""HLS5Y68QSQgJP7wUbbbbCjEnMknVZrHXYDwwVaDcsdK7""
    AND error IS NULL
    AND pre_token_balance.mint = ""AFbX8oGjGpmVFywbVouvhQSRmiW2aR1mohfahi4Y2AdB""
    AND signer <> ""STEPNq2UGeGSzCyGVr2nMQAzf8xuejwqebd84wcksCK""
),

spendding_gmt_daily_withdraw_user_raw AS (
  SELECT 
    block_date,
    post_token_balance.account as taccount
  FROM
    solana.transactions 
    LATERAL VIEW explode(post_token_balances) t3 AS post_token_balance
  WHERE
    block_date >= (CURRENT_DATE - '14 days'::INTERVAL)
    AND ARRAY_CONTAINS(account_keys,
      ""HhXAKYmRzBNi7BjkDs2fbwJ49mnpWUtzyXEf8PAMArs4"")
    AND post_token_balance.account <> ""HhXAKYmRzBNi7BjkDs2fbwJ49mnpWUtzyXEf8PAMArs4""
    AND error IS NULL
    AND post_token_balance.mint = ""7i5KKsX2weiTkry7jA4ZwSuXGhs5eJBEjY8vVxR4pfRx""
    AND signer = ""STEPNq2UGeGSzCyGVr2nMQAzf8xuejwqebd84wcksCK""
),

spendding_gmt_daily_withdraw_user AS (
    SELECT 
        spendding_gmt_daily_withdraw_user_raw.block_date,
        owner_mapping_table.owner as user
    FROM
        spendding_gmt_daily_withdraw_user_raw
    JOIN
        owner_mapping_table
    ON
        spendding_gmt_daily_withdraw_user_raw.taccount = owner_mapping_table.taccount
),
spendding_gmt_daily_deposit_user AS (
  SELECT 
    block_date,
    signer as user
  FROM
    solana.transactions 
    LATERAL VIEW explode(pre_token_balances) t2 AS pre_token_balance 
  WHERE
    block_date >= (CURRENT_DATE - '14 days'::INTERVAL)
    AND ARRAY_CONTAINS(account_keys,
      ""HhXAKYmRzBNi7BjkDs2fbwJ49mnpWUtzyXEf8PAMArs4"")
    AND pre_token_balance.account <> ""HhXAKYmRzBNi7BjkDs2fbwJ49mnpWUtzyXEf8PAMArs4""
    AND error IS NULL
    AND pre_token_balance.mint = ""7i5KKsX2weiTkry7jA4ZwSuXGhs5eJBEjY8vVxR4pfRx""
    AND signer <> ""STEPNq2UGeGSzCyGVr2nMQAzf8xuejwqebd84wcksCK""
),


stepn_dau_raw as (
    SELECT * FROM orca_tran_table
    UNION all 
    SELECT * FROM spendding_daily_deposit_user
    UNION all
    SELECT * FROM spendding_daily_withdraw_user
    UNION all
    SELECT * FROM spendding_gst_daily_withdraw_user
    UNION all
    SELECT * FROM spendding_gst_daily_deposit_user
    UNION all
    SELECT * FROM spendding_gmt_daily_withdraw_user
    UNION all
    SELECT * FROM spendding_gmt_daily_deposit_user
),

stepn_dau_raw2 as (
    SELECT block_date, COUNT(distinct user) as DAU
    FROM stepn_dau_raw
    GROUP BY block_date
    ORDER BY block_date DESC
)

    SELECT 
        r2.block_date as block_date,
        r2.DAU as DAU,
        r3.DAU as lastDAU,
        IF (
            ((r2.DAU - r3.DAU) / r3.DAU * 100) < -20 AND r2.block_date > (CURRENT_DATE - '1 days'::INTERVAL),
            0,
            ((r2.DAU - r3.DAU) / r3.DAU * 100)
        ) as INCRATE
    FROM stepn_dau_raw2 r2 JOIN stepn_dau_raw2 r3
    ON r2.block_date = r3.block_date + '1 days'::INTERVAL
    WHERE r2.block_date >= (CURRENT_DATE - '13 days'::INTERVAL)
"
563236,V1.0_GST池每日出入金统计,,"WITH 
usdc_orca_pool_tran AS (
  SELECT
    block_date,
    pre_token_balance.amount AS pre_amount, 
    post_token_balance.amount AS post_amount
  FROM
    solana.transactions
    LATERAL VIEW explode(account_keys) t1 AS account 
    LATERAL VIEW explode(pre_token_balances) t2 AS pre_token_balance 
    LATERAL VIEW explode(post_token_balances) t3 AS post_token_balance
  WHERE
    block_date >= (CURRENT_DATE - '30 days'::INTERVAL)
    AND ARRAY_CONTAINS(account_keys,
      ""7LFnr5YgUyEgPMCLGNQ9N7wM5MFRNqCuRawLZTe5q4c7"")
    -- AND id = ""5iVHcnNWN9DDJe7T5JkAC43dgAkT1oZvDPqX9WhE4mcjGDayjtiVGDjBYfB92Rpj9L5uq4p19nob4ebSFhV4CNoz""
    AND account = ""7LFnr5YgUyEgPMCLGNQ9N7wM5MFRNqCuRawLZTe5q4c7""
    AND pre_token_balance.account = account
    AND post_token_balance.account = account
    AND error IS NULL
    AND pre_token_balance.mint = ""EPjFWdd5AufqSSqeM2qN1xzybapC8G4wEGGkZwyTDt1v""
    AND post_token_balance.mint = ""EPjFWdd5AufqSSqeM2qN1xzybapC8G4wEGGkZwyTDt1v""
    -- AND (pre_token_balance.amount - post_token_balance.amount) > 0 
),
  daily_withdraw_usdc AS(
  SELECT
    block_date,
    SUM(pre_amount - post_amount) AS withdraw_usdc_amount
  FROM
    usdc_orca_pool_tran
  WHERE pre_amount > post_amount
  GROUP BY
    block_date
),
--   daily_large_withdraw_usdc AS(
--   SELECT
--     block_date,
--     SUM(pre_amount - post_amount) AS withdraw_usdc_amount
--   FROM
--     usdc_orca_pool_tran
--   WHERE pre_amount - post_amount >= 10000
--   GROUP BY
--     block_date
-- ),
  daily_deposit_usdc AS(
  SELECT
    block_date,
    SUM(post_amount - pre_amount) AS deposit_usdc_amount
  FROM
    usdc_orca_pool_tran
  WHERE pre_amount < post_amount
  GROUP BY
    block_date
),
--   daily_large_deposit_usdc AS(
--   SELECT
--     block_date,
--     SUM(post_amount - pre_amount) AS deposit_usdc_amount
--   FROM
--     usdc_orca_pool_tran
--   WHERE post_amount - pre_amount >= 10000
--   GROUP BY
--     block_date
-- ),
usdc_in_pool AS (
SELECT
    block_date,
    amount
FROM (
    SELECT 
        block_date, 
        post_token_balance.amount as amount,
        row_number() over (partition by block_date order by block_time DESC) as r
    FROM
        `solana`.`transactions` 
        LATERAL VIEW explode(account_keys) t1 AS account 
        LATERAL VIEW explode(pre_token_balances) t2 AS pre_token_balance 
        LATERAL VIEW explode(post_token_balances) t3 AS post_token_balance
      WHERE
        block_date >= (CURRENT_DATE - '30 days'::INTERVAL)
        AND ARRAY_CONTAINS(account_keys,
          ""7LFnr5YgUyEgPMCLGNQ9N7wM5MFRNqCuRawLZTe5q4c7"")
        -- AND id = ""5iVHcnNWN9DDJe7T5JkAC43dgAkT1oZvDPqX9WhE4mcjGDayjtiVGDjBYfB92Rpj9L5uq4p19nob4ebSFhV4CNoz""
        AND account = ""7LFnr5YgUyEgPMCLGNQ9N7wM5MFRNqCuRawLZTe5q4c7""
        AND pre_token_balance.account = account
        AND post_token_balance.account = account
        AND error IS NULL
        AND pre_token_balance.mint = ""EPjFWdd5AufqSSqeM2qN1xzybapC8G4wEGGkZwyTDt1v""
        AND post_token_balance.mint = ""EPjFWdd5AufqSSqeM2qN1xzybapC8G4wEGGkZwyTDt1v""
    )
    where r = 1
    ORDER BY 
        block_date desc
)

-- #########################################################################################
-- START --------- 此SQL查出每日中只有单条198GST以上的交易用户，为异常交易
-- #########################################################################################


, trade_gst_sum (
-- 只有一条在ORCA池买卖GST的记录
  SELECT 
    signer,
    FIRST(IF(inner_instruction.account_arguments[0] = '9r39vqrJuubgafaJ5aQyDWYAUQVJeyZyveBXeRqp7xev',
    inner_instruction.account_arguments[1],
    inner_instruction.account_arguments[0])) AS gst_account,
    MIN(block_time) AS block_time,
    MIN(block_date) AS block_date,
    -- date_part('day', MAX(block_date) - MIN(block_date)) + 1 as day_cnt,
    SUM(IF(post_token_balance.amount - pre_token_balance.amount > 0, 
            post_token_balance.amount - pre_token_balance.amount, 
            0)) as buy_gst_amount,
    -- 0 as buy_gst_amount,
    SUM(-IF(post_token_balance.amount - pre_token_balance.amount < 0, 
            post_token_balance.amount - pre_token_balance.amount, 
            0)) as sell_gst_amount,
    -- 0 as sell_gst_amount
    COUNT(signer) as cnt
  FROM
    solana.transactions
    LATERAL VIEW explode(instructions) i1 AS instruction 
    LATERAL VIEW explode(instruction.inner_instructions) ii1 AS inner_instruction 
    LATERAL VIEW explode(pre_token_balances) p1 AS pre_token_balance 
    LATERAL VIEW explode(post_token_balances) p2 AS post_token_balance 
  WHERE
    block_date >= (CURRENT_DATE - '14 days'::INTERVAL)
    AND block_date <= CURRENT_DATE
    AND ARRAY_CONTAINS(account_keys,""9r39vqrJuubgafaJ5aQyDWYAUQVJeyZyveBXeRqp7xev"")
    AND inner_instruction.executing_account = 'TokenkegQfeZyiNwAJbNbGKPFXCWuBvf9Ss623VQ5DA'
    AND 
        (
            (
                inner_instruction.account_arguments[0] = ""9r39vqrJuubgafaJ5aQyDWYAUQVJeyZyveBXeRqp7xev""
                AND
                pre_token_balance.account = inner_instruction.account_arguments[1]
            )
            OR
            (
                inner_instruction.account_arguments[1] = ""9r39vqrJuubgafaJ5aQyDWYAUQVJeyZyveBXeRqp7xev""
                AND
                pre_token_balance.account = inner_instruction.account_arguments[0]
            )
        )
    AND SIZE(inner_instruction.account_arguments) = 3
    AND pre_token_balance.account = post_token_balance.account
    AND error IS NULL
    GROUP BY signer
    HAVING sell_gst_amount > 198 OR buy_gst_amount > 198
    
    -- LIMIT 100
)

, last_week_signer as (

-- 没有任何与STEPN帐户或ORCA池交易的记录，注意可以多一条将USDC转回STEPN的记录

    SELECT 
        signer, 
        COUNT(signer) as cnt, 
        MIN(block_time) as first_tran_time
    FROM solana.transactions
    WHERE block_date <= CURRENT_DATE
        AND block_date > (CURRENT_DATE - '21 days'::INTERVAL)
    GROUP BY signer
    HAVING cnt <= 2
)

, create_gst_account_tran AS (
    SELECT 
        id,
        block_time,
        signer,
        instruction.account_arguments[0] AS creater,
        instruction.account_arguments[1] AS gst_account
    FROM
        solana.transactions
        LATERAL VIEW explode(instructions) i1 AS instruction 
    WHERE
        block_date <= CURRENT_DATE
        AND block_date > (CURRENT_DATE - '21 days'::INTERVAL)
        AND instruction.executing_account = ""ATokenGPvbdGVxr1b2hvZbsiqW5xWH25efTNsLJA8knL""
        AND instruction.account_arguments[3] = ""AFbX8oGjGpmVFywbVouvhQSRmiW2aR1mohfahi4Y2AdB""
)

, trade_gst_sum_2 AS (
    SELECT 
        trade_gst_sum.signer as signer,
        trade_gst_sum.gst_account as gst_account,
        create_gst_account_tran.block_time as create_gst_account_time,
        create_gst_account_tran.creater as creater,
        trade_gst_sum.block_time as trade_gst_time,
        trade_gst_sum.block_date as trade_gst_date,
        trade_gst_sum.buy_gst_amount as buy_gst_amount,
        trade_gst_sum.sell_gst_amount as sell_gst_amount,
        trade_gst_sum.cnt as trade_cnt
    FROM trade_gst_sum JOIN create_gst_account_tran
    ON
        trade_gst_sum.gst_account = create_gst_account_tran.gst_account 
    WHERE
        trade_gst_sum.cnt = 1 
)

, trade_gst_sum_3 as (
    SELECT 
        trade_gst_sum_2.signer,
        trade_gst_sum_2.gst_account,
        trade_gst_sum_2.create_gst_account_time,
        trade_gst_sum_2.creater,
        trade_gst_sum_2.trade_gst_time,
        trade_gst_sum_2.trade_gst_date,
        trade_gst_sum_2.buy_gst_amount,
        trade_gst_sum_2.sell_gst_amount,
        trade_gst_sum_2.trade_cnt
    FROM trade_gst_sum_2 JOIN last_week_signer
    ON trade_gst_sum_2.signer = last_week_signer.signer
WHERE 
    last_week_signer.cnt <= 2
    AND (last_week_signer.first_tran_time < trade_gst_sum_2.create_gst_account_time OR last_week_signer.first_tran_time >= trade_gst_sum_2.trade_gst_time)
ORDER BY trade_gst_sum_2.sell_gst_amount, trade_gst_sum_2.buy_gst_amount
) 

, stepn_auto_control_machine as (
SELECT 
    trade_gst_date as block_date,
    SUM(buy_gst_amount) * 4.5 AS large_deposit_usdc_amount,
    SUM(sell_gst_amount) * 4.5 AS large_withdraw_usdc_amount
FROM
    trade_gst_sum_3
GROUP BY
    trade_gst_date
ORDER BY block_date DESC
)
-- #########################################################################################
-- END ------- 此SQL查出每日中只有单条198GST以上的交易用户，为异常交易
-- #########################################################################################


select 
usdc_in_pool.block_date AS block_date,
daily_withdraw_usdc.withdraw_usdc_amount AS withdraw_usdc_amount,
daily_deposit_usdc.deposit_usdc_amount AS deposit_usdc_amount,
-- daily_large_withdraw_usdc.withdraw_usdc_amount as large_withdraw_usdc_amount,
-- daily_large_deposit_usdc.deposit_usdc_amount as large_deposit_usdc_amount,
stepn_auto_control_machine.large_deposit_usdc_amount AS large_deposit_usdc_amount,
stepn_auto_control_machine.large_withdraw_usdc_amount AS large_withdraw_usdc_amount,
usdc_in_pool.amount AS post_amount
from 
    usdc_in_pool LEFT JOIN daily_withdraw_usdc ON usdc_in_pool.block_date == daily_withdraw_usdc.block_date
    LEFT JOIN daily_deposit_usdc ON usdc_in_pool.block_date == daily_deposit_usdc.block_date
    -- LEFT JOIN daily_large_withdraw_usdc ON usdc_in_pool.block_date == daily_large_withdraw_usdc.block_date
    -- LEFT JOIN daily_large_deposit_usdc ON usdc_in_pool.block_date == daily_large_deposit_usdc.block_date
    LEFT JOIN stepn_auto_control_machine ON usdc_in_pool.block_date == stepn_auto_control_machine.block_date
order by block_date desc"
554640,STEPN Spending总帐户每日出入金,,"WITH
deposit_table as (
    SELECT 
        block_date, 
        sum(pre_balances[0] - post_balances[0])/power(10,9) as deposit_sol
    FROM solana.transactions
    WHERE 
        block_date >= (CURRENT_DATE - '30 days'::INTERVAL)
        AND account_keys[1] = ""STEPNq2UGeGSzCyGVr2nMQAzf8xuejwqebd84wcksCK""
        AND size(account_keys) = 3
        AND error is NULL
    GROUP BY
        block_date
    ORDER BY 
        block_date desc
), 
large_deposit_table as (
    SELECT 
        block_date, 
        sum(pre_balances[0] - post_balances[0])/power(10,9) as large_deposit_sol
    FROM solana.transactions
    WHERE 
        block_date >= (CURRENT_DATE - '30 days'::INTERVAL)
        AND account_keys[1] = ""STEPNq2UGeGSzCyGVr2nMQAzf8xuejwqebd84wcksCK""
        AND size(account_keys) = 3
        AND ((pre_balances[0] - post_balances[0])/power(10,9)) > 500
        AND error is NULL
    GROUP BY
        block_date
    ORDER BY 
        block_date desc
), 
withdraw_table as (
SELECT 
    block_date, 
    sum(pre_balances[0] - post_balances[0])/power(10,9) as withdraw_sol
FROM solana.transactions
WHERE 
    block_date >= (CURRENT_DATE - '30 days'::INTERVAL)
    -- AND size(account_keys) = 3 
    AND account_keys[0] = ""STEPNq2UGeGSzCyGVr2nMQAzf8xuejwqebd84wcksCK""
    AND error is NULL
GROUP BY
    block_date
ORDER BY 
    block_date desc
),

large_withdraw_table as (
SELECT 
    block_date, 
    sum(pre_balances[0] - post_balances[0])/power(10,9) as large_withdraw_sol
FROM solana.transactions
WHERE 
    block_date >= (CURRENT_DATE - '30 days'::INTERVAL)
    -- AND size(account_keys) = 3 
    AND account_keys[0] = ""STEPNq2UGeGSzCyGVr2nMQAzf8xuejwqebd84wcksCK""
    AND ((pre_balances[0] - post_balances[0])/power(10,9)) > 500
    AND error is NULL
GROUP BY
    block_date
ORDER BY 
    block_date desc
),

tmp_table_1 as (
    SELECT deposit_table.block_date as block_date,
            deposit_table.deposit_sol as deposit_sol,
            withdraw_table.withdraw_sol as withdraw_sol
    FROM deposit_table, withdraw_table
    WHERE deposit_table.block_date = withdraw_table.block_date
    order by block_date desc
),

tmp_table_2 as (
    SELECT 
        tmp_table_1.block_date as block_date,
        tmp_table_1.deposit_sol as deposit_sol,
        tmp_table_1.withdraw_sol as withdraw_sol,
        large_deposit_table.large_deposit_sol as large_deposit_sol
    from tmp_table_1 
    LEFT JOIN large_deposit_table
    ON tmp_table_1.block_date = large_deposit_table.block_date
)

SELECT 
        tmp_table_2.block_date as block_date,
        tmp_table_2.block_date as groupby,
        tmp_table_2.deposit_sol as deposit_sol,
        tmp_table_2.withdraw_sol as withdraw_sol,
        tmp_table_2.large_deposit_sol as large_deposit_sol,
        large_withdraw_table.large_withdraw_sol as large_withdraw_sol
from tmp_table_2
LEFT JOIN large_withdraw_table
ON tmp_table_2.block_date = large_withdraw_table.block_date
ORDER BY block_date

    
"
563525,V1.0_GST流动性池加辙池统计,,"WITH
orca_gst_swap_pool_change as (
    SELECT
        id,
        block_date,
        orca_usdc_account,
        (orca_post_usdc_balance.amount - orca_pre_usdc_balance.amount) AS orca_usdc_change_amount,
        orca_gst_account,
        (orca_post_gst_balance.amount - orca_pre_gst_balance.amount) AS orca_gst_change_amount,
        user_usdc_account
    FROM
        solana.transactions
        LATERAL VIEW explode(account_keys) t1 AS orca_usdc_account
        LATERAL VIEW explode(pre_token_balances) t2 AS orca_pre_usdc_balance
        LATERAL VIEW explode(post_token_balances) t3 AS orca_post_usdc_balance
        LATERAL VIEW explode(account_keys) k1 AS orca_gst_account
        LATERAL VIEW explode(pre_token_balances) k2 AS orca_pre_gst_balance
        LATERAL VIEW explode(post_token_balances) k3 AS orca_post_gst_balance
        LATERAL VIEW explode(account_keys) k1 AS user_usdc_account
        LATERAL VIEW explode(pre_token_balances) k2 AS user_pre_usdc_balance
        LATERAL VIEW explode(post_token_balances) k3 AS user_post_usdc_balance
    WHERE
        block_date >= (CURRENT_DATE - '30 days'::INTERVAL)
        AND orca_usdc_account = ""7LFnr5YgUyEgPMCLGNQ9N7wM5MFRNqCuRawLZTe5q4c7""
        AND orca_pre_usdc_balance.account = orca_usdc_account
        AND orca_post_usdc_balance.account = orca_usdc_account
        AND orca_pre_usdc_balance.mint = ""EPjFWdd5AufqSSqeM2qN1xzybapC8G4wEGGkZwyTDt1v""
        AND orca_post_usdc_balance.mint = ""EPjFWdd5AufqSSqeM2qN1xzybapC8G4wEGGkZwyTDt1v""
        AND error IS NULL
        AND orca_gst_account = ""9r39vqrJuubgafaJ5aQyDWYAUQVJeyZyveBXeRqp7xev""
        AND orca_pre_gst_balance.account = orca_gst_account
        AND orca_post_gst_balance.account = orca_gst_account
        AND orca_pre_gst_balance.mint = ""AFbX8oGjGpmVFywbVouvhQSRmiW2aR1mohfahi4Y2AdB""
        AND orca_post_gst_balance.mint = ""AFbX8oGjGpmVFywbVouvhQSRmiW2aR1mohfahi4Y2AdB""     
        AND (orca_pre_usdc_balance.amount - orca_post_usdc_balance.amount) * (orca_pre_gst_balance.amount - orca_post_gst_balance.amount) > 0
        
        AND user_usdc_account <> ""7LFnr5YgUyEgPMCLGNQ9N7wM5MFRNqCuRawLZTe5q4c7""
        AND user_pre_usdc_balance.account = user_usdc_account
        AND user_post_usdc_balance.account = user_usdc_account
        AND user_pre_usdc_balance.mint = ""EPjFWdd5AufqSSqeM2qN1xzybapC8G4wEGGkZwyTDt1v""
        AND user_post_usdc_balance.mint = ""EPjFWdd5AufqSSqeM2qN1xzybapC8G4wEGGkZwyTDt1v""
        -- AND ARRAY_CONTAINS(account_keys,""7LFnr5YgUyEgPMCLGNQ9N7wM5MFRNqCuRawLZTe5q4c7"") -- orca usdc token account
        -- AND ARRAY_CONTAINS(account_keys,""9r39vqrJuubgafaJ5aQyDWYAUQVJeyZyveBXeRqp7xev"") -- orca gst token account
        -- AND ARRAY_CONTAINS(account_keys,""2PB12MfSMVpvrDt1ZeiEdKoGhfCML48msGUAP3u4zzHT"") -- user gst token account
        -- AND ARRAY_CONTAINS(account_keys,""3ER26bEj9YmWu8gLvgRy4jv2HwfSNgdX8wkuiuJnjN5f"") -- user usdc token account
        
),

  daily_withdraw_usdc AS(
  SELECT
    block_date,
    SUM(orca_usdc_change_amount) AS withdraw_usdc_amount
  FROM
    orca_gst_swap_pool_change
  WHERE orca_usdc_change_amount < 0
  GROUP BY
    block_date
),
  daily_deposit_usdc AS(
  SELECT
    block_date,
    SUM(orca_usdc_change_amount) AS deposit_usdc_amount
  FROM
    orca_gst_swap_pool_change
  WHERE orca_usdc_change_amount > 0
  GROUP BY
    block_date
),
usdc_in_pool AS (
SELECT
    block_date,
    amount
FROM (
    SELECT 
        block_date, 
        post_token_balance.amount as amount,
        row_number() over (partition by block_date order by block_time DESC) as r
    FROM
        `solana`.`transactions` 
        LATERAL VIEW explode(account_keys) t1 AS account 
        LATERAL VIEW explode(pre_token_balances) t2 AS pre_token_balance 
        LATERAL VIEW explode(post_token_balances) t3 AS post_token_balance
      WHERE
        block_date >= (CURRENT_DATE - '30 days'::INTERVAL)
        AND ARRAY_CONTAINS(account_keys,
          ""7LFnr5YgUyEgPMCLGNQ9N7wM5MFRNqCuRawLZTe5q4c7"")
        -- AND id = ""5iVHcnNWN9DDJe7T5JkAC43dgAkT1oZvDPqX9WhE4mcjGDayjtiVGDjBYfB92Rpj9L5uq4p19nob4ebSFhV4CNoz""
        AND account = ""7LFnr5YgUyEgPMCLGNQ9N7wM5MFRNqCuRawLZTe5q4c7""
        AND pre_token_balance.account = account
        AND post_token_balance.account = account
        AND error IS NULL
        AND pre_token_balance.mint = ""EPjFWdd5AufqSSqeM2qN1xzybapC8G4wEGGkZwyTDt1v""
        AND post_token_balance.mint = ""EPjFWdd5AufqSSqeM2qN1xzybapC8G4wEGGkZwyTDt1v""
    )
    where r = 1
    ORDER BY 
        block_date desc
)

SELECT pool.block_date AS block_date,
       wit.withdraw_usdc_amount AS withdraw_usdc_amount,
       dep.deposit_usdc_amount AS deposit_usdc_amount,
       pool.amount AS post_amount
FROM
    usdc_in_pool AS pool
    LEFT JOIN daily_withdraw_usdc AS wit ON pool.block_date = wit.block_date
    LEFT JOIN daily_deposit_usdc AS dep ON pool.block_date = dep.block_date
ORDER BY block_date DESC

-- select 
-- usdc_in_pool.block_date AS block_date,
-- daily_withdraw_usdc.withdraw_usdc_amount AS withdraw_usdc_amount,
-- daily_deposit_usdc.deposit_usdc_amount AS deposit_usdc_amount,
-- amount AS post_amount
-- from daily_withdraw_usdc, daily_deposit_usdc, usdc_in_pool
-- where usdc_in_pool.block_date == daily_withdraw_usdc.block_date
--     AND usdc_in_pool.block_date == daily_deposit_usdc.block_date
-- order by block_date desc"
557265,STEPN DAU,,"WITH 
orca_tran_table AS (
  SELECT 
    -- id,
    block_date,
    -- account,
    signer as user
    -- pre_token_balance,
    -- post_token_balance
    -- pre_token_balance.amount AS pre_amount, 
    -- post_token_balance.amount AS post_amount
  FROM
    solana.transactions 
    LATERAL VIEW explode(account_keys) t1 AS account 
    LATERAL VIEW explode(pre_token_balances) t2 AS pre_token_balance 
    LATERAL VIEW explode(post_token_balances) t3 AS post_token_balance
  WHERE
    block_date >= (CURRENT_DATE - '14 days'::INTERVAL)
    AND 
        (
            (
                ARRAY_CONTAINS(account_keys,""7LFnr5YgUyEgPMCLGNQ9N7wM5MFRNqCuRawLZTe5q4c7"")
                AND 
                account = ""7LFnr5YgUyEgPMCLGNQ9N7wM5MFRNqCuRawLZTe5q4c7""
            )
            OR
            (
                ARRAY_CONTAINS(account_keys,""DdBTJuiAXQQ7gLVXBXNPbVEG8g1avRxiJXhH5LhBytYW"")
                AND 
                account = ""DdBTJuiAXQQ7gLVXBXNPbVEG8g1avRxiJXhH5LhBytYW""
            )
        )
    AND pre_token_balance.account = account
    AND post_token_balance.account = account
    AND error IS NULL
    AND pre_token_balance.mint = ""EPjFWdd5AufqSSqeM2qN1xzybapC8G4wEGGkZwyTDt1v""
    AND post_token_balance.mint = ""EPjFWdd5AufqSSqeM2qN1xzybapC8G4wEGGkZwyTDt1v""
    -- AND (pre_token_balance.amount - post_token_balance.amount) > 0 --出金
    -- AND (pre_token_balance.amount - post_token_balance.amount) < 0 --入金
),
spendding_daily_deposit_user as (
    SELECT 
        block_date, 
        account_keys[0] AS user
    FROM solana.transactions
    WHERE 
        block_date >= (CURRENT_DATE - '14 days'::INTERVAL)
        AND account_keys[1] = ""STEPNq2UGeGSzCyGVr2nMQAzf8xuejwqebd84wcksCK""
        AND size(account_keys) = 3
        AND error is NULL
    ORDER BY 
        block_date desc
),
spendding_daily_withdraw_user as (
    SELECT 
        block_date, 
        account_keys[1] AS user
    FROM solana.transactions
    WHERE 
        block_date >= (CURRENT_DATE - '14 days'::INTERVAL)
        AND account_keys[0] = ""STEPNq2UGeGSzCyGVr2nMQAzf8xuejwqebd84wcksCK""
        AND size(account_keys) = 3
        AND error is NULL
    ORDER BY 
        block_date desc
),
owner_mapping_table AS (
  SELECT 
    distinct signer as owner,
    pre_token_balance.account as taccount
  FROM
    solana.transactions 
    LATERAL VIEW explode(pre_token_balances) t2 AS pre_token_balance 
  WHERE
    block_date >= (CURRENT_DATE - '14 days'::INTERVAL)
    AND 
    (
        (
            ARRAY_CONTAINS(account_keys,""HLS5Y68QSQgJP7wUbbbbCjEnMknVZrHXYDwwVaDcsdK7"")
            AND pre_token_balance.account <> ""HLS5Y68QSQgJP7wUbbbbCjEnMknVZrHXYDwwVaDcsdK7""
            AND pre_token_balance.mint = ""AFbX8oGjGpmVFywbVouvhQSRmiW2aR1mohfahi4Y2AdB""
        )
        OR
        (
            ARRAY_CONTAINS(account_keys,""HhXAKYmRzBNi7BjkDs2fbwJ49mnpWUtzyXEf8PAMArs4"")
            AND pre_token_balance.account <> ""HhXAKYmRzBNi7BjkDs2fbwJ49mnpWUtzyXEf8PAMArs4""
            AND pre_token_balance.mint = ""7i5KKsX2weiTkry7jA4ZwSuXGhs5eJBEjY8vVxR4pfRx""
        )
    )
    AND error IS NULL
    AND signer <> ""STEPNq2UGeGSzCyGVr2nMQAzf8xuejwqebd84wcksCK""
),
spendding_gst_daily_withdraw_user_raw AS (
  SELECT 
    block_date,
    post_token_balance.account as taccount
  FROM
    solana.transactions 
    LATERAL VIEW explode(post_token_balances) t3 AS post_token_balance
  WHERE
    block_date >= (CURRENT_DATE - '14 days'::INTERVAL)
    AND ARRAY_CONTAINS(account_keys,
      ""HLS5Y68QSQgJP7wUbbbbCjEnMknVZrHXYDwwVaDcsdK7"")
    AND post_token_balance.account <> ""HLS5Y68QSQgJP7wUbbbbCjEnMknVZrHXYDwwVaDcsdK7""
    AND error IS NULL
    AND post_token_balance.mint = ""AFbX8oGjGpmVFywbVouvhQSRmiW2aR1mohfahi4Y2AdB""
    AND signer = ""STEPNq2UGeGSzCyGVr2nMQAzf8xuejwqebd84wcksCK""
),

spendding_gst_daily_withdraw_user AS (
    SELECT 
        spendding_gst_daily_withdraw_user_raw.block_date,
        owner_mapping_table.owner as user
    FROM
        spendding_gst_daily_withdraw_user_raw
    JOIN
        owner_mapping_table
    ON
        spendding_gst_daily_withdraw_user_raw.taccount = owner_mapping_table.taccount
),
spendding_gst_daily_deposit_user AS (
  SELECT 
    block_date,
    signer as user
  FROM
    solana.transactions 
    LATERAL VIEW explode(pre_token_balances) t2 AS pre_token_balance 
  WHERE
    block_date >= (CURRENT_DATE - '14 days'::INTERVAL)
    AND ARRAY_CONTAINS(account_keys,
      ""HLS5Y68QSQgJP7wUbbbbCjEnMknVZrHXYDwwVaDcsdK7"")
    AND pre_token_balance.account <> ""HLS5Y68QSQgJP7wUbbbbCjEnMknVZrHXYDwwVaDcsdK7""
    AND error IS NULL
    AND pre_token_balance.mint = ""AFbX8oGjGpmVFywbVouvhQSRmiW2aR1mohfahi4Y2AdB""
    AND signer <> ""STEPNq2UGeGSzCyGVr2nMQAzf8xuejwqebd84wcksCK""
),

spendding_gmt_daily_withdraw_user_raw AS (
  SELECT 
    block_date,
    post_token_balance.account as taccount
  FROM
    solana.transactions 
    LATERAL VIEW explode(post_token_balances) t3 AS post_token_balance
  WHERE
    block_date >= (CURRENT_DATE - '14 days'::INTERVAL)
    AND ARRAY_CONTAINS(account_keys,
      ""HhXAKYmRzBNi7BjkDs2fbwJ49mnpWUtzyXEf8PAMArs4"")
    AND post_token_balance.account <> ""HhXAKYmRzBNi7BjkDs2fbwJ49mnpWUtzyXEf8PAMArs4""
    AND error IS NULL
    AND post_token_balance.mint = ""7i5KKsX2weiTkry7jA4ZwSuXGhs5eJBEjY8vVxR4pfRx""
    AND signer = ""STEPNq2UGeGSzCyGVr2nMQAzf8xuejwqebd84wcksCK""
),

spendding_gmt_daily_withdraw_user AS (
    SELECT 
        spendding_gmt_daily_withdraw_user_raw.block_date,
        owner_mapping_table.owner as user
    FROM
        spendding_gmt_daily_withdraw_user_raw
    JOIN
        owner_mapping_table
    ON
        spendding_gmt_daily_withdraw_user_raw.taccount = owner_mapping_table.taccount
),
spendding_gmt_daily_deposit_user AS (
  SELECT 
    block_date,
    signer as user
  FROM
    solana.transactions 
    LATERAL VIEW explode(pre_token_balances) t2 AS pre_token_balance 
  WHERE
    block_date >= (CURRENT_DATE - '14 days'::INTERVAL)
    AND ARRAY_CONTAINS(account_keys,
      ""HhXAKYmRzBNi7BjkDs2fbwJ49mnpWUtzyXEf8PAMArs4"")
    AND pre_token_balance.account <> ""HhXAKYmRzBNi7BjkDs2fbwJ49mnpWUtzyXEf8PAMArs4""
    AND error IS NULL
    AND pre_token_balance.mint = ""7i5KKsX2weiTkry7jA4ZwSuXGhs5eJBEjY8vVxR4pfRx""
    AND signer <> ""STEPNq2UGeGSzCyGVr2nMQAzf8xuejwqebd84wcksCK""
),


stepn_dau_raw as (
    SELECT * FROM orca_tran_table
    UNION all 
    SELECT * FROM spendding_daily_deposit_user
    UNION all
    SELECT * FROM spendding_daily_withdraw_user
    UNION all
    SELECT * FROM spendding_gst_daily_withdraw_user
    UNION all
    SELECT * FROM spendding_gst_daily_deposit_user
    UNION all
    SELECT * FROM spendding_gmt_daily_withdraw_user
    UNION all
    SELECT * FROM spendding_gmt_daily_deposit_user
),

stepn_dau_raw2 as (
    SELECT block_date, COUNT(distinct user) as DAU
    FROM stepn_dau_raw
    GROUP BY block_date
    ORDER BY block_date DESC
)

    SELECT 
        r2.block_date as block_date,
        r2.DAU as DAU,
        r3.DAU as lastDAU,
        IF (
            ((r2.DAU - r3.DAU) / r3.DAU * 100) < -20 AND r2.block_date > (CURRENT_DATE - '1 days'::INTERVAL),
            0,
            ((r2.DAU - r3.DAU) / r3.DAU * 100)
        ) as INCRATE
    FROM stepn_dau_raw2 r2 JOIN stepn_dau_raw2 r3
    ON r2.block_date = r3.block_date + '1 days'::INTERVAL
    WHERE r2.block_date >= (CURRENT_DATE - '13 days'::INTERVAL)
"
563893,V1.0_GMT流动性池加辙池统计,,"WITH
orca_gmt_swap_pool_change as (
    SELECT
        id,
        block_date,
        orca_usdc_account,
        (orca_post_usdc_balance.amount - orca_pre_usdc_balance.amount) AS orca_usdc_change_amount,
        orca_gmt_account,
        (orca_post_gmt_balance.amount - orca_pre_gmt_balance.amount) AS orca_gmt_change_amount,
        user_usdc_account
    FROM
        solana.transactions
        LATERAL VIEW explode(account_keys) t1 AS orca_usdc_account
        LATERAL VIEW explode(pre_token_balances) t2 AS orca_pre_usdc_balance
        LATERAL VIEW explode(post_token_balances) t3 AS orca_post_usdc_balance
        LATERAL VIEW explode(account_keys) k1 AS orca_gmt_account
        LATERAL VIEW explode(pre_token_balances) k2 AS orca_pre_gmt_balance
        LATERAL VIEW explode(post_token_balances) k3 AS orca_post_gmt_balance
        LATERAL VIEW explode(account_keys) k1 AS user_usdc_account
        LATERAL VIEW explode(pre_token_balances) k2 AS user_pre_usdc_balance
        LATERAL VIEW explode(post_token_balances) k3 AS user_post_usdc_balance
    WHERE
        block_date >= (CURRENT_DATE - '30 days'::INTERVAL)
        AND orca_usdc_account = ""DdBTJuiAXQQ7gLVXBXNPbVEG8g1avRxiJXhH5LhBytYW""
        AND orca_pre_usdc_balance.account = orca_usdc_account
        AND orca_post_usdc_balance.account = orca_usdc_account
        AND orca_pre_usdc_balance.mint = ""EPjFWdd5AufqSSqeM2qN1xzybapC8G4wEGGkZwyTDt1v""
        AND orca_post_usdc_balance.mint = ""EPjFWdd5AufqSSqeM2qN1xzybapC8G4wEGGkZwyTDt1v""
        AND error IS NULL
        AND orca_gmt_account = ""BTpvbpTArnekGgbXRqjfSvp7gENtHXvZCAwuUKQNYMeN""
        AND orca_pre_gmt_balance.account = orca_gmt_account
        AND orca_post_gmt_balance.account = orca_gmt_account
        AND orca_pre_gmt_balance.mint = ""7i5KKsX2weiTkry7jA4ZwSuXGhs5eJBEjY8vVxR4pfRx""
        AND orca_post_gmt_balance.mint = ""7i5KKsX2weiTkry7jA4ZwSuXGhs5eJBEjY8vVxR4pfRx""     
        AND (orca_pre_usdc_balance.amount - orca_post_usdc_balance.amount) * (orca_pre_gmt_balance.amount - orca_post_gmt_balance.amount) > 0
        
        AND user_usdc_account <> ""DdBTJuiAXQQ7gLVXBXNPbVEG8g1avRxiJXhH5LhBytYW""
        AND user_pre_usdc_balance.account = user_usdc_account
        AND user_post_usdc_balance.account = user_usdc_account
        AND user_pre_usdc_balance.mint = ""EPjFWdd5AufqSSqeM2qN1xzybapC8G4wEGGkZwyTDt1v""
        AND user_post_usdc_balance.mint = ""EPjFWdd5AufqSSqeM2qN1xzybapC8G4wEGGkZwyTDt1v""
        -- AND ARRAY_CONTAINS(account_keys,""7LFnr5YgUyEgPMCLGNQ9N7wM5MFRNqCuRawLZTe5q4c7"") -- orca usdc token account
        -- AND ARRAY_CONTAINS(account_keys,""9r39vqrJuubgafaJ5aQyDWYAUQVJeyZyveBXeRqp7xev"") -- orca gmt token account
        -- AND ARRAY_CONTAINS(account_keys,""2PB12MfSMVpvrDt1ZeiEdKoGhfCML48msGUAP3u4zzHT"") -- user gmt token account
        -- AND ARRAY_CONTAINS(account_keys,""3ER26bEj9YmWu8gLvgRy4jv2HwfSNgdX8wkuiuJnjN5f"") -- user usdc token account
        
),

  daily_withdraw_usdc AS(
  SELECT
    block_date,
    SUM(orca_usdc_change_amount) AS withdraw_usdc_amount
  FROM
    orca_gmt_swap_pool_change
  WHERE orca_usdc_change_amount < 0
  GROUP BY
    block_date
),
  daily_deposit_usdc AS(
  SELECT
    block_date,
    SUM(orca_usdc_change_amount) AS deposit_usdc_amount
  FROM
    orca_gmt_swap_pool_change
  WHERE orca_usdc_change_amount > 0
  GROUP BY
    block_date
),
usdc_in_pool AS (
SELECT
    block_date,
    amount
FROM (
    SELECT 
        block_date, 
        post_token_balance.amount as amount,
        row_number() over (partition by block_date order by block_time DESC) as r
    FROM
        `solana`.`transactions` 
        LATERAL VIEW explode(account_keys) t1 AS account 
        LATERAL VIEW explode(pre_token_balances) t2 AS pre_token_balance 
        LATERAL VIEW explode(post_token_balances) t3 AS post_token_balance
      WHERE
        block_date >= (CURRENT_DATE - '30 days'::INTERVAL)
        AND ARRAY_CONTAINS(account_keys,
          ""DdBTJuiAXQQ7gLVXBXNPbVEG8g1avRxiJXhH5LhBytYW"")
        -- AND id = ""5iVHcnNWN9DDJe7T5JkAC43dgAkT1oZvDPqX9WhE4mcjGDayjtiVGDjBYfB92Rpj9L5uq4p19nob4ebSFhV4CNoz""
        AND account = ""DdBTJuiAXQQ7gLVXBXNPbVEG8g1avRxiJXhH5LhBytYW""
        AND pre_token_balance.account = account
        AND post_token_balance.account = account
        AND error IS NULL
        AND pre_token_balance.mint = ""EPjFWdd5AufqSSqeM2qN1xzybapC8G4wEGGkZwyTDt1v""
        AND post_token_balance.mint = ""EPjFWdd5AufqSSqeM2qN1xzybapC8G4wEGGkZwyTDt1v""
    )
    where r = 1
    ORDER BY 
        block_date desc
)

-- SELECT 
--     tmp_table.block_date,
--     tmp_table.withdraw_usdc_amount,
--     daily_deposit_usdc.deposit_usdc_amount AS deposit_usdc_amount,
--     tmp_table.post_amount
-- FROM (
--     SELECT 
--         usdc_in_pool.block_date AS block_date,
--         daily_withdraw_usdc.withdraw_usdc_amount AS withdraw_usdc_amount,
--         usdc_in_pool.amount AS post_amount
--     FROM usdc_in_pool LEFT JOIN daily_withdraw_usdc
--     ON usdc_in_pool.block_date == daily_withdraw_usdc.block_date
-- ) AS tmp_table  LEFT JOIN daily_deposit_usdc
-- ON tmp_table.block_date == daily_deposit_usdc.block_date
-- order by tmp_table.block_date desc

select 
    usdc_in_pool.block_date AS block_date,
    daily_withdraw_usdc.withdraw_usdc_amount AS withdraw_usdc_amount,
    daily_deposit_usdc.deposit_usdc_amount AS deposit_usdc_amount,
    usdc_in_pool.amount AS post_amount
from usdc_in_pool LEFT JOIN daily_withdraw_usdc ON usdc_in_pool.block_date == daily_withdraw_usdc.block_date
LEFT JOIN daily_deposit_usdc ON usdc_in_pool.block_date == daily_deposit_usdc.block_date
order by block_date desc"
613948,V1.0_GMT池每日出入金统计,,"WITH 
usdc_orca_pool_tran AS (
  SELECT
    block_date,
    pre_token_balance.amount AS pre_amount, 
    post_token_balance.amount AS post_amount
  FROM
    `solana`.`transactions` 
    LATERAL VIEW explode(account_keys) t1 AS account 
    LATERAL VIEW explode(pre_token_balances) t2 AS pre_token_balance 
    LATERAL VIEW explode(post_token_balances) t3 AS post_token_balance
  WHERE
    block_date >= (CURRENT_DATE - '30 days'::INTERVAL)
    AND ARRAY_CONTAINS(account_keys,
      ""DdBTJuiAXQQ7gLVXBXNPbVEG8g1avRxiJXhH5LhBytYW"")
    -- AND id = ""5iVHcnNWN9DDJe7T5JkAC43dgAkT1oZvDPqX9WhE4mcjGDayjtiVGDjBYfB92Rpj9L5uq4p19nob4ebSFhV4CNoz""
    AND account = ""DdBTJuiAXQQ7gLVXBXNPbVEG8g1avRxiJXhH5LhBytYW""
    AND pre_token_balance.account = account
    AND post_token_balance.account = account
    AND error IS NULL
    AND pre_token_balance.mint = ""EPjFWdd5AufqSSqeM2qN1xzybapC8G4wEGGkZwyTDt1v""
    AND post_token_balance.mint = ""EPjFWdd5AufqSSqeM2qN1xzybapC8G4wEGGkZwyTDt1v""
    -- AND (pre_token_balance.amount - post_token_balance.amount) > 0 
),
  daily_withdraw_usdc AS(
  SELECT
    block_date,
    SUM(pre_amount - post_amount) AS withdraw_usdc_amount
  FROM
    usdc_orca_pool_tran
  WHERE pre_amount > post_amount
  GROUP BY
    block_date
),
  daily_large_withdraw_usdc AS(
  SELECT
    block_date,
    SUM(pre_amount - post_amount) AS withdraw_usdc_amount
  FROM
    usdc_orca_pool_tran
  WHERE pre_amount - post_amount >= 10000
  GROUP BY
    block_date
),
  daily_deposit_usdc AS(
  SELECT
    block_date,
    SUM(post_amount - pre_amount) AS deposit_usdc_amount
  FROM
    usdc_orca_pool_tran
  WHERE pre_amount < post_amount
  GROUP BY
    block_date
),
  daily_large_deposit_usdc AS(
  SELECT
    block_date,
    SUM(post_amount - pre_amount) AS deposit_usdc_amount
  FROM
    usdc_orca_pool_tran
  WHERE post_amount - pre_amount >= 10000
  GROUP BY
    block_date
),
usdc_in_pool AS (
SELECT
    block_date,
    amount
FROM (
    SELECT 
        block_date, 
        post_token_balance.amount as amount,
        row_number() over (partition by block_date order by block_time DESC) as r
    FROM
        `solana`.`transactions` 
        LATERAL VIEW explode(account_keys) t1 AS account 
        LATERAL VIEW explode(pre_token_balances) t2 AS pre_token_balance 
        LATERAL VIEW explode(post_token_balances) t3 AS post_token_balance
      WHERE
        block_date >= (CURRENT_DATE - '30 days'::INTERVAL)
        AND ARRAY_CONTAINS(account_keys,
          ""DdBTJuiAXQQ7gLVXBXNPbVEG8g1avRxiJXhH5LhBytYW"")
        -- AND id = ""5iVHcnNWN9DDJe7T5JkAC43dgAkT1oZvDPqX9WhE4mcjGDayjtiVGDjBYfB92Rpj9L5uq4p19nob4ebSFhV4CNoz""
        AND account = ""DdBTJuiAXQQ7gLVXBXNPbVEG8g1avRxiJXhH5LhBytYW""
        AND pre_token_balance.account = account
        AND post_token_balance.account = account
        AND error IS NULL
        AND pre_token_balance.mint = ""EPjFWdd5AufqSSqeM2qN1xzybapC8G4wEGGkZwyTDt1v""
        AND post_token_balance.mint = ""EPjFWdd5AufqSSqeM2qN1xzybapC8G4wEGGkZwyTDt1v""
    )
    where r = 1
    ORDER BY 
        block_date desc
)

select 
usdc_in_pool.block_date AS block_date,
daily_withdraw_usdc.withdraw_usdc_amount AS withdraw_usdc_amount,
daily_deposit_usdc.deposit_usdc_amount AS deposit_usdc_amount,
daily_large_withdraw_usdc.withdraw_usdc_amount as large_withdraw_usdc_amount,
daily_large_deposit_usdc.deposit_usdc_amount as large_deposit_usdc_amount,
usdc_in_pool.amount AS post_amount
from 
    usdc_in_pool LEFT JOIN daily_withdraw_usdc ON usdc_in_pool.block_date == daily_withdraw_usdc.block_date
    LEFT JOIN daily_deposit_usdc ON usdc_in_pool.block_date == daily_deposit_usdc.block_date
    LEFT JOIN daily_large_withdraw_usdc ON usdc_in_pool.block_date == daily_large_withdraw_usdc.block_date
    LEFT JOIN daily_large_deposit_usdc ON usdc_in_pool.block_date == daily_large_deposit_usdc.block_date
order by block_date desc"
783520,STEPN_SOLANA社区和生态基金（从Spending帐户中转出）,,"WITH
withdraw_table as (
SELECT 
    block_date, 
    SUM(post_balance - pre_balance)/power(10,9)  as withdraw_sol
FROM solana.transactions
    LATERAL VIEW explode(instructions) i1 AS instruction 
    LATERAL VIEW posexplode(account_keys) a1 AS account_key_idx, account_key
    LATERAL VIEW posexplode(pre_balances) p1 AS pre_balance_idx, pre_balance 
    LATERAL VIEW posexplode(post_balances) p2 AS post_balance_idx, post_balance 
WHERE 
    block_date >= (CURRENT_DATE - '5 days'::INTERVAL)
    AND ARRAY_CONTAINS(account_keys, ""STEPNq2UGeGSzCyGVr2nMQAzf8xuejwqebd84wcksCK"")
    AND instruction.executing_account = ""11111111111111111111111111111111""
    AND instruction.account_arguments[0] = ""STEPNq2UGeGSzCyGVr2nMQAzf8xuejwqebd84wcksCK""
    AND instruction.account_arguments[1] = account_key
    AND account_key_idx = pre_balance_idx
    AND account_key_idx = post_balance_idx
    AND account_key = ""Ffbor3Zx46oGPK59S7drZjcTSt8mygZGWc5qkcHLPtWV""
    AND ((pre_balance - post_balance) > 10000000 OR (pre_balance - post_balance) < -10000000)
    AND error is NULL
 GROUP BY
    block_date
)

SELECT * FROM withdraw_table"
783235,STEPN_BSC社区和生态基金（从Spending帐户转出）,,"WITH daily_bsc_withdraw_stepn AS (
SELECT
        -- block_time,
        hash,
        
        from,
        
        to,
        
        block_time + '8 hours'::INTERVAL AS fixed_block_time,
        
        date_trunc('day', block_time + '5 hours'::INTERVAL) + '3 hours'::INTERVAL AS fixed_block_date,
        
        round((value * pow(10, -18))) AS amount

    FROM
    `bnb`.`transactions`
    WHERE 
        block_time >= date_trunc('day', NOW() + '5 hours'::INTERVAL) - '28 days'::INTERVAL
        AND from = '0x6238872a0bd9f0e19073695532a7ed77ce93c69e'
        AND value > 0
        AND success = 'true'
        AND to = '0xb7d0749a64345552ef01ff54d6864202215a09a1'
)

SELECT * from daily_bsc_withdraw_stepn
ORDER BY amount DESC

"
647781,STEPN_BSC总帐户出入金分布（BNB),,"WITH
bsc_tran_raw AS (
    SELECT 
        date_trunc('day', block_time + '5 hours'::INTERVAL) + '3 hours'::INTERVAL AS fixed_block_date,
        CASE 
            WHEN from = '0x6238872a0bd9f0e19073695532a7ed77ce93c69e' 
            THEN to 
            ELSE from 
        END AS signer,
        CASE 
            WHEN from = '0x6238872a0bd9f0e19073695532a7ed77ce93c69e' 
            THEN -value 
            ELSE value 
        END AS value,
        CASE 
            WHEN from = '0x6238872a0bd9f0e19073695532a7ed77ce93c69e' 
            THEN 'withdraw' 
            ELSE 'deposit' 
        END AS tran_type
    FROM 
        `bnb`.`transactions`
    WHERE 
        block_time >= date_trunc('day', NOW() + '5 hours'::INTERVAL) - '28 days'::INTERVAL
        AND (from = '0x6238872a0bd9f0e19073695532a7ed77ce93c69e' 
            OR to = '0x6238872a0bd9f0e19073695532a7ed77ce93c69e')
        AND value > 0
        AND success = 'true'

)

, bsc_wit_dep_tran AS (
    SELECT 
        fixed_block_date,
        signer,
        SUM(value * pow(10, -18)) AS amount,
        tran_type,
        COUNT(*) as cnt
    FROM bsc_tran_raw
    GROUP BY signer, fixed_block_date, tran_type
)

, user_type_mapping AS (
    SELECT 
        signer,
        CASE 
            WHEN AVG(cnt) >= 16 THEN 'traders'
            WHEN SUM(cnt) = 1 
                AND (NOW() - '7 days'::INTERVAL < MIN(fixed_block_date)) 
                AND SUM(amount) < 50.0
                THEN 'fresh_meat'
            WHEN SUM(cnt) = 1 THEN 'inactive_user'
            ELSE 'normal_user'
        END AS user_type
    FROM bsc_wit_dep_tran
    GROUP BY signer
)

, bsc_tran_with_user_type AS (
    SELECT
        bsc_wit_dep_tran.fixed_block_date,
        bsc_wit_dep_tran.signer,
        bsc_wit_dep_tran.tran_type || '_' || user_type_mapping.user_type AS user_tran_type,
        bsc_wit_dep_tran.amount,
        bsc_wit_dep_tran.cnt
    FROM bsc_wit_dep_tran LEFT JOIN user_type_mapping
    ON bsc_wit_dep_tran.signer = user_type_mapping.signer
)

SELECT
    fixed_block_date,
    user_tran_type,
    round(SUM(amount)) AS amount
FROM
    bsc_tran_with_user_type
GROUP BY
    fixed_block_date, user_tran_type"
648336,STEPN BSC总帐户GST出入金分布统计,,"    
WITH
bsc_tran_raw AS (

    SELECT
    
        evt_block_time AS block_time,

        evt_block_time + '8 hours'::INTERVAL AS fixed_block_time,
   
        -- date_format(
        --     extract(year from (evt_block_time + '5 hours'::INTERVAL)) || '-' ||
        --     lpad(extract(month from (evt_block_time + '5 hours'::INTERVAL)) || '', 2, '0') || '-' ||
        --     lpad(extract(day from (evt_block_time + '5 hours'::INTERVAL)) || '', 2, '0') || ' ' ||
        --     '00:00:00'
        --     ,
        --     'yyyy-MM-dd HH:mm:ss'
        --     ) + '11 hours'::INTERVAL
        -- AS fixed_block_date,
        
        date_trunc('day', evt_block_time + INTERVAL '5 hours') + INTERVAL '3 hours' AS fixed_block_date,

        CASE 
            WHEN ""from"" = '\x6238872a0bd9f0e19073695532a7ed77ce93c69e' 
            THEN ""to"" 
            ELSE ""from"" 
        END AS signer,
        CASE 
            WHEN ""from"" = '\x6238872a0bd9f0e19073695532a7ed77ce93c69e' 
            THEN -value 
            ELSE value 
        END AS value,
        CASE 
            WHEN ""from"" = '\x6238872a0bd9f0e19073695532a7ed77ce93c69e' 
            THEN 'withdraw' 
            ELSE 'deposit' 
        END AS tran_type
FROM 
    bep20.""BEP20_evt_Transfer""
WHERE
    evt_block_time >= date_trunc('day', NOW() + INTERVAL '5 hours') - INTERVAL '28 days'
    AND evt_block_time >= '2022-04-20'
    AND (""from"" = '\x6238872a0bd9f0e19073695532a7ed77ce93c69e' 
        OR ""to"" = '\x6238872a0bd9f0e19073695532a7ed77ce93c69e')
    AND ""from"" <> '\x0000000000000000000000000000000000000000'
    AND ""to"" <> '\x0000000000000000000000000000000000000000'
    AND value > 0
    -- AND success = 'true'
    AND contract_address = '\x4a2c860cEC6471b9F5F5a336eB4F38bb21683c98'
)

, bsc_wit_dep_tran AS (
    SELECT 
        -- fixed_block_time,
        fixed_block_date,
        signer,
        SUM(value * 10^(-8)) AS amount,
        tran_type,
        COUNT(*) as cnt
    FROM bsc_tran_raw
    GROUP BY signer, fixed_block_date, tran_type
)

, user_type_mapping AS (
    SELECT 
        signer,
        CASE 
            WHEN AVG(cnt) >= 16 THEN 'traders'
            WHEN SUM(cnt) = 1 
                AND (NOW() - INTERVAL '7 days' < MIN(fixed_block_date)) 
                AND SUM(amount) < 200.0
                AND SUM(amount) > -200.0
                THEN 'fresh_meat'
            WHEN SUM(cnt) = 1 THEN 'inactive_user'
            ELSE 'normal_user'
        END AS user_type
    FROM bsc_wit_dep_tran
    GROUP BY signer
)

, bsc_tran_with_user_type AS (
    SELECT
        bsc_wit_dep_tran.fixed_block_date,
        bsc_wit_dep_tran.signer,
        bsc_wit_dep_tran.tran_type || '_' || user_type_mapping.user_type AS user_tran_type,
        bsc_wit_dep_tran.amount,
        bsc_wit_dep_tran.cnt
    FROM bsc_wit_dep_tran LEFT JOIN user_type_mapping
    ON bsc_wit_dep_tran.signer = user_type_mapping.signer
)

SELECT
    fixed_block_date,
    user_tran_type,
    ROUND(SUM(amount)) AS amount
FROM
    bsc_tran_with_user_type
GROUP BY
    fixed_block_date, user_tran_type"
648447,STEPN BSC在Pancake的GST池出入金分布统计,,"-- SELECT 
--     *
-- FROM 
--     bep20.""BEP20_evt_Transfer""
-- WHERE
--     evt_block_time >= CURRENT_DATE - '28 days'::INTERVAL
--     -- AND evt_block_time >= '2022-04-20'
--     AND (""from"" = '\x8584f46ee5c67a92e5cc4754a3a3289e42c83d12' 
--         OR ""to"" = '\x8584f46ee5c67a92e5cc4754a3a3289e42c83d12')
    

    
WITH
bsc_tran_raw AS (

    SELECT
        
        date_trunc('day', evt_block_time + INTERVAL '5 hours') + INTERVAL '3 hours' AS fixed_block_date,
        CASE 
            WHEN ""from"" = '\x09fe9db65c44b9610ab7dcd6853f887d2ade7e7f' 
            THEN ""to"" 
            ELSE ""from"" 
        END AS signer,
        CASE 
            WHEN ""from"" = '\x09fe9db65c44b9610ab7dcd6853f887d2ade7e7f' 
            THEN value * 10^(-8)
            ELSE -value * 10^(-8)
        END AS amount,
        CASE 
            WHEN ""from"" = '\x09fe9db65c44b9610ab7dcd6853f887d2ade7e7f' AND value  * 10^(-8) >= 1000
                THEN 'buy_trade' 
            WHEN ""from"" = '\x09fe9db65c44b9610ab7dcd6853f887d2ade7e7f' AND value  * 10^(-8) < 1000
                THEN 'buy_play' 
            WHEN ""to"" = '\x09fe9db65c44b9610ab7dcd6853f887d2ade7e7f' AND value  * 10^(-8) >= 200
                THEN 'sell_trade' 
            WHEN ""to"" = '\x09fe9db65c44b9610ab7dcd6853f887d2ade7e7f' AND value  * 10^(-8) < 200
                THEN 'sell_play' 
        END AS tran_type
FROM 
    bep20.""BEP20_evt_Transfer""
WHERE
    evt_block_time >= date_trunc('day', NOW() + INTERVAL '5 hours') - INTERVAL '28 days'
    AND evt_block_time >= '2022-04-12'
    AND (""from"" = '\x09fe9db65c44b9610ab7dcd6853f887d2ade7e7f' 
        OR ""to"" = '\x09fe9db65c44b9610ab7dcd6853f887d2ade7e7f')
    AND ""from"" <> '\x0000000000000000000000000000000000000000'
    AND ""to"" <> '\x0000000000000000000000000000000000000000'
    AND value > 0
    -- AND success = 'true'
    AND contract_address = '\x4a2c860cEC6471b9F5F5a336eB4F38bb21683c98'
)

, bsc_wit_dep_tran AS (
    SELECT 
        fixed_block_date,
        signer,
        SUM(amount) AS amount,
        tran_type,
        COUNT(*) as cnt
    FROM bsc_tran_raw
    GROUP BY signer, fixed_block_date, tran_type
)

, user_type_mapping AS (
    SELECT 
        signer,
        CASE 
            WHEN AVG(cnt) >= 16 THEN 'robot_traders'
            -- WHEN MAX(amount) > 1000.0
            --     OR MIN(amount) < -200.0
            --     THEN 'user_trader'
            -- WHEN SUM(cnt) = 1 
            --     AND (NOW() - INTERVAL '7 days' < MIN(fixed_block_date)) 
            --     AND AVG(amount) < 200.0
            --     AND AVG(amount) > -200.0
            --     THEN 'fresh_meat'
            -- WHEN SUM(cnt) = 1 THEN 'inactive_user'
            ELSE 'user'
        END AS user_type
    FROM bsc_wit_dep_tran
    GROUP BY signer
)

, bsc_tran_with_user_type AS (
    SELECT
        bsc_wit_dep_tran.fixed_block_date,
        bsc_wit_dep_tran.signer,
        user_type_mapping.user_type || '_' || bsc_wit_dep_tran.tran_type AS user_tran_type,
        bsc_wit_dep_tran.amount,
        bsc_wit_dep_tran.cnt
    FROM user_type_mapping JOIN bsc_wit_dep_tran
    ON bsc_wit_dep_tran.signer = user_type_mapping.signer
)

SELECT
    fixed_block_date,
    user_tran_type,
    SUM(amount) AS amount
FROM
    bsc_tran_with_user_type
GROUP BY
    fixed_block_date, user_tran_type"
649241,STEPN BSC在Pancake的GMT池出入金分布统计,,"

    
WITH
bsc_tran_raw AS (

    SELECT
        date_trunc('day', evt_block_time + INTERVAL '5 hours') + INTERVAL '3 hours' AS fixed_block_date,
        CASE 
            WHEN ""from"" = '\x007ec643c7cc33a70c083fc305c283dd009c8b94' 
            THEN ""to"" 
            ELSE ""from"" 
        END AS signer,
        CASE 
            WHEN ""from"" = '\x007ec643c7cc33a70c083fc305c283dd009c8b94' 
            THEN value 
            ELSE -value 
        END AS value,
        CASE 
            WHEN ""from"" = '\x007ec643c7cc33a70c083fc305c283dd009c8b94' 
            THEN 'buy' 
            ELSE 'sell' 
        END AS tran_type
FROM 
    bep20.""BEP20_evt_Transfer""
WHERE
    evt_block_time >= date_trunc('day', NOW() + INTERVAL '5 hours') - INTERVAL '28 days'
    AND evt_block_time >= '2022-04-12'
    AND (""from"" = '\x007ec643c7cc33a70c083fc305c283dd009c8b94' 
        OR ""to"" = '\x007ec643c7cc33a70c083fc305c283dd009c8b94')
    AND ""from"" <> '\x0000000000000000000000000000000000000000'
    AND ""to"" <> '\x0000000000000000000000000000000000000000'
    AND value > 0
    -- AND success = 'true'
    AND contract_address = '\x3019BF2a2eF8040C242C9a4c5c4BD4C81678b2A1'
)

, bsc_wit_dep_tran AS (
    SELECT 
        fixed_block_date,
        signer,
        SUM(value * 10^(-8)) AS amount,
        tran_type,
        COUNT(*) as cnt
    FROM bsc_tran_raw
    GROUP BY signer, fixed_block_date, tran_type
)

, user_type_mapping AS (
    SELECT 
        signer,
        CASE 
            WHEN AVG(cnt) >= 16 THEN 'traders'
            WHEN MAX(amount) > 10000.0
                OR MAX(amount) < -10000.0
                THEN 'big_user'
            WHEN SUM(cnt) = 1 
                AND (NOW() - INTERVAL '7 days' < MIN(fixed_block_date)) 
                AND AVG(amount) < 200.0
                AND AVG(amount) > -200.0
                THEN 'fresh_meat'
            WHEN SUM(cnt) = 1 THEN 'inactive_user'
            ELSE 'normal_user'
        END AS user_type
    FROM bsc_wit_dep_tran
    GROUP BY signer
)

, bsc_tran_with_user_type AS (
    SELECT
        bsc_wit_dep_tran.fixed_block_date,
        bsc_wit_dep_tran.signer,
        bsc_wit_dep_tran.tran_type || '_' || user_type_mapping.user_type AS user_tran_type,
        bsc_wit_dep_tran.amount,
        bsc_wit_dep_tran.cnt
    FROM bsc_wit_dep_tran LEFT JOIN user_type_mapping
    ON bsc_wit_dep_tran.signer = user_type_mapping.signer
)

SELECT
    fixed_block_date,
    user_tran_type,
    SUM(amount) AS amount
FROM
    bsc_tran_with_user_type
GROUP BY
    fixed_block_date, user_tran_type"
649294,STEPN BSC总帐户GMT出入金分布统计,,"    
WITH
bsc_tran_raw AS (

    SELECT
        date_trunc('day', evt_block_time + INTERVAL '5 hours') + INTERVAL '3 hours' AS fixed_block_date,
        CASE 
            WHEN ""from"" = '\x6238872a0bd9f0e19073695532a7ed77ce93c69e' 
            THEN ""to"" 
            ELSE ""from"" 
        END AS signer,
        CASE 
            WHEN ""from"" = '\x6238872a0bd9f0e19073695532a7ed77ce93c69e' 
            THEN -value 
            ELSE value 
        END AS value,
        CASE 
            WHEN ""from"" = '\x6238872a0bd9f0e19073695532a7ed77ce93c69e' 
            THEN 'withdraw' 
            ELSE 'deposit' 
        END AS tran_type
FROM 
    bep20.""BEP20_evt_Transfer""
WHERE
    evt_block_time >= date_trunc('day', NOW() + INTERVAL '5 hours') - INTERVAL '28 days'
    -- AND evt_block_time >= '2022-04-20'
    AND (""from"" = '\x6238872a0bd9f0e19073695532a7ed77ce93c69e' 
        OR ""to"" = '\x6238872a0bd9f0e19073695532a7ed77ce93c69e')
    AND ""from"" <> '\x0000000000000000000000000000000000000000'
    AND ""to"" <> '\x0000000000000000000000000000000000000000'
    AND value > 0
    -- AND success = 'true'
    AND contract_address = '\x3019BF2a2eF8040C242C9a4c5c4BD4C81678b2A1'
    -- AND contract_address = '\x4a2c860cEC6471b9F5F5a336eB4F38bb21683c98'
)

, bsc_wit_dep_tran AS (
    SELECT 
        fixed_block_date,
        signer,
        SUM(value * 10^(-8)) AS amount,
        tran_type,
        COUNT(*) as cnt
    FROM bsc_tran_raw
    GROUP BY signer, fixed_block_date, tran_type
)

, user_type_mapping AS (
    SELECT 
        signer,
        CASE 
            WHEN AVG(cnt) >= 16 THEN 'traders'
            WHEN SUM(cnt) = 1 
                AND (NOW() - INTERVAL '7 days' < MIN(fixed_block_date)) 
                AND SUM(amount) < 200.0
                AND SUM(amount) > -200.0
                THEN 'fresh_meat'
            WHEN SUM(cnt) = 1 THEN 'inactive_user'
            ELSE 'normal_user'
        END AS user_type
    FROM bsc_wit_dep_tran
    GROUP BY signer
)

, bsc_tran_with_user_type AS (
    SELECT
        bsc_wit_dep_tran.fixed_block_date,
        bsc_wit_dep_tran.signer,
        bsc_wit_dep_tran.tran_type || '_' || user_type_mapping.user_type AS user_tran_type,
        bsc_wit_dep_tran.amount,
        bsc_wit_dep_tran.cnt
    FROM bsc_wit_dep_tran LEFT JOIN user_type_mapping
    ON bsc_wit_dep_tran.signer = user_type_mapping.signer
)

SELECT
    fixed_block_date,
    user_tran_type,
    SUM(amount) AS amount
FROM
    bsc_tran_with_user_type
GROUP BY
    fixed_block_date, user_tran_type"
686865,STEPN_BSC_DAU,,"WITH daily_bsc_withdraw_stepn AS (
    SELECT 
        distinct
        date_trunc('day', block_time + INTERVAL '5 hours') + INTERVAL '3 hours' AS fixed_block_date,
        ""to"" AS signer
    FROM bsc.""transactions""
    WHERE 
        block_time >= date_trunc('day', NOW() + INTERVAL '5 hours') - INTERVAL '28 days'
        AND ""from"" = '\x6238872a0bd9f0e19073695532a7ed77ce93c69e'
        AND value > 0
        AND success = 'true'
    GROUP BY fixed_block_date, signer
)

, daily_bsc_deposit_stepn AS (
    SELECT 
        distinct
        date_trunc('day', block_time + INTERVAL '5 hours') + INTERVAL '3 hours' AS fixed_block_date,
        ""from"" AS signer
    FROM bsc.""transactions""
    WHERE 
        block_time >= date_trunc('day', NOW() + INTERVAL '5 hours') - INTERVAL '28 days'
        AND ""to"" = '\x6238872a0bd9f0e19073695532a7ed77ce93c69e'
        AND value > 0
        AND success = 'true'
    GROUP BY fixed_block_date, signer
)

, gst_dep_wit_tran AS (

    SELECT
        distinct
        date_trunc('day', evt_block_time + INTERVAL '5 hours') + INTERVAL '3 hours' AS fixed_block_date,
        CASE 
            WHEN ""from"" = '\x6238872a0bd9f0e19073695532a7ed77ce93c69e' 
            THEN ""to"" 
            ELSE ""from"" 
        END AS signer
    FROM 
        bep20.""BEP20_evt_Transfer""
    WHERE
        evt_block_time >= date_trunc('day', NOW() + INTERVAL '5 hours') - INTERVAL '28 days'
        AND evt_block_time >= '2022-04-20'
        AND (""from"" = '\x6238872a0bd9f0e19073695532a7ed77ce93c69e' 
            OR ""to"" = '\x6238872a0bd9f0e19073695532a7ed77ce93c69e')
        AND value > 0
        -- AND success = 'true'
        AND contract_address = '\x4a2c860cEC6471b9F5F5a336eB4F38bb21683c98'
    GROUP BY
        fixed_block_date, signer
)

, gmt_dep_wit_tran AS (

    SELECT
        distinct
        date_trunc('day', evt_block_time + INTERVAL '5 hours') + INTERVAL '3 hours' AS fixed_block_date,
        CASE 
            WHEN ""from"" = '\x6238872a0bd9f0e19073695532a7ed77ce93c69e' 
            THEN ""to"" 
            ELSE ""from"" 
        END AS signer
    FROM 
        bep20.""BEP20_evt_Transfer""
    WHERE
        evt_block_time >= date_trunc('day', NOW() + INTERVAL '5 hours') - INTERVAL '28 days'
        -- AND evt_block_time >= '2022-04-20'
        AND (""from"" = '\x6238872a0bd9f0e19073695532a7ed77ce93c69e' 
            OR ""to"" = '\x6238872a0bd9f0e19073695532a7ed77ce93c69e')
        AND value > 0
        -- AND success = 'true'
        AND contract_address = '\x3019BF2a2eF8040C242C9a4c5c4BD4C81678b2A1'
    GROUP BY
        fixed_block_date, signer
)


SELECT 
    fixed_block_date,
    count(signer)
FROM (
    SELECT * FROM daily_bsc_withdraw_stepn
    UNION
    SELECT * FROM daily_bsc_deposit_stepn
    UNION
    SELECT * FROM gst_dep_wit_tran
    UNION
    SELECT * FROM gmt_dep_wit_tran
) AS raw_table
GROUP BY fixed_block_date"
645939,STEPN_BSC总帐户出入金（BNB),,"WITH daily_bsc_withdraw_stepn AS (
SELECT
        -- block_time,
        
        -- block_time + '8 hours'::INTERVAL AS fixed_block_time,
        
        date_trunc('day', block_time + '5 hours'::INTERVAL) + '3 hours'::INTERVAL AS fixed_block_date,
        
        round(SUM(value * pow(10, -18))) AS amount,

        'withdraw' AS tran_type

    FROM
    `bnb`.`transactions`
    WHERE 
        block_time >= date_trunc('day', NOW() + '5 hours'::INTERVAL) - '28 days'::INTERVAL
        AND from = '0x6238872a0bd9f0e19073695532a7ed77ce93c69e'
        AND value > 0
        AND success = 'true'
    GROUP BY fixed_block_date
)

, daily_bsc_deposit_stepn AS (
    SELECT 
        date_trunc('day', block_time + '5 hours'::INTERVAL) + '3 hours'::INTERVAL AS fixed_block_date,
        
        round(SUM(value * pow(10, -18))) AS amount,

        'deposit' AS tran_type
    FROM 
    `bnb`.`transactions`
    WHERE 
        block_time >= date_trunc('day', NOW() + '5 hours'::INTERVAL) - '28 days'::INTERVAL
        AND to = '0x6238872a0bd9f0e19073695532a7ed77ce93c69e'
        AND value > 0
        AND success = 'true'
    GROUP BY fixed_block_date
)

SELECT * FROM daily_bsc_withdraw_stepn
UNION
SELECT * FROM daily_bsc_deposit_stepn"
565379,gst_day,stepn账户每日净存入gst,"with stepn_gst_record as -- 挑选出stepn账户gst的交易记录
(select *
,date_trunc('day',block_time+interval 8 hours) as utcadd8date
,post_token_balance.amount-pre_token_balance.amount as despoit_gst_amount
FROM solana.transactions 
LATERAL VIEW EXPLODE(pre_token_balances) t3 AS pre_token_balance
LATERAL VIEW EXPLODE(post_token_balances) t3 AS post_token_balance
WHERE block_date >= (CURRENT_DATE - '40 days'::INTERVAL)
and pre_token_balance.mint='AFbX8oGjGpmVFywbVouvhQSRmiW2aR1mohfahi4Y2AdB'
and post_token_balance.mint='AFbX8oGjGpmVFywbVouvhQSRmiW2aR1mohfahi4Y2AdB'
and pre_token_balance.account = ""HLS5Y68QSQgJP7wUbbbbCjEnMknVZrHXYDwwVaDcsdK7""
and post_token_balance.account = ""HLS5Y68QSQgJP7wUbbbbCjEnMknVZrHXYDwwVaDcsdK7""
and !ARRAY_CONTAINS(account_keys,""Em6bRim1AoV1BoEQxYmsGKmGT6Sft2NrFww1yKoozgLh"")
and !ARRAY_CONTAINS(log_messages,""Program log: Instruction: MintTo"")
and !ARRAY_CONTAINS(log_messages,""Program log: Instruction: Burn"")
AND error is NULL)

select utcadd8date,sum(despoit_gst_amount) as despoit_gst_amount
,sum(case when despoit_gst_amount>=0 then despoit_gst_amount else 0 end) as all_despoit_gst_amount
,sum(case when despoit_gst_amount<0 then -despoit_gst_amount else 0 end) as all_withdraw_gst_amount
from stepn_gst_record
group by utcadd8date

"
838865,stepn每日老用户付费比例,,"select a2.day ,1-a1.new_uid_num/a2.all_uid_num as rate
from

(select first_date,count(1) as new_uid_num from
    (
        select uid,date_trunc('day',min(block_time)+interval 8 hours) as first_date from
            (
            SELECT *,account_keys[0] as uid
            FROM solana.transactions
            WHERE 
            block_date >= '2022-01-01'
            AND account_keys[1] = ""STEPNq2UGeGSzCyGVr2nMQAzf8xuejwqebd84wcksCK""
            AND error is NULL
            )
        group by uid
    ) 
group by first_date) a1

join 

(select day,count(distinct account_keys[0]) as all_uid_num from
    (
    SELECT *,account_keys[0] as uid,date_trunc('day',block_time+interval 8 hours) as day
    FROM solana.transactions
    WHERE 
    block_date >= '2022-01-01'
    AND account_keys[1] = ""STEPNq2UGeGSzCyGVr2nMQAzf8xuejwqebd84wcksCK""
    AND error is NULL
    ) 
group by day) a2

on a1.first_date=a2.day

"
1062034,stepn_newuid_hour_eth,stepn每小时新增充值用户(eth链),"select first_hour,count(1) as new_uid_num from
    (
        select uid,min(block_time_add8) as first_hour from
            (
            SELECT *,""from"" as uid,date_trunc('hour',block_time+interval '8 hours') as block_time_add8
            from ethereum.""traces""
            where ""to""='\x6238872a0bd9f0e19073695532a7ed77ce93c69e'
            and value/power(10,18)>=0.1 and success=true
            ) t
        group by uid
    ) tt
where first_hour >= date_trunc('hour',now() - '48 hours'::INTERVAL)
group by first_hour"
1073468,gmt_all_bsc,stepn账户累计净存入gmt(bsc链),"with despoit_gmt as
(select sum(despoit_gmt) as despoit_gmt from
(
select date_trunc('day',evt_block_time+interval '8 hours') as utcadd8date,
value/power(10,9) as despoit_gmt 
from bep20.""BEP20_evt_Transfer"" 
where ""to""='\x6238872A0Bd9F0E19073695532a7Ed77ce93C69E'
and contract_address='\x3019bf2a2ef8040c242c9a4c5c4bd4c81678b2a1'
and ""from""!='\x0000000000000000000000000000000000000000'
) t
)
,withdraw_gmt as
(select sum(withdraw_gmt) as withdraw_gmt from
(
select date_trunc('day',evt_block_time+interval '8 hours') as utcadd8date,
value/power(10,9) as withdraw_gmt 
from bep20.""BEP20_evt_Transfer"" 
where ""from""='\x6238872A0Bd9F0E19073695532a7Ed77ce93C69E'
and contract_address='\x3019bf2a2ef8040c242c9a4c5c4bd4c81678b2a1'
and ""to""!='\x0000000000000000000000000000000000000000'
) t
)

select 
t1.despoit_gmt-t2.withdraw_gmt as despoit_gmt
from despoit_gmt t1
full outer join
withdraw_gmt t2
on 1=1
"
570563,gst_hour,stepn账户每小时净存入gst,"with stepn_gst_record as -- 挑选出stepn账户gst的交易记录
(select *,(block_time+interval '8 hours') as block_time_add8,
date_trunc('day',block_time+interval '8 hours') as utcadd8date,
post_token_balance.amount-pre_token_balance.amount as despoit_gst_amount
FROM `solana`.`transactions`
LATERAL VIEW EXPLODE(pre_token_balances) t3 AS pre_token_balance
LATERAL VIEW EXPLODE(post_token_balances) t3 AS post_token_balance
WHERE block_date >= (CURRENT_DATE - '7 days'::INTERVAL)
and pre_token_balance.mint='AFbX8oGjGpmVFywbVouvhQSRmiW2aR1mohfahi4Y2AdB'
and post_token_balance.mint='AFbX8oGjGpmVFywbVouvhQSRmiW2aR1mohfahi4Y2AdB'
and pre_token_balance.account = ""HLS5Y68QSQgJP7wUbbbbCjEnMknVZrHXYDwwVaDcsdK7""
and post_token_balance.account = ""HLS5Y68QSQgJP7wUbbbbCjEnMknVZrHXYDwwVaDcsdK7""
and !ARRAY_CONTAINS(account_keys,""Em6bRim1AoV1BoEQxYmsGKmGT6Sft2NrFww1yKoozgLh"")
and !ARRAY_CONTAINS(log_messages,""Program log: Instruction: MintTo"")
and !ARRAY_CONTAINS(log_messages,""Program log: Instruction: Burn"")
AND error is NULL)

select date_trunc('hour',block_time_add8) as hour,sum(despoit_gst_amount) as despoit_gst_amount
,sum(case when despoit_gst_amount>=0 then despoit_gst_amount else 0 end) as all_despoit_gst_amount
,sum(case when despoit_gst_amount<0 then -despoit_gst_amount else 0 end) as all_withdraw_gst_amount
from stepn_gst_record
where block_time_add8>=((select max(block_time_add8) from  stepn_gst_record)- '48 hours'::INTERVAL)
group by date_trunc('hour',block_time_add8)"
580504,gmt_day,stepn账户每日净存入gmt,"with stepn_gmt_record as -- 挑选出stepn账户gmt的交易记录
(select *
,date_trunc('day',block_time+interval 8 hours) as utcadd8date
,post_token_balance.amount-pre_token_balance.amount as despoit_gmt_amount
FROM solana.transactions 
LATERAL VIEW EXPLODE(pre_token_balances) t3 AS pre_token_balance
LATERAL VIEW EXPLODE(post_token_balances) t3 AS post_token_balance
WHERE block_date >= (CURRENT_DATE - '30 days'::INTERVAL)
and pre_token_balance.mint='7i5KKsX2weiTkry7jA4ZwSuXGhs5eJBEjY8vVxR4pfRx'
and post_token_balance.mint='7i5KKsX2weiTkry7jA4ZwSuXGhs5eJBEjY8vVxR4pfRx'
and pre_token_balance.account = ""HhXAKYmRzBNi7BjkDs2fbwJ49mnpWUtzyXEf8PAMArs4""
and post_token_balance.account = ""HhXAKYmRzBNi7BjkDs2fbwJ49mnpWUtzyXEf8PAMArs4""
and !ARRAY_CONTAINS(log_messages,""Program log: Instruction: Burn"")
and !ARRAY_CONTAINS(account_keys,""9bcQHj9S5sEwDeT9skmyHzaXx7mdy6E3Lsx9KfoKmdYD"")
AND error is NULL)

select utcadd8date,sum(despoit_gmt_amount) as despoit_gmt_amount
,sum(case when despoit_gmt_amount>=0 then despoit_gmt_amount else 0 end) as all_despoit_gmt_amount
,sum(case when despoit_gmt_amount<0 then -despoit_gmt_amount else 0 end) as all_withdraw_gmt_amount
from stepn_gmt_record
group by utcadd8date

"
1062153,gmt_daily_eth,stepn账户每日净存入gmt(eth链),"with despoit_gst as
(select utcadd8date,sum(despoit_gst) as despoit_gst from
(
select date_trunc('day',evt_block_time+interval '8 hours') as utcadd8date,
value/power(10,8) as despoit_gst 
from erc20.""ERC20_evt_Transfer""
where ""to""='\x6238872a0bd9f0e19073695532a7ed77ce93c69e'
and contract_address='\xe3c408BD53c31C085a1746AF401A4042954ff740'
and evt_block_time>=date_trunc('day', now())-'48 days'::INTERVAL
and ""from""!='\x0000000000000000000000000000000000000000'
) t
group by utcadd8date
)
,withdraw_gst as
(select utcadd8date,sum(withdraw_gst) as withdraw_gst from
(
select date_trunc('day',evt_block_time+interval '8 hours') as utcadd8date,
value/power(10,8) as withdraw_gst 
from erc20.""ERC20_evt_Transfer""
where ""from""='\x6238872a0bd9f0e19073695532a7ed77ce93c69e'
and contract_address='\xe3c408BD53c31C085a1746AF401A4042954ff740'
and evt_block_time>=date_trunc('day', now())-'48 days'::INTERVAL
and ""to""!='\x0000000000000000000000000000000000000000'
and ""to""!='\x776019ec6b3dee2b8fd4232cc70395a75e0eb0d2' -- 池子
) t
group by utcadd8date
)

select distinct coalesce(t1.utcadd8date,t2.utcadd8date) as utcadd8day,
coalesce(t1.despoit_gst,0) as despoit_gst_amount,
coalesce(t2.withdraw_gst,0) as withdraw_gst_amount,
coalesce(t1.despoit_gst,0)-coalesce(t2.withdraw_gst,0) as despoit_gst
from despoit_gst t1
full outer join
withdraw_gst t2
on t1.utcadd8date=t2.utcadd8date

"
618598,stepn_newuid_daily_bsc,stepn每日新增充值用户(bsc链),"select first_day,count(1) as new_uid_num from
    (
        select uid,min(block_time_add8) as first_day from
            (
            SELECT *,""from"" as uid,date_trunc('day',block_time+interval '8 hours') as block_time_add8
            from bsc.""traces""
            where ""to""='\x6238872A0Bd9F0E19073695532a7Ed77ce93C69E'
            and value>0
            ) t
        group by uid
    ) tt
group by first_day"
618640,stepn_newuid_hour_bsc,stepn每小时新增充值用户(bsc链),"select first_hour,count(1) as new_uid_num from
    (
        select uid,min(block_time_add8) as first_hour from
            (
            SELECT *,""from"" as uid,date_trunc('hour',block_time+interval '8 hours') as block_time_add8
            from bsc.""traces""
            where ""to""='\x6238872A0Bd9F0E19073695532a7Ed77ce93C69E'
            and value>0
            ) t
        group by uid
    ) tt
where first_hour >= date_trunc('hour',now() - '48 hours'::INTERVAL)
group by first_hour"
1072614,gst_all_eth,stepn账户累计净存入gst(eth链),"with despoit_gst as
(select sum(despoit_gst) as despoit_gst from
(
select date_trunc('day',evt_block_time+interval '8 hours') as utcadd8date,
value/power(10,8) as despoit_gst 
from erc20.""ERC20_evt_Transfer""
where ""to""='\x6238872a0bd9f0e19073695532a7ed77ce93c69e'
and contract_address='\x473037de59cf9484632f4a27b509cfe8d4a31404'
and evt_block_time>=date_trunc('day', now())-'48 days'::INTERVAL
and ""from""!='\x0000000000000000000000000000000000000000'
) t
)
,withdraw_gst as
(select sum(withdraw_gst) as withdraw_gst from
(
select date_trunc('day',evt_block_time+interval '8 hours') as utcadd8date,
value/power(10,8) as withdraw_gst 
from erc20.""ERC20_evt_Transfer""
where ""from""='\x6238872a0bd9f0e19073695532a7ed77ce93c69e'
and contract_address='\x473037de59cf9484632f4a27b509cfe8d4a31404'
and evt_block_time>=date_trunc('day', now())-'48 days'::INTERVAL
and ""to""!='\x0000000000000000000000000000000000000000'
and ""to""!='\x776019ec6b3dee2b8fd4232cc70395a75e0eb0d2' -- 池子
) t
)

select 
coalesce(t1.despoit_gst,0)-coalesce(t2.withdraw_gst,0) as despoit_gst
from despoit_gst t1
full outer join
withdraw_gst t2
on 1=1

"
1073464,gst_all_bsc,stepn账户累计净存入gst(bsc链),"with despoit_gst as
(select sum(despoit_gst) as despoit_gst from
(
select date_trunc('day',evt_block_time+interval '8 hours') as utcadd8date,
value/power(10,9) as despoit_gst 
from bep20.""BEP20_evt_Transfer""
where ""to""='\x6238872A0Bd9F0E19073695532a7Ed77ce93C69E'
and contract_address='\x4a2c860cec6471b9f5f5a336eb4f38bb21683c98'
and evt_block_time>=date_trunc('day', now())-'48 days'::INTERVAL
and ""from""!='\x0000000000000000000000000000000000000000'
) t
)
,withdraw_gst as
(select sum(withdraw_gst) as withdraw_gst from
(
select date_trunc('day',evt_block_time+interval '8 hours') as utcadd8date,
value/power(10,9) as withdraw_gst 
from bep20.""BEP20_evt_Transfer"" 
where ""from""='\x6238872A0Bd9F0E19073695532a7Ed77ce93C69E'
and contract_address='\x4a2c860cec6471b9f5f5a336eb4f38bb21683c98'
and evt_block_time>=date_trunc('day', now())-'48 days'::INTERVAL
and ""to""!='\x0000000000000000000000000000000000000000'
) t
)

select 
t1.despoit_gst-t2.withdraw_gst as despoit_gst
from despoit_gst t1
join
withdraw_gst t2
on 1=1
"
1062156,gmt_hour_eth,stepn账户每小时净存入gmt(eth链),"with despoit_gst as
(select date_trunc('hour',utcadd8date) as utcadd8hour,sum(despoit_gst) as despoit_gst from
(
select date_trunc('hour',evt_block_time+interval '8 hours') as utcadd8date,
value/power(10,8) as despoit_gst 
from erc20.""ERC20_evt_Transfer""
where ""to""='\x6238872a0bd9f0e19073695532a7ed77ce93c69e'
and contract_address='\xe3c408BD53c31C085a1746AF401A4042954ff740'
and evt_block_time>=date_trunc('hour', now())-'48 hours'::INTERVAL
and ""from""!='\x0000000000000000000000000000000000000000'
) t
group by date_trunc('hour',utcadd8date))
,withdraw_gst as
(select date_trunc('hour',utcadd8date) as utcadd8hour,sum(withdraw_gst) as withdraw_gst from
(
select date_trunc('hour',evt_block_time+interval '8 hours') as utcadd8date,
value/power(10,8) as withdraw_gst 
from erc20.""ERC20_evt_Transfer""
where ""from""='\x6238872a0bd9f0e19073695532a7ed77ce93c69e'
and contract_address='\xe3c408BD53c31C085a1746AF401A4042954ff740'
and evt_block_time>=date_trunc('hour', now())-'48 hours'::INTERVAL
and ""to""!='\x0000000000000000000000000000000000000000'
and ""to""!='\x776019ec6b3dee2b8fd4232cc70395a75e0eb0d2' -- 池子
) t
group by date_trunc('hour',utcadd8date))

select distinct coalesce(t1.utcadd8hour,t2.utcadd8hour) as utcadd8hour,
 coalesce(t1.despoit_gst,0) as despoit_gst_amount,
 coalesce(t2.withdraw_gst,0) as withdraw_gst_amount,
 coalesce(t1.despoit_gst,0)- coalesce(t2.withdraw_gst,0) as despoit_gst
from despoit_gst t1
full outer join
withdraw_gst t2
on t1.utcadd8hour=t2.utcadd8hour


"
1073428,stepn_uid_all_bsc,stepn累计充值用户(bsc链),"
SELECT count(distinct ""from"") as uid
from bsc.""traces""
where ""to""='\x6238872A0Bd9F0E19073695532a7Ed77ce93C69E'
and value>0
"
570611,stepn_newuid_hour,stepn每小时新增充值用户,"select first_hour,count(1) as new_uid_num from
    (
        select uid,min(block_time_add8) as first_hour from
            (
            SELECT *,account_keys[0] as uid,
            date_trunc('hour',block_time+interval '8 hours') as block_time_add8
            FROM `solana`.`transactions`
            WHERE 
            block_date >= '2022-02-01'
            AND account_keys[1] = ""STEPNq2UGeGSzCyGVr2nMQAzf8xuejwqebd84wcksCK""
            AND error is NULL
            ) t
        group by uid
    ) tt
where first_hour >= date_trunc('hour',now() - '48 hours'::INTERVAL)
group by first_hour"
1072625,stepn_uid_all_eth,stepn累计充值用户(eth链),"
SELECT 
count(distinct ""from"") as uid_num
from ethereum.""traces""
where ""to""='\x6238872a0bd9f0e19073695532a7ed77ce93c69e' 
and value/power(10,18)>=0.1 and success=true

-- select * from ethereum.traces limit 100
-- 0x3f691327267993cfe4842ca1364a52dfe6190ec1"
618354,gmt_day_bsc,stepn账户每日净存入gmt(bsc链),"with despoit_gmt as
(select utcadd8date,sum(despoit_gmt) as despoit_gmt from
(
select date_trunc('day',evt_block_time+interval '8 hours') as utcadd8date,
value/power(10,9) as despoit_gmt 
from bep20.""BEP20_evt_Transfer"" 
where ""to""='\x6238872A0Bd9F0E19073695532a7Ed77ce93C69E'
and contract_address='\x3019bf2a2ef8040c242c9a4c5c4bd4c81678b2a1'
and ""from""!='\x0000000000000000000000000000000000000000'
) t
group by utcadd8date)
,withdraw_gmt as
(select utcadd8date,sum(withdraw_gmt) as withdraw_gmt from
(
select date_trunc('day',evt_block_time+interval '8 hours') as utcadd8date,
value/power(10,9) as withdraw_gmt 
from bep20.""BEP20_evt_Transfer"" 
where ""from""='\x6238872A0Bd9F0E19073695532a7Ed77ce93C69E'
and contract_address='\x3019bf2a2ef8040c242c9a4c5c4bd4c81678b2a1'
and ""to""!='\x0000000000000000000000000000000000000000'
) t
group by utcadd8date)

select * from (
select distinct t1.utcadd8date as utcadd8date,
t1.despoit_gmt as despoit_gmt_amount,
t2.withdraw_gmt as withdraw_gmt_amount,
t1.despoit_gmt-t2.withdraw_gmt as despoit_gmt
from despoit_gmt t1
full outer join
withdraw_gmt t2
on t1.utcadd8date=t2.utcadd8date
) t 
order by utcadd8date desc limit 90
"
580541,gmt_hour,stepn账户每小时净存入gmt,"with stepn_gmt_record as -- 挑选出stepn账户gmt的交易记录
(select *,(block_time+interval '8 hours') as block_time_add8,
date_trunc('day',block_time+interval '8 hours') as utcadd8date,
post_token_balance.amount-pre_token_balance.amount as despoit_gmt_amount
FROM `solana`.`transactions`
LATERAL VIEW EXPLODE(pre_token_balances) t3 AS pre_token_balance
LATERAL VIEW EXPLODE(post_token_balances) t3 AS post_token_balance
WHERE block_date >= (CURRENT_DATE - '3 days'::INTERVAL)
and pre_token_balance.mint='7i5KKsX2weiTkry7jA4ZwSuXGhs5eJBEjY8vVxR4pfRx'
and post_token_balance.mint='7i5KKsX2weiTkry7jA4ZwSuXGhs5eJBEjY8vVxR4pfRx'
and pre_token_balance.account = ""HhXAKYmRzBNi7BjkDs2fbwJ49mnpWUtzyXEf8PAMArs4""
and post_token_balance.account = ""HhXAKYmRzBNi7BjkDs2fbwJ49mnpWUtzyXEf8PAMArs4""
and !ARRAY_CONTAINS(log_messages,""Program log: Instruction: Burn"")
and !ARRAY_CONTAINS(account_keys,""9bcQHj9S5sEwDeT9skmyHzaXx7mdy6E3Lsx9KfoKmdYD"")
AND error is NULL)

select date_trunc('hour',block_time_add8) as hour,sum(despoit_gmt_amount) as despoit_gmt_amount
,sum(case when despoit_gmt_amount>=0 then despoit_gmt_amount else 0 end) as all_despoit_gmt_amount
,sum(case when despoit_gmt_amount<0 then -despoit_gmt_amount else 0 end) as all_withdraw_gmt_amount
from stepn_gmt_record
where block_time_add8>=((select max(block_time_add8) from  stepn_gmt_record)- '48 hours'::INTERVAL)
group by date_trunc('hour',block_time_add8)"
618472,gmt_hour_bsc,stepn账户每小时净存入gmt(bsc链),"with despoit_gmt as
(select date_trunc('hour',utcadd8date) as utcadd8hour,sum(despoit_gmt) as despoit_gmt from
(
select date_trunc('hour',evt_block_time+interval '8 hours') as utcadd8date,
value/power(10,9) as despoit_gmt 
from bep20.""BEP20_evt_Transfer""
where ""to""='\x6238872A0Bd9F0E19073695532a7Ed77ce93C69E'
and contract_address='\x3019bf2a2ef8040c242c9a4c5c4bd4c81678b2a1'
and evt_block_time>=date_trunc('hour', now())-'48 hours'::INTERVAL
and ""from""!='\x0000000000000000000000000000000000000000'
) t
group by date_trunc('hour',utcadd8date))
,withdraw_gmt as
(select date_trunc('hour',utcadd8date) as utcadd8hour,sum(withdraw_gmt) as withdraw_gmt from
(
select date_trunc('hour',evt_block_time+interval '8 hours') as utcadd8date,
value/power(10,9) as withdraw_gmt 
from bep20.""BEP20_evt_Transfer"" 
where ""from""='\x6238872A0Bd9F0E19073695532a7Ed77ce93C69E'
and contract_address='\x3019bf2a2ef8040c242c9a4c5c4bd4c81678b2a1'
and evt_block_time>=date_trunc('hour', now())-'48 hours'::INTERVAL
and ""to""!='\x0000000000000000000000000000000000000000'
) t
group by date_trunc('hour',utcadd8date))

select distinct coalesce(t1.utcadd8hour,t2.utcadd8hour) as utcadd8hour,
t1.despoit_gmt as despoit_gmt_amount,
t2.withdraw_gmt as withdraw_gmt_amount,
t1.despoit_gmt-t2.withdraw_gmt as despoit_gmt
from despoit_gmt t1
full outer join
withdraw_gmt t2
on t1.utcadd8hour=t2.utcadd8hour
"
1072727,gmt_all_eth,stepn账户累计净存入gmt(eth链),"with despoit_gst as
(select sum(despoit_gst) as despoit_gst from
(
select date_trunc('day',evt_block_time+interval '8 hours') as utcadd8date,
value/power(10,8) as despoit_gst 
from erc20.""ERC20_evt_Transfer""
where ""to""='\x6238872a0bd9f0e19073695532a7ed77ce93c69e'
and contract_address='\xe3c408BD53c31C085a1746AF401A4042954ff740'
and evt_block_time>=date_trunc('day', now())-'48 days'::INTERVAL
and ""from""!='\x0000000000000000000000000000000000000000'
) t
)
,withdraw_gst as
(select sum(withdraw_gst) as withdraw_gst from
(
select date_trunc('day',evt_block_time+interval '8 hours') as utcadd8date,
value/power(10,8) as withdraw_gst 
from erc20.""ERC20_evt_Transfer""
where ""from""='\x6238872a0bd9f0e19073695532a7ed77ce93c69e'
and contract_address='\xe3c408BD53c31C085a1746AF401A4042954ff740'
and evt_block_time>=date_trunc('day', now())-'48 days'::INTERVAL
and ""to""!='\x0000000000000000000000000000000000000000'
and ""to""!='\x776019ec6b3dee2b8fd4232cc70395a75e0eb0d2' -- 池子
) t
)

select 
coalesce(t1.despoit_gst,0)-coalesce(t2.withdraw_gst,0) as despoit_gst
from despoit_gst t1
full outer join
withdraw_gst t2
on 1=1

"
618570,gst_hour_bsc,stepn账户每小时净存入gst(bsc链),"with despoit_gst as
(select date_trunc('hour',utcadd8date) as utcadd8hour,sum(despoit_gst) as despoit_gst from
(
select date_trunc('hour',evt_block_time+interval '8 hours') as utcadd8date,
value/power(10,9) as despoit_gst 
from bep20.""BEP20_evt_Transfer""
where ""to""='\x6238872A0Bd9F0E19073695532a7Ed77ce93C69E'
and contract_address='\x4a2c860cec6471b9f5f5a336eb4f38bb21683c98'
and evt_block_time>=date_trunc('hour', now())-'48 hours'::INTERVAL
and ""from""!='\x0000000000000000000000000000000000000000'
) t
group by date_trunc('hour',utcadd8date))
,withdraw_gst as
(select date_trunc('hour',utcadd8date) as utcadd8hour,sum(withdraw_gst) as withdraw_gst from
(
select date_trunc('hour',evt_block_time+interval '8 hours') as utcadd8date,
value/power(10,9) as withdraw_gst 
from bep20.""BEP20_evt_Transfer"" 
where ""from""='\x6238872A0Bd9F0E19073695532a7Ed77ce93C69E'
and contract_address='\x4a2c860cec6471b9f5f5a336eb4f38bb21683c98'
and evt_block_time>=date_trunc('hour', now())-'48 hours'::INTERVAL
and ""to""!='\x0000000000000000000000000000000000000000'
) t
group by date_trunc('hour',utcadd8date))

select distinct coalesce(t1.utcadd8hour,t2.utcadd8hour) as utcadd8hour,
t1.despoit_gst as despoit_gst_amount,
t2.withdraw_gst as withdraw_gst_amount,
t1.despoit_gst-t2.withdraw_gst as despoit_gst
from despoit_gst t1
join
withdraw_gst t2
on t1.utcadd8hour=t2.utcadd8hour


"
565355,stepn_newuid_day,stepn每日新增充值用户,"select first_date,count(1) as new_uid_num from
    (
        select uid,date_trunc('day',min(block_time)+interval 8 hours) as first_date from
            (
            SELECT *,account_keys[0] as uid
            FROM solana.transactions
            WHERE 
            block_date >= '2022-02-01'
            AND account_keys[1] = ""STEPNq2UGeGSzCyGVr2nMQAzf8xuejwqebd84wcksCK""
            AND error is NULL
            )
        group by uid
    ) 
group by first_date

"
1072757,stepn_uid_all,stepn累计充值用户（sol链）,"
SELECT count(distinct account_keys[0]) as uid
FROM solana.transactions
WHERE 
block_date >= '2022-01-01'
AND account_keys[1] = ""STEPNq2UGeGSzCyGVr2nMQAzf8xuejwqebd84wcksCK""
AND error is NULL


"
1072922,gst_all_day,stepn账户近60天净存入gst（sol链）,"
select 
sum(post_token_balance.amount-pre_token_balance.amount) as despoit_gst_amount
FROM solana.transactions 
LATERAL VIEW EXPLODE(pre_token_balances) t3 AS pre_token_balance
LATERAL VIEW EXPLODE(post_token_balances) t3 AS post_token_balance
WHERE block_date >= (CURRENT_DATE - '60 days'::INTERVAL)
and pre_token_balance.mint='AFbX8oGjGpmVFywbVouvhQSRmiW2aR1mohfahi4Y2AdB'
and post_token_balance.mint='AFbX8oGjGpmVFywbVouvhQSRmiW2aR1mohfahi4Y2AdB'
and pre_token_balance.account = ""HLS5Y68QSQgJP7wUbbbbCjEnMknVZrHXYDwwVaDcsdK7""
and post_token_balance.account = ""HLS5Y68QSQgJP7wUbbbbCjEnMknVZrHXYDwwVaDcsdK7""
and !ARRAY_CONTAINS(account_keys,""Em6bRim1AoV1BoEQxYmsGKmGT6Sft2NrFww1yKoozgLh"")
and !ARRAY_CONTAINS(log_messages,""Program log: Instruction: MintTo"")
and !ARRAY_CONTAINS(log_messages,""Program log: Instruction: Burn"")
AND error is NULL


"
1072990,gmt_all,stepn账户近60天净存入gmt,"select sum(post_token_balance.amount-pre_token_balance.amount) as despoit_gmt_amount
FROM solana.transactions 
LATERAL VIEW EXPLODE(pre_token_balances) t3 AS pre_token_balance
LATERAL VIEW EXPLODE(post_token_balances) t3 AS post_token_balance
WHERE block_date >= (CURRENT_DATE - '60 days'::INTERVAL)
and pre_token_balance.mint='7i5KKsX2weiTkry7jA4ZwSuXGhs5eJBEjY8vVxR4pfRx'
and post_token_balance.mint='7i5KKsX2weiTkry7jA4ZwSuXGhs5eJBEjY8vVxR4pfRx'
and pre_token_balance.account = ""HhXAKYmRzBNi7BjkDs2fbwJ49mnpWUtzyXEf8PAMArs4""
and post_token_balance.account = ""HhXAKYmRzBNi7BjkDs2fbwJ49mnpWUtzyXEf8PAMArs4""
and !ARRAY_CONTAINS(log_messages,""Program log: Instruction: Burn"")
and !ARRAY_CONTAINS(account_keys,""9bcQHj9S5sEwDeT9skmyHzaXx7mdy6E3Lsx9KfoKmdYD"")
AND error is NULL

"
1061798,gst_hour_eth,stepn账户每小时净存入gst(eth链),"with despoit_gst as
(select date_trunc('hour',utcadd8date) as utcadd8hour,sum(despoit_gst) as despoit_gst from
(
select date_trunc('hour',evt_block_time+interval '8 hours') as utcadd8date,
value/power(10,8) as despoit_gst 
from erc20.""ERC20_evt_Transfer""
where ""to""='\x6238872a0bd9f0e19073695532a7ed77ce93c69e'
and contract_address='\x473037de59cf9484632f4a27b509cfe8d4a31404'
and evt_block_time>=date_trunc('hour', now())-'48 hours'::INTERVAL
and ""from""!='\x0000000000000000000000000000000000000000'
) t
group by date_trunc('hour',utcadd8date))
,withdraw_gst as
(select date_trunc('hour',utcadd8date) as utcadd8hour,sum(withdraw_gst) as withdraw_gst from
(
select date_trunc('hour',evt_block_time+interval '8 hours') as utcadd8date,
value/power(10,8) as withdraw_gst 
from erc20.""ERC20_evt_Transfer""
where ""from""='\x6238872a0bd9f0e19073695532a7ed77ce93c69e'
and contract_address='\x473037de59cf9484632f4a27b509cfe8d4a31404'
and evt_block_time>=date_trunc('hour', now())-'48 hours'::INTERVAL
and ""to""!='\x0000000000000000000000000000000000000000'
and ""to""!='\x776019ec6b3dee2b8fd4232cc70395a75e0eb0d2' -- 池子
) t
group by date_trunc('hour',utcadd8date))

select distinct coalesce(t1.utcadd8hour,t2.utcadd8hour) as utcadd8hour,
 coalesce(t1.despoit_gst,0) as despoit_gst_amount,
 coalesce(t2.withdraw_gst,0) as withdraw_gst_amount,
 coalesce(t1.despoit_gst,0)- coalesce(t2.withdraw_gst,0) as despoit_gst
from despoit_gst t1
full outer join
withdraw_gst t2
on t1.utcadd8hour=t2.utcadd8hour


"
1061835,stepn_newuid_daily_eth,stepn每日新增充值用户(eth链),"select first_day,count(1) as new_uid_num
--,sum(active),sum(wtm)
,case when sum(active)=0 then 0 else round(cast(sum(active) as decimal(10,3))/count(1),2) end  as active_rate
,case when sum(wtm)=0 then 0 else  round(cast(sum(wtm)as decimal(10,3))/sum(active),2) end  as wtm_rate 
from
    (
    select distinct t1.*,coalesce(t2.active,0) as active,coalesce(t2.wtm,0) as wtm from
        (select uid,min(block_time_add8) as first_day from
            (
            SELECT *
            ,""from"" as uid
            ,date_trunc('day', block_time + '8 hours'::INTERVAL) as block_time_add8
            from ethereum.""traces""
            where ""to""='\x6238872a0bd9f0e19073695532a7ed77ce93c69e' 
            and value/power(10,18)>=0.01 and success=true
            ) t
        group by uid) t1
        
        left join
        
        dune_user_generated.stepn_eth_userprofile_gst t2
        on t1.uid=t2.address
    ) tt
    where first_day>='2022-07-01'
group by first_day


-- select * from ethereum.traces limit 100
-- 0x3f691327267993cfe4842ca1364a52dfe6190ec1"
948428,old_user_ratio,stepn每日新增充值用户(bsc链),"select distinct b.day,1-cast(a.new_uid_num as float)/cast(b.uid_num as float) as rate from
(select first_day,count(1) as new_uid_num from
    (
        select uid,min(block_time_add8) as first_day from
            (
            SELECT *,""from"" as uid,date_trunc('day',block_time+interval '8 hours') as block_time_add8
            from bsc.""traces""
            where ""to""='\x6238872A0Bd9F0E19073695532a7Ed77ce93C69E'
            and value>0
            ) t
        group by uid
    ) tt
group by first_day) a

join

(select date_trunc('day',block_time+interval '8 hours') as day,count(distinct ""from"") as uid_num
from bsc.""traces""
 where ""to""='\x6238872A0Bd9F0E19073695532a7Ed77ce93C69E'
            and value>0
group by date_trunc('day',block_time+interval '8 hours')) b 
on a.first_day = b.day"
618356,gst_daily_bsc,stepn账户每日净存入gst(bsc链),"with despoit_gst as
(select utcadd8date,sum(despoit_gst) as despoit_gst from
(
select date_trunc('day',evt_block_time+interval '8 hours') as utcadd8date,
value/power(10,9) as despoit_gst 
from bep20.""BEP20_evt_Transfer""
where ""to""='\x6238872A0Bd9F0E19073695532a7Ed77ce93C69E'
and contract_address='\x4a2c860cec6471b9f5f5a336eb4f38bb21683c98'
and evt_block_time>=date_trunc('day', now())-'48 days'::INTERVAL
and ""from""!='\x0000000000000000000000000000000000000000'
) t
group by utcadd8date)
,withdraw_gst as
(select utcadd8date,sum(withdraw_gst) as withdraw_gst from
(
select date_trunc('day',evt_block_time+interval '8 hours') as utcadd8date,
value/power(10,9) as withdraw_gst 
from bep20.""BEP20_evt_Transfer"" 
where ""from""='\x6238872A0Bd9F0E19073695532a7Ed77ce93C69E'
and contract_address='\x4a2c860cec6471b9f5f5a336eb4f38bb21683c98'
and evt_block_time>=date_trunc('day', now())-'48 days'::INTERVAL
and ""to""!='\x0000000000000000000000000000000000000000'
) t
group by utcadd8date)

select distinct coalesce(t1.utcadd8date,t2.utcadd8date) as utcadd8day,
t1.despoit_gst as despoit_gst_amount,
t2.withdraw_gst as withdraw_gst_amount,
t1.despoit_gst-t2.withdraw_gst as despoit_gst
from despoit_gst t1
join
withdraw_gst t2
on t1.utcadd8date=t2.utcadd8date
"
1061710,gst_daily_eth,stepn账户每日净存入gst(eth链),"with despoit_gst as
(select utcadd8date,sum(despoit_gst) as despoit_gst from
(
select date_trunc('day',evt_block_time+interval '8 hours') as utcadd8date,
value/power(10,8) as despoit_gst 
from erc20.""ERC20_evt_Transfer""
where ""to""='\x6238872a0bd9f0e19073695532a7ed77ce93c69e'
and contract_address='\x473037de59cf9484632f4a27b509cfe8d4a31404'
and evt_block_time>=date_trunc('day', now())-'48 days'::INTERVAL
and ""from""!='\x0000000000000000000000000000000000000000'
) t
group by utcadd8date)
,withdraw_gst as
(select utcadd8date,sum(withdraw_gst) as withdraw_gst from
(
select date_trunc('day',evt_block_time+interval '8 hours') as utcadd8date,
value/power(10,8) as withdraw_gst 
from erc20.""ERC20_evt_Transfer""
where ""from""='\x6238872a0bd9f0e19073695532a7ed77ce93c69e'
and contract_address='\x473037de59cf9484632f4a27b509cfe8d4a31404'
and evt_block_time>=date_trunc('day', now())-'48 days'::INTERVAL
and ""to""!='\x0000000000000000000000000000000000000000'
and ""to""!='\x776019ec6b3dee2b8fd4232cc70395a75e0eb0d2' -- 池子
) t
group by utcadd8date)

select distinct coalesce(t1.utcadd8date,t2.utcadd8date) as utcadd8day,
coalesce(t1.despoit_gst,0) as despoit_gst_amount,
coalesce(t2.withdraw_gst,0) as withdraw_gst_amount,
coalesce(t1.despoit_gst,0)-coalesce(t2.withdraw_gst,0) as despoit_gst
from despoit_gst t1
full outer join
withdraw_gst t2
on t1.utcadd8date=t2.utcadd8date

"
704489,新規/既存ユーザー数推移,,"SELECT
    new_users_table.time,
    new_users AS New,
    (unique_users - new_users) AS Existing
FROM (
    SELECT
        unique_users_table.time,
        COUNT(*) AS new_users
    FROM (
        SELECT 
            signer as unique_users,
            MIN(block_date) AS time
        FROM 
            solana.transactions
        WHERE
            block_date >= (CURRENT_DATE - '60 days'::INTERVAL)
            AND block_date < CURRENT_DATE
            AND account_keys[1] = ""STEPNq2UGeGSzCyGVr2nMQAzf8xuejwqebd84wcksCK""
            AND size(account_keys) = 3
            AND error is NULL
        GROUP BY 
            signer
    ) unique_users_table
    GROUP BY
        unique_users_table.time
    ) new_users_table

LEFT JOIN (
    SELECT
        block_date AS time,
        COUNT(DISTINCT signer) AS unique_users
    FROM 
        solana.transactions
    WHERE 
        block_date >= (CURRENT_DATE - '60 days'::INTERVAL)
        AND block_date < CURRENT_DATE
        AND account_keys[1] = ""STEPNq2UGeGSzCyGVr2nMQAzf8xuejwqebd84wcksCK""
        AND size(account_keys) = 3
        AND error is NULL
    GROUP BY 
        time
) table2 ON table2.time = new_users_table.time
ORDER BY
    1 DESC
"
710445,[SOL] デイリーアクティブユーザー数,,"

SELECT 
    block_date, 
    COUNT(distinct account_keys[0]) as active_users,
    COUNT(signer) as transactions, 
    COUNT(signer)/COUNT(distinct account_keys[0]) as trans_per_users, 
    ROUND((COUNT(signer) - LAG(COUNT(signer)) OVER(ORDER BY block_date ASC)) / LAG(COUNT(signer)) OVER(ORDER BY block_date ASC) * 100,2) AS growth_transactions,
    ROUND((COUNT(distinct account_keys[0]) - LAG(COUNT(distinct account_keys[0])) OVER(ORDER BY block_date ASC)) / LAG(COUNT(distinct account_keys[0])) OVER(ORDER BY block_date ASC) * 100,2) AS growth_users
FROM solana.transactions
WHERE 
    block_date >= (CURRENT_DATE - '30 days'::INTERVAL)
    AND block_date < CURRENT_DATE
    AND ( ARRAY_CONTAINS(account_keys,""STEPNq2UGeGSzCyGVr2nMQAzf8xuejwqebd84wcksCK"") -- Address deposit SOL from Wallet to Spending
    OR ARRAY_CONTAINS(account_keys,""HLS5Y68QSQgJP7wUbbbbCjEnMknVZrHXYDwwVaDcsdK7"") 
    OR ARRAY_CONTAINS(account_keys,""7i5KKsX2weiTkry7jA4ZwSuXGhs5eJBEjY8vVxR4pfRx"") 
    OR ARRAY_CONTAINS(account_keys,""AFbX8oGjGpmVFywbVouvhQSRmiW2aR1mohfahi4Y2AdB"") )
    AND error is NULL
GROUP BY
    block_date
ORDER BY 
    block_date desc"
706389,USDCの入出金推移,,"WITH 
usdc_orca_pool_tran AS (
  SELECT
    block_date,
    pre_token_balance.amount AS pre_amount, 
    post_token_balance.amount AS post_amount
  FROM
    `solana`.`transactions` 
    LATERAL VIEW explode(account_keys) t1 AS account 
    LATERAL VIEW explode(pre_token_balances) t2 AS pre_token_balance 
    LATERAL VIEW explode(post_token_balances) t3 AS post_token_balance
  WHERE
    block_date >= (CURRENT_DATE - '21 days'::INTERVAL)
    AND ARRAY_CONTAINS(account_keys,
      ""7LFnr5YgUyEgPMCLGNQ9N7wM5MFRNqCuRawLZTe5q4c7"")
    -- AND id = ""5iVHcnNWN9DDJe7T5JkAC43dgAkT1oZvDPqX9WhE4mcjGDayjtiVGDjBYfB92Rpj9L5uq4p19nob4ebSFhV4CNoz""
    AND account = ""7LFnr5YgUyEgPMCLGNQ9N7wM5MFRNqCuRawLZTe5q4c7""
    AND pre_token_balance.account = account
    AND post_token_balance.account = account
    AND error IS NULL
    AND pre_token_balance.mint = ""EPjFWdd5AufqSSqeM2qN1xzybapC8G4wEGGkZwyTDt1v""
    AND post_token_balance.mint = ""EPjFWdd5AufqSSqeM2qN1xzybapC8G4wEGGkZwyTDt1v""
    -- AND (pre_token_balance.amount - post_token_balance.amount) > 0 
),
  daily_withdraw_usdc AS(
  SELECT
    block_date,
    SUM(pre_amount - post_amount) AS withdraw_usdc_amount
  FROM
    usdc_orca_pool_tran
  WHERE pre_amount > post_amount
  GROUP BY
    block_date
),
  daily_large_withdraw_usdc AS(
  SELECT
    block_date,
    SUM(pre_amount - post_amount) AS withdraw_usdc_amount
  FROM
    usdc_orca_pool_tran
  WHERE pre_amount - post_amount >= 10000
  GROUP BY
    block_date
),
  daily_deposit_usdc AS(
  SELECT
    block_date,
    SUM(post_amount - pre_amount) AS deposit_usdc_amount
  FROM
    usdc_orca_pool_tran
  WHERE pre_amount < post_amount
  GROUP BY
    block_date
),
  daily_large_deposit_usdc AS(
  SELECT
    block_date,
    SUM(post_amount - pre_amount) AS deposit_usdc_amount
  FROM
    usdc_orca_pool_tran
  WHERE post_amount - pre_amount >= 10000
  GROUP BY
    block_date
),
usdc_in_pool AS (
SELECT
    block_date,
    amount
FROM (
    SELECT 
        block_date, 
        post_token_balance.amount as amount,
        row_number() over (partition by block_date order by block_time DESC) as r
    FROM
        `solana`.`transactions` 
        LATERAL VIEW explode(account_keys) t1 AS account 
        LATERAL VIEW explode(pre_token_balances) t2 AS pre_token_balance 
        LATERAL VIEW explode(post_token_balances) t3 AS post_token_balance
      WHERE
        block_date >= (CURRENT_DATE - '21 days'::INTERVAL)
        AND ARRAY_CONTAINS(account_keys,
          ""7LFnr5YgUyEgPMCLGNQ9N7wM5MFRNqCuRawLZTe5q4c7"")
        -- AND id = ""5iVHcnNWN9DDJe7T5JkAC43dgAkT1oZvDPqX9WhE4mcjGDayjtiVGDjBYfB92Rpj9L5uq4p19nob4ebSFhV4CNoz""
        AND account = ""7LFnr5YgUyEgPMCLGNQ9N7wM5MFRNqCuRawLZTe5q4c7""
        AND pre_token_balance.account = account
        AND post_token_balance.account = account
        AND error IS NULL
        AND pre_token_balance.mint = ""EPjFWdd5AufqSSqeM2qN1xzybapC8G4wEGGkZwyTDt1v""
        AND post_token_balance.mint = ""EPjFWdd5AufqSSqeM2qN1xzybapC8G4wEGGkZwyTDt1v""
    )
    where r = 1
    ORDER BY 
        block_date desc
)

select 
usdc_in_pool.block_date AS block_date,
daily_withdraw_usdc.withdraw_usdc_amount AS withdraw_usdc_amount,
daily_deposit_usdc.deposit_usdc_amount AS deposit_usdc_amount,
daily_large_withdraw_usdc.withdraw_usdc_amount as large_withdraw_usdc_amount,
daily_large_deposit_usdc.deposit_usdc_amount as large_deposit_usdc_amount,
usdc_in_pool.amount AS post_amount
from 
    usdc_in_pool LEFT JOIN daily_withdraw_usdc ON usdc_in_pool.block_date == daily_withdraw_usdc.block_date
    LEFT JOIN daily_deposit_usdc ON usdc_in_pool.block_date == daily_deposit_usdc.block_date
    LEFT JOIN daily_large_withdraw_usdc ON usdc_in_pool.block_date == daily_large_withdraw_usdc.block_date
    LEFT JOIN daily_large_deposit_usdc ON usdc_in_pool.block_date == daily_large_deposit_usdc.block_date
order by block_date desc"
705927,累計ユーザー数,,"SELECT 
    first_time,
    COUNT(distinct user_authority) AS new_users,
    SUM(COUNT(distinct user_authority)) OVER (ORDER BY first_time) as cumu_users
FROM (
    SELECT
        account_keys[0] AS user_authority,
        MIN(block_date) AS first_time
    FROM 
        solana.transactions
    WHERE 
        array_contains(account_keys, 'STEPNq2UGeGSzCyGVr2nMQAzf8xuejwqebd84wcksCK')
        AND block_date >= (CURRENT_DATE - '60 days'::INTERVAL)
        AND success = TRUE
    GROUP BY 
        user_authority
    ) 
GROUP BY 
    first_time"
704489,新規/既存ユーザー数推移,,"SELECT
    new_users_table.time,
    new_users AS New,
    (unique_users - new_users) AS Existing
FROM (
    SELECT
        unique_users_table.time,
        COUNT(*) AS new_users
    FROM (
        SELECT 
            signer as unique_users,
            MIN(block_date) AS time
        FROM 
            solana.transactions
        WHERE
            block_date >= (CURRENT_DATE - '60 days'::INTERVAL)
            AND block_date < CURRENT_DATE
            AND account_keys[1] = ""STEPNq2UGeGSzCyGVr2nMQAzf8xuejwqebd84wcksCK""
            AND size(account_keys) = 3
            AND error is NULL
        GROUP BY 
            signer
    ) unique_users_table
    GROUP BY
        unique_users_table.time
    ) new_users_table

LEFT JOIN (
    SELECT
        block_date AS time,
        COUNT(DISTINCT signer) AS unique_users
    FROM 
        solana.transactions
    WHERE 
        block_date >= (CURRENT_DATE - '60 days'::INTERVAL)
        AND block_date < CURRENT_DATE
        AND account_keys[1] = ""STEPNq2UGeGSzCyGVr2nMQAzf8xuejwqebd84wcksCK""
        AND size(account_keys) = 3
        AND error is NULL
    GROUP BY 
        time
) table2 ON table2.time = new_users_table.time
ORDER BY
    1 DESC
"
730622,Growth rate,,"SELECT
(((
    SELECT 
        COUNT(distinct account_keys[0]) as unique_deposit_accounts_1daysago
        
    FROM solana.transactions
    WHERE 
        block_date >= (CURRENT_DATE - '1 days'::INTERVAL)
        AND account_keys[1] = ""STEPNq2UGeGSzCyGVr2nMQAzf8xuejwqebd84wcksCK""
        AND size(account_keys) = 3
        AND error is NULL
        -- AND ARRAY_CONTAINS(account_keys, ""STEPNq2UGeGSzCyGVr2nMQAzf8xuejwqebd84wcksCK"")
    GROUP BY
        block_date
    ORDER BY 
        block_date asc
    LIMIT 1
) -
(
    SELECT 
        COUNT(distinct account_keys[0]) as unique_deposit_accounts_1daysago
        
    FROM solana.transactions
    WHERE 
        block_date >= (CURRENT_DATE - '2 days'::INTERVAL)
        AND account_keys[1] = ""STEPNq2UGeGSzCyGVr2nMQAzf8xuejwqebd84wcksCK""
        AND size(account_keys) = 3
        AND error is NULL
        -- AND ARRAY_CONTAINS(account_keys, ""STEPNq2UGeGSzCyGVr2nMQAzf8xuejwqebd84wcksCK"")
    GROUP BY
        block_date
    ORDER BY 
        block_date asc
    LIMIT 1
) ) / 
(
    SELECT 
        COUNT(distinct account_keys[0]) as unique_deposit_accounts_1daysago
        
    FROM solana.transactions
    WHERE 
        block_date >= (CURRENT_DATE - '2 days'::INTERVAL)
        AND account_keys[1] = ""STEPNq2UGeGSzCyGVr2nMQAzf8xuejwqebd84wcksCK""
        AND size(account_keys) = 3
        AND error is NULL
        -- AND ARRAY_CONTAINS(account_keys, ""STEPNq2UGeGSzCyGVr2nMQAzf8xuejwqebd84wcksCK"")
    GROUP BY
        block_date
    ORDER BY 
        block_date asc
    LIMIT 1
)*100
) as Daily_Growth_Rate



-- select * 
-- from solana.transactions
-- where 
-- block_date >= (CURRENT_DATE - '1 days'::INTERVAL)
-- AND ARRAY_CONTAINS(account_keys, ""36U6HnMCGtR5ViKZbeA27HDRzc7oNCftcW4GtTfVvA8Y"")
-- limit 10
-- SELECT
--     block_date,
--     account_keys,
--     instructions,
--     instruction
-- FROM solana.transactions
-- LATERAL VIEW explode(instructions) instructions AS instruction
-- WHERE
--     block_date >= (CURRENT_DATE - '1 days'::INTERVAL)
--     AND block_date < CURRENT_DATE
--     AND NOT ARRAY_CONTAINS(account_keys, ""Vote111111111111111111111111111111111111111"")
--     and account_keys[instruction['program_id_index']] = 'TokenkegQfeZyiNwAJbNbGKPFXCWuBvf9Ss623VQ5DA'
-- limit 10
-- SELECT
--     block_date
--     , SUM(CASE
--             WHEN account_keys[instruction['program_id_index']] = 'TokenkegQfeZyiNwAJbNbGKPFXCWuBvf9Ss623VQ5DA' THEN 1
--             ELSE 0
--         END) AS STEPN
-- FROM solana.transactions
-- LATERAL VIEW explode(instructions) instructions AS instruction
-- WHERE
--     block_date >= (CURRENT_DATE - '1 days'::INTERVAL)
--     AND block_date < CURRENT_DATE
--     AND NOT ARRAY_CONTAINS(account_keys, ""Vote111111111111111111111111111111111111111"")
--     and account_keys[instruction['program_id_index']] = 'TokenkegQfeZyiNwAJbNbGKPFXCWuBvf9Ss623VQ5DA'
-- GROUP BY 1
-- ORDER BY 1 DESC

-- SELECT
--     block_date
--     , SUM(CASE
--             WHEN account_keys[instruction['program_id_index']] = 'TokenkegQfeZyiNwAJbNbGKPFXCWuBvf9Ss623VQ5DA' THEN 1
--             ELSE 0
--         END) AS STEPN
-- FROM solana.transactions
-- LATERAL VIEW explode(instructions) instructions AS instruction
-- WHERE
--     block_date >= (CURRENT_DATE - '90 days'::INTERVAL)
--     AND block_date < CURRENT_DATE
--     AND NOT ARRAY_CONTAINS(account_keys, ""Vote111111111111111111111111111111111111111"")
--     and account_keys[instruction['program_id_index']] = 'TokenkegQfeZyiNwAJbNbGKPFXCWuBvf9Ss623VQ5DA'
-- GROUP BY 1
-- ORDER BY 1 DESC"
730527,Growth rate,,"SELECT
(((
    SELECT 
        COUNT(distinct account_keys[0]) as unique_deposit_accounts_1daysago
        
    FROM solana.transactions
    WHERE 
        block_date >= (CURRENT_DATE - '1 days'::INTERVAL)
        AND account_keys[1] = ""STEPNq2UGeGSzCyGVr2nMQAzf8xuejwqebd84wcksCK""
        AND size(account_keys) = 3
        AND error is NULL
        -- AND ARRAY_CONTAINS(account_keys, ""STEPNq2UGeGSzCyGVr2nMQAzf8xuejwqebd84wcksCK"")
    GROUP BY
        block_date
    ORDER BY 
        block_date asc
    LIMIT 1
) -
(
    SELECT 
        COUNT(distinct account_keys[0]) as unique_deposit_accounts_1daysago
        
    FROM solana.transactions
    WHERE 
        block_date >= (CURRENT_DATE - '8 days'::INTERVAL)
        AND account_keys[1] = ""STEPNq2UGeGSzCyGVr2nMQAzf8xuejwqebd84wcksCK""
        AND size(account_keys) = 3
        AND error is NULL
        -- AND ARRAY_CONTAINS(account_keys, ""STEPNq2UGeGSzCyGVr2nMQAzf8xuejwqebd84wcksCK"")
    GROUP BY
        block_date
    ORDER BY 
        block_date asc
    LIMIT 1
) ) / 
(
    SELECT 
        COUNT(distinct account_keys[0]) as unique_deposit_accounts_1daysago
        
    FROM solana.transactions
    WHERE 
        block_date >= (CURRENT_DATE - '8 days'::INTERVAL)
        AND account_keys[1] = ""STEPNq2UGeGSzCyGVr2nMQAzf8xuejwqebd84wcksCK""
        AND size(account_keys) = 3
        AND error is NULL
        -- AND ARRAY_CONTAINS(account_keys, ""STEPNq2UGeGSzCyGVr2nMQAzf8xuejwqebd84wcksCK"")
    GROUP BY
        block_date
    ORDER BY 
        block_date asc
    LIMIT 1
)*100
) as 7Days_Growth_Rate




-- select * 
-- from solana.transactions
-- where 
-- block_date >= (CURRENT_DATE - '1 days'::INTERVAL)
-- AND ARRAY_CONTAINS(account_keys, ""36U6HnMCGtR5ViKZbeA27HDRzc7oNCftcW4GtTfVvA8Y"")
-- limit 10
-- SELECT
--     block_date,
--     account_keys,
--     instructions,
--     instruction
-- FROM solana.transactions
-- LATERAL VIEW explode(instructions) instructions AS instruction
-- WHERE
--     block_date >= (CURRENT_DATE - '1 days'::INTERVAL)
--     AND block_date < CURRENT_DATE
--     AND NOT ARRAY_CONTAINS(account_keys, ""Vote111111111111111111111111111111111111111"")
--     and account_keys[instruction['program_id_index']] = 'TokenkegQfeZyiNwAJbNbGKPFXCWuBvf9Ss623VQ5DA'
-- limit 10
-- SELECT
--     block_date
--     , SUM(CASE
--             WHEN account_keys[instruction['program_id_index']] = 'TokenkegQfeZyiNwAJbNbGKPFXCWuBvf9Ss623VQ5DA' THEN 1
--             ELSE 0
--         END) AS STEPN
-- FROM solana.transactions
-- LATERAL VIEW explode(instructions) instructions AS instruction
-- WHERE
--     block_date >= (CURRENT_DATE - '1 days'::INTERVAL)
--     AND block_date < CURRENT_DATE
--     AND NOT ARRAY_CONTAINS(account_keys, ""Vote111111111111111111111111111111111111111"")
--     and account_keys[instruction['program_id_index']] = 'TokenkegQfeZyiNwAJbNbGKPFXCWuBvf9Ss623VQ5DA'
-- GROUP BY 1
-- ORDER BY 1 DESC

-- SELECT
--     block_date
--     , SUM(CASE
--             WHEN account_keys[instruction['program_id_index']] = 'TokenkegQfeZyiNwAJbNbGKPFXCWuBvf9Ss623VQ5DA' THEN 1
--             ELSE 0
--         END) AS STEPN
-- FROM solana.transactions
-- LATERAL VIEW explode(instructions) instructions AS instruction
-- WHERE
--     block_date >= (CURRENT_DATE - '90 days'::INTERVAL)
--     AND block_date < CURRENT_DATE
--     AND NOT ARRAY_CONTAINS(account_keys, ""Vote111111111111111111111111111111111111111"")
--     and account_keys[instruction['program_id_index']] = 'TokenkegQfeZyiNwAJbNbGKPFXCWuBvf9Ss623VQ5DA'
-- GROUP BY 1
-- ORDER BY 1 DESC"
705871,Users,,"SELECT
    COUNT(*) AS cumu_users
FROM 
    solana.transactions
WHERE 
    account_keys[0] = 'STEPNq2UGeGSzCyGVr2nMQAzf8xuejwqebd84wcksCK'
    AND size(account_keys) = 3
    AND block_date >= (CURRENT_DATE - '60 days'::INTERVAL)
    AND success = TRUE"
706352,SOL入出金推移,,"WITH
deposit_table as (
    SELECT 
        block_date, 
        sum(pre_balances[0] - post_balances[0])/power(10,9) as deposit_sol
    FROM solana.transactions
    WHERE 
        block_date >= (CURRENT_DATE - '14 days'::INTERVAL)
        AND account_keys[1] = ""STEPNq2UGeGSzCyGVr2nMQAzf8xuejwqebd84wcksCK""
        AND size(account_keys) = 3
        AND error is NULL
    GROUP BY
        block_date
    ORDER BY 
        block_date desc
), 
large_deposit_table as (
    SELECT 
        block_date, 
        sum(pre_balances[0] - post_balances[0])/power(10,9) as large_deposit_sol
    FROM solana.transactions
    WHERE 
        block_date >= (CURRENT_DATE - '14 days'::INTERVAL)
        AND account_keys[1] = ""STEPNq2UGeGSzCyGVr2nMQAzf8xuejwqebd84wcksCK""
        AND size(account_keys) = 3
        AND ((pre_balances[0] - post_balances[0])/power(10,9)) > 500
        AND error is NULL
    GROUP BY
        block_date
    ORDER BY 
        block_date desc
), 
withdraw_table as (
SELECT 
    block_date, 
    sum(pre_balances[0] - post_balances[0])/power(10,9) as withdraw_sol
FROM solana.transactions
WHERE 
    block_date >= (CURRENT_DATE - '14 days'::INTERVAL)
    -- AND size(account_keys) = 3 
    AND account_keys[0] = ""STEPNq2UGeGSzCyGVr2nMQAzf8xuejwqebd84wcksCK""
    AND error is NULL
GROUP BY
    block_date
ORDER BY 
    block_date desc
),

large_withdraw_table as (
SELECT 
    block_date, 
    sum(pre_balances[0] - post_balances[0])/power(10,9) as large_withdraw_sol
FROM solana.transactions
WHERE 
    block_date >= (CURRENT_DATE - '14 days'::INTERVAL)
    -- AND size(account_keys) = 3 
    AND account_keys[0] = ""STEPNq2UGeGSzCyGVr2nMQAzf8xuejwqebd84wcksCK""
    AND ((pre_balances[0] - post_balances[0])/power(10,9)) > 500
    AND error is NULL
GROUP BY
    block_date
ORDER BY 
    block_date desc
),

tmp_table_1 as (
    SELECT deposit_table.block_date as block_date,
            deposit_table.deposit_sol as deposit_sol,
            withdraw_table.withdraw_sol as withdraw_sol
    FROM deposit_table, withdraw_table
    WHERE deposit_table.block_date = withdraw_table.block_date
    order by block_date desc
),

tmp_table_2 as (
    SELECT 
        tmp_table_1.block_date as block_date,
        tmp_table_1.deposit_sol as deposit_sol,
        tmp_table_1.withdraw_sol as withdraw_sol,
        large_deposit_table.large_deposit_sol as large_deposit_sol
    from tmp_table_1 
    LEFT JOIN large_deposit_table
    ON tmp_table_1.block_date = large_deposit_table.block_date
)

SELECT 
        tmp_table_2.block_date as block_date,
        tmp_table_2.block_date as groupby,
        tmp_table_2.deposit_sol as deposit_sol,
        tmp_table_2.withdraw_sol as withdraw_sol,
        tmp_table_2.large_deposit_sol as large_deposit_sol,
        large_withdraw_table.large_withdraw_sol as large_withdraw_sol
from tmp_table_2
LEFT JOIN large_withdraw_table
ON tmp_table_2.block_date = large_withdraw_table.block_date
ORDER BY block_date

    
"
862747,[BSC]新規/既存ユーザー推移,,"WITH new_user_daily AS (
    SELECT 
        block_date,
        COUNT(1) AS new
    FROM (
        SELECT 
            (CASE WHEN `to` = '0x6238872a0bd9f0e19073695532a7ed77ce93c69e' THEN `from` ELSE `to` END) AS user_address,
            MIN(date_trunc('day', block_time)) AS block_date 
        FROM `bnb`.`transactions`
        WHERE block_time >= '2022-04-01 00:00'
        AND (`from` = '0x6238872a0bd9f0e19073695532a7ed77ce93c69e' OR `to` = '0x6238872a0bd9f0e19073695532a7ed77ce93c69e') -- StepN Wallet
        AND `from` != '0x0000000000000000000000000000000000000000'
        AND `from` != '0x0000000000000000000000000000000000000000' -- remove mint
        AND `to`!= '0x000000000000000000000000000000000000dEaD' -- remove burn
        AND `to` != '0x0000000000000000000000000000000000000000' -- remove burn
        AND `from` != '0xfcfc7130e8af8c016823fa06d00d7c512c61ac7f'  -- remove offical add liquid wallet
        AND `to` != '0xfcfc7130e8af8c016823fa06d00d7c512c61ac7f'  -- remove offical add liquid wallet
        AND success
        GROUP BY user_address
    ) 
    GROUP BY block_date
    ORDER BY block_date
    LIMIT 90
), all_user_daily AS (
    SELECT 
        date_trunc('day', block_time) AS block_date,
        COUNT(DISTINCT(
            CASE WHEN `to` = '0x6238872a0bd9f0e19073695532a7ed77ce93c69e' THEN `from` ELSE `to` END
        )) AS all
    FROM `bnb`.`transactions`
    WHERE block_time >= '2022-04-01 00:00'
    AND (`from` = '0x6238872a0bd9f0e19073695532a7ed77ce93c69e' OR `to` = '0x6238872a0bd9f0e19073695532a7ed77ce93c69e') -- StepN Wallet
    AND `from` != '0x0000000000000000000000000000000000000000'
    AND `from` != '0x0000000000000000000000000000000000000000' -- remove mint
    AND `to`!= '0x000000000000000000000000000000000000dEaD' -- remove burn
    AND `to` != '0x0000000000000000000000000000000000000000' -- remove burn
    AND `from` != '0xfcfc7130e8af8c016823fa06d00d7c512c61ac7f'  -- remove offical add liquid wallet
    AND `to` != '0xfcfc7130e8af8c016823fa06d00d7c512c61ac7f'  -- remove offical add liquid wallet
    AND success
    GROUP BY block_date
    LIMIT 90
)

SELECT 
    a.block_date AS block_date,
    (CASE WHEN new IS NULL THEN 0 ELSE new END) AS new,
    (CASE WHEN new IS NULL THEN all ELSE all - new END)AS existing,
    all
FROM all_user_daily a LEFT JOIN new_user_daily n
ON n.block_date = a.block_date
ORDER BY block_date
LIMIT 90

"
840561,BNB入出金推移,,"WITH daily_bsc_withdraw_stepn AS (
SELECT
        -- block_time,
        
        -- block_time + '8 hours'::INTERVAL AS fixed_block_time,
        
        date_trunc('day', block_time + '5 hours'::INTERVAL) + '3 hours'::INTERVAL AS fixed_block_date,
        
        round(SUM(value * pow(10, -18))) AS amount,

        'withdraw' AS tran_type

    FROM
    `bnb`.`transactions`
    WHERE 
        block_time >= date_trunc('day', NOW() + '5 hours'::INTERVAL) - '28 days'::INTERVAL
        AND from = '0x6238872a0bd9f0e19073695532a7ed77ce93c69e'
        AND value > 0
        AND success = 'true'
    GROUP BY fixed_block_date
)

, daily_bsc_deposit_stepn AS (
    SELECT 
        date_trunc('day', block_time + '5 hours'::INTERVAL) + '3 hours'::INTERVAL AS fixed_block_date,
        
        round(SUM(value * pow(10, -18))) AS amount,

        'deposit' AS tran_type
    FROM 
    `bnb`.`transactions`
    WHERE 
        block_time >= date_trunc('day', NOW() + '5 hours'::INTERVAL) - '28 days'::INTERVAL
        AND to = '0x6238872a0bd9f0e19073695532a7ed77ce93c69e'
        AND value > 0
        AND success = 'true'
    GROUP BY fixed_block_date
)

SELECT * FROM daily_bsc_withdraw_stepn
UNION
SELECT * FROM daily_bsc_deposit_stepn"
863135,StepN Top 1000 withdrawn BNB User On BSC,,"WITH top_1000_bnb_withdrew AS (
    SELECT
        `to` AS address,
        value/1e18 AS withdrawn_bnb
    FROM `bnb`.`transactions`
    WHERE block_time > '2022-04-01 00:00' -- the address start from 2022-04-01 00:00
    AND block_time >= (CURRENT_DATE - '90 days'::interval) 
    AND value > 0
    AND `from` = '0x6238872a0bd9f0e19073695532a7ed77ce93c69e'
    AND success
    ORDER BY value DESC 
    LIMIT 1000
)

SELECT 
    (CASE WHEN address = '0xb7d0749a64345552ef01ff54d6864202215a09a1' THEN 'StepN Profit Wallet' ELSE address END) AS address,
    SUM(withdrawn_bnb) AS withdrawn_bnb
FROM top_1000_bnb_withdrew
GROUP BY address
ORDER BY withdrawn_bnb DESC
"
844335,StepN Shoes In game (Estimated) On BSC,,"WITH gmt_net_daily AS (
    SELECT
        SUM(
            CASE WHEN topic2 = '0x0000000000000000000000006238872a0bd9f0e19073695532a7ed77ce93c69e' THEN -conv(substr(data, 3), 16, 10)/1e8
            WHEN topic3 = '0x0000000000000000000000006238872a0bd9f0e19073695532a7ed77ce93c69e' THEN conv(substr(data, 3), 16, 10)/1e8 END
        ) AS net_amt
    FROM bnb.logs
    WHERE block_time > '2022-04-01 00:00'
    AND contract_address = '0x3019bf2a2ef8040c242c9a4c5c4bd4c81678b2a1'
    AND (topic2 = '0x0000000000000000000000006238872a0bd9f0e19073695532a7ed77ce93c69e' OR topic3 = '0x0000000000000000000000006238872a0bd9f0e19073695532a7ed77ce93c69e')
    AND topic2 != '0x000000000000000000000000fcfc7130e8af8c016823fa06d00d7c512c61ac7f' -- add gst liquidate wallet
    AND topic3 != '0x000000000000000000000000fcfc7130e8af8c016823fa06d00d7c512c61ac7f' -- add gst liquidate wallet
    AND topic2 != '0x0000000000000000000000000000000000000000000000000000000000000000' -- mint wallet
    AND topic3 != '0x0000000000000000000000000000000000000000000000000000000000000000' -- mint wallet
)

SELECT 
    (net_amt/300 + 10000) AS max_estimated_shoes,
    (net_amt/600+ 10000)  AS min_estimated_shoes
FROM gmt_net_daily
"
704516,StepN Active Users On BSC Last 90 Days,,"WITH new_user_daily AS (
    SELECT 
        block_date,
        COUNT(1) AS new
    FROM (
        SELECT 
            (CASE WHEN `to` = '0x6238872a0bd9f0e19073695532a7ed77ce93c69e' THEN `from` ELSE `to` END) AS user_address,
            MIN(date_trunc('day', block_time)) AS block_date 
        FROM `bnb`.`transactions`
        WHERE block_time >= '2022-04-01 00:00'
        AND (`from` = '0x6238872a0bd9f0e19073695532a7ed77ce93c69e' OR `to` = '0x6238872a0bd9f0e19073695532a7ed77ce93c69e') -- StepN Wallet
        AND `from` != '0x0000000000000000000000000000000000000000'
        AND `from` != '0x0000000000000000000000000000000000000000' -- remove mint
        AND `to`!= '0x000000000000000000000000000000000000dEaD' -- remove burn
        AND `to` != '0x0000000000000000000000000000000000000000' -- remove burn
        AND `from` != '0xfcfc7130e8af8c016823fa06d00d7c512c61ac7f'  -- remove offical add liquid wallet
        AND `to` != '0xfcfc7130e8af8c016823fa06d00d7c512c61ac7f'  -- remove offical add liquid wallet
        AND success
        GROUP BY user_address
    ) 
    GROUP BY block_date
    ORDER BY block_date
    LIMIT 90
), all_user_daily AS (
    SELECT 
        date_trunc('day', block_time) AS block_date,
        COUNT(DISTINCT(
            CASE WHEN `to` = '0x6238872a0bd9f0e19073695532a7ed77ce93c69e' THEN `from` ELSE `to` END
        )) AS all
    FROM `bnb`.`transactions`
    WHERE block_time >= '2022-04-01 00:00'
    AND (`from` = '0x6238872a0bd9f0e19073695532a7ed77ce93c69e' OR `to` = '0x6238872a0bd9f0e19073695532a7ed77ce93c69e') -- StepN Wallet
    AND `from` != '0x0000000000000000000000000000000000000000'
    AND `from` != '0x0000000000000000000000000000000000000000' -- remove mint
    AND `to`!= '0x000000000000000000000000000000000000dEaD' -- remove burn
    AND `to` != '0x0000000000000000000000000000000000000000' -- remove burn
    AND `from` != '0xfcfc7130e8af8c016823fa06d00d7c512c61ac7f'  -- remove offical add liquid wallet
    AND `to` != '0xfcfc7130e8af8c016823fa06d00d7c512c61ac7f'  -- remove offical add liquid wallet
    AND success
    GROUP BY block_date
    LIMIT 90
)

SELECT 
    a.block_date AS block_date,
    (CASE WHEN new IS NULL THEN 0 ELSE new END) AS new,
    (CASE WHEN new IS NULL THEN all ELSE all - new END)AS existing,
    all
FROM all_user_daily a LEFT JOIN new_user_daily n
ON n.block_date = a.block_date
ORDER BY block_date
LIMIT 90

"
863230,StepN Profit On BSC (BNB) Goes to,,"WITH stepn_bnb_profit_goto AS (
    SELECT
        `to` AS address,
        value/1e18 AS amount
    FROM `bnb`.`transactions`
    WHERE block_time > '2022-04-01 00:00' -- the address start from 2022-04-01 00:00
    AND block_time >= (CURRENT_DATE - '90 days'::interval) 
    AND value > 0
    AND `from` = '0xb7d0749a64345552ef01ff54d6864202215a09a1'
    AND success
    ORDER BY value DESC 
    LIMIT 1000
), stepn_bnb_stay_in_wallet AS (
    SELECT
        '0xb7d0749a64345552ef01ff54d6864202215a09a1' AS address,
        SUM(CASE WHEN to = '0xb7d0749a64345552ef01ff54d6864202215a09a1' THEN value/1e18
            ELSE -value/1e18 END) AS amount
    FROM `bnb`.`transactions`
    WHERE block_time > (CURRENT_DATE - ""91 days""::INTERVAL)
    AND value > 0
    AND (to = '0xb7d0749a64345552ef01ff54d6864202215a09a1' OR from = '0xb7d0749a64345552ef01ff54d6864202215a09a1')
    AND success
)

SELECT 
    (
        CASE WHEN address = '0xb7d0749a64345552ef01ff54d6864202215a09a1' THEN 'StepN profit wallet' ELSE address END
    ) AS address,
    amount
FROM
(
    (
    SELECT * FROM stepn_bnb_stay_in_wallet
    )
    UNION ALL
    (
    SELECT 
        address,
        SUM(amount) AS amount
    FROM stepn_bnb_profit_goto
    GROUP BY address
    ORDER BY amount DESC
    )
)
"
723843,StepN Not Active Users (BSC),,"WITH total_users AS (
    SELECT 
        COUNT(DISTINCT(
            CASE WHEN `to` = '0x6238872a0bd9f0e19073695532a7ed77ce93c69e' THEN `from` ELSE `to` END
        )) AS all
    FROM `bnb`.`transactions`
    WHERE block_time >= '2022-04-01'
    AND (`from` = '0x6238872a0bd9f0e19073695532a7ed77ce93c69e' OR `to` = '0x6238872a0bd9f0e19073695532a7ed77ce93c69e') -- StepN Wallet
    AND `from` != '0x0000000000000000000000000000000000000000'
    AND `from` != '0x0000000000000000000000000000000000000000' -- remove mint
    AND `to`!= '0x000000000000000000000000000000000000dEaD' -- remove burn
    AND `to` != '0x0000000000000000000000000000000000000000' -- remove burn
    AND `from` != '0xfcfc7130e8af8c016823fa06d00d7c512c61ac7f'  -- remove offical add liquid wallet
    AND `to` != '0xfcfc7130e8af8c016823fa06d00d7c512c61ac7f'  -- remove offical add liquid wallet
    AND success
), active_users AS (
    SELECT 
        COUNT(DISTINCT(
            CASE WHEN `to` = '0x6238872a0bd9f0e19073695532a7ed77ce93c69e' THEN `from` ELSE `to` END
        )) AS active
    FROM `bnb`.`transactions`
    WHERE block_time >= (NOW() - '720 hours'::interval) 
    AND block_time >= '2022-04-01'
    AND (`from` = '0x6238872a0bd9f0e19073695532a7ed77ce93c69e' OR `to` = '0x6238872a0bd9f0e19073695532a7ed77ce93c69e') -- StepN Wallet
    AND `from` != '0x0000000000000000000000000000000000000000'
    AND `from` != '0x0000000000000000000000000000000000000000' -- remove mint
    AND `to`!= '0x000000000000000000000000000000000000dEaD' -- remove burn
    AND `to` != '0x0000000000000000000000000000000000000000' -- remove burn
    AND `from` != '0xfcfc7130e8af8c016823fa06d00d7c512c61ac7f'  -- remove offical add liquid wallet
    AND `to` != '0xfcfc7130e8af8c016823fa06d00d7c512c61ac7f'  -- remove offical add liquid wallet
    AND success
)

SELECT (all - active) AS not_active_users FROM total_users INNER JOIN active_users

"
700046,StepN BNB Cumulative Sum Flow On BSC Last 90 Days,,"WITH bnb_net_daily AS(
    SELECT
        date_trunc('day', block_time) AS block_date,
        SUM(CASE WHEN to = '0x6238872a0bd9f0e19073695532a7ed77ce93c69e' THEN value/1e18
            ELSE -value/1e18 END) AS net_amt
    FROM `bnb`.`transactions`
    WHERE block_time > '2022-04-01 00:00' -- the address start from 2022-04-09
    AND value > 0
    AND (to = '0x6238872a0bd9f0e19073695532a7ed77ce93c69e' OR from = '0x6238872a0bd9f0e19073695532a7ed77ce93c69e')
    AND success
    GROUP BY block_date
    ORDER BY block_date
)

SELECT 
    *,
    SUM(net_amt) OVER(ORDER BY block_date ROWS BETWEEN UNBOUNDED PRECEDING AND CURRENT ROW) AS cumsum_net_amt
FROM bnb_net_daily
ORDER BY block_date
LIMIT 90
"
752896,StepN Shoes Txs Between Users On BSC Last 90 Days,,"
SELECT 
    date_trunc('day', block_time) AS block_date,
    COUNT(1) AS transactions,
    COUNT(DISTINCT(topic2)) - 1 AS senders, 
    COUNT(DISTINCT(topic3)) - 1 AS receivers,
    COUNT(1)/COUNT(DISTINCT(topic2)) AS tx_per_senders,
    COUNT(1)/COUNT(DISTINCT(topic3)) AS tx_per_receivers
FROM bnb.logs
WHERE 
block_time >= '2022-04-01 00:00'
AND contract_address = '0x69d60ad11feb699fe5feeeb16ac691df090bfd50'
AND (topic2 = '0x0000000000000000000000006238872a0bd9f0e19073695532a7ed77ce93c69e' OR topic3 = '0x0000000000000000000000006238872a0bd9f0e19073695532a7ed77ce93c69e')
AND topic2 != '0x000000000000000000000000fcfc7130e8af8c016823fa06d00d7c512c61ac7f' -- add gst liquidate wallet
AND topic3 != '0x000000000000000000000000fcfc7130e8af8c016823fa06d00d7c512c61ac7f' -- add gst liquidate wallet
AND topic2 != '0x0000000000000000000000000000000000000000000000000000000000000000' -- mint wallet
AND topic3 != '0x0000000000000000000000000000000000000000000000000000000000000000' -- mint wallet
AND topic2 != '0x0000000000000000000000009ead559a282f47a6e109382800f73a3a6c54a530' -- binance igo wallet
AND topic3 != '0x0000000000000000000000009ead559a282f47a6e109382800f73a3a6c54a530' -- binance igo wallet
GROUP BY block_date
ORDER BY block_date
LIMIT 90

"
863013,StepN Total Profit On BSC (BNB) Daily on BSC,,"WITH bnb_profit_daily AS(
    SELECT
        date_trunc('day', block_time) AS block_date,
        SUM(value/1e18) AS bnb_amt
    FROM `bnb`.`transactions`
    WHERE block_time > '2022-05-15 00:00' -- the address start from 2022-05-16
    AND value > 0
    AND `from` = '0x6238872a0bd9f0e19073695532a7ed77ce93c69e'
    AND `to` = '0xb7d0749a64345552ef01ff54d6864202215a09a1'
    AND success
    GROUP BY block_date
    ORDER BY block_date
)
-- , date_dashboard AS (
--     SELECT 
--         generate_series AS block_date 
--     FROM
--         generate_series('2022-05-15', CURRENT_DATE, '1 day')
-- )

SELECT 
    *,
    SUM(bnb_amt) OVER(ORDER BY block_date ROWS BETWEEN UNBOUNDED PRECEDING AND CURRENT ROW) AS total_profit
FROM bnb_profit_daily
ORDER BY block_date
LIMIT 90
"
752896,StepN Shoes Txs Between Users On BSC Last 90 Days,,"
SELECT 
    date_trunc('day', block_time) AS block_date,
    COUNT(1) AS transactions,
    COUNT(DISTINCT(topic2)) - 1 AS senders, 
    COUNT(DISTINCT(topic3)) - 1 AS receivers,
    COUNT(1)/COUNT(DISTINCT(topic2)) AS tx_per_senders,
    COUNT(1)/COUNT(DISTINCT(topic3)) AS tx_per_receivers
FROM bnb.logs
WHERE 
block_time >= '2022-04-01 00:00'
AND contract_address = '0x69d60ad11feb699fe5feeeb16ac691df090bfd50'
AND (topic2 = '0x0000000000000000000000006238872a0bd9f0e19073695532a7ed77ce93c69e' OR topic3 = '0x0000000000000000000000006238872a0bd9f0e19073695532a7ed77ce93c69e')
AND topic2 != '0x000000000000000000000000fcfc7130e8af8c016823fa06d00d7c512c61ac7f' -- add gst liquidate wallet
AND topic3 != '0x000000000000000000000000fcfc7130e8af8c016823fa06d00d7c512c61ac7f' -- add gst liquidate wallet
AND topic2 != '0x0000000000000000000000000000000000000000000000000000000000000000' -- mint wallet
AND topic3 != '0x0000000000000000000000000000000000000000000000000000000000000000' -- mint wallet
AND topic2 != '0x0000000000000000000000009ead559a282f47a6e109382800f73a3a6c54a530' -- binance igo wallet
AND topic3 != '0x0000000000000000000000009ead559a282f47a6e109382800f73a3a6c54a530' -- binance igo wallet
GROUP BY block_date
ORDER BY block_date
LIMIT 90

"
844335,StepN Shoes In game (Estimated) On BSC,,"WITH gmt_net_daily AS (
    SELECT
        SUM(
            CASE WHEN topic2 = '0x0000000000000000000000006238872a0bd9f0e19073695532a7ed77ce93c69e' THEN -conv(substr(data, 3), 16, 10)/1e8
            WHEN topic3 = '0x0000000000000000000000006238872a0bd9f0e19073695532a7ed77ce93c69e' THEN conv(substr(data, 3), 16, 10)/1e8 END
        ) AS net_amt
    FROM bnb.logs
    WHERE block_time > '2022-04-01 00:00'
    AND contract_address = '0x3019bf2a2ef8040c242c9a4c5c4bd4c81678b2a1'
    AND (topic2 = '0x0000000000000000000000006238872a0bd9f0e19073695532a7ed77ce93c69e' OR topic3 = '0x0000000000000000000000006238872a0bd9f0e19073695532a7ed77ce93c69e')
    AND topic2 != '0x000000000000000000000000fcfc7130e8af8c016823fa06d00d7c512c61ac7f' -- add gst liquidate wallet
    AND topic3 != '0x000000000000000000000000fcfc7130e8af8c016823fa06d00d7c512c61ac7f' -- add gst liquidate wallet
    AND topic2 != '0x0000000000000000000000000000000000000000000000000000000000000000' -- mint wallet
    AND topic3 != '0x0000000000000000000000000000000000000000000000000000000000000000' -- mint wallet
)

SELECT 
    (net_amt/300 + 10000) AS max_estimated_shoes,
    (net_amt/600+ 10000)  AS min_estimated_shoes
FROM gmt_net_daily
"
721246,StepN Total Users On Bsc,,"SELECT 
    COUNT(DISTINCT(
        CASE WHEN `to` = '0x6238872a0bd9f0e19073695532a7ed77ce93c69e' THEN `from` ELSE `to` END
    )) AS total_user
FROM `bnb`.`transactions`
WHERE block_time >= '2022-04-01 00:00'
AND (`from` = '0x6238872a0bd9f0e19073695532a7ed77ce93c69e' OR `to` = '0x6238872a0bd9f0e19073695532a7ed77ce93c69e') -- StepN Wallet
AND `from` != '0x0000000000000000000000000000000000000000'
AND `from` != '0x0000000000000000000000000000000000000000' -- remove mint
AND `to`!= '0x000000000000000000000000000000000000dEaD' -- remove burn
AND `to` != '0x0000000000000000000000000000000000000000' -- remove burn
AND `from` != '0xfcfc7130e8af8c016823fa06d00d7c512c61ac7f'  -- remove offical add liquid wallet
AND `to` != '0xfcfc7130e8af8c016823fa06d00d7c512c61ac7f'  -- remove offical add liquid wallet
AND success
"
721812,StepN 24h Active Users (BSC),,"SELECT 
    COUNT(DISTINCT(
        CASE WHEN `to` = '0x6238872a0bd9f0e19073695532a7ed77ce93c69e' THEN `from` ELSE `to` END
    )) AS active_user_24h
FROM `bnb`.`transactions`
WHERE block_time >= (NOW() - '24 hours'::interval)
AND (`from` = '0x6238872a0bd9f0e19073695532a7ed77ce93c69e' OR `to` = '0x6238872a0bd9f0e19073695532a7ed77ce93c69e') -- StepN Wallet
AND `from` != '0x0000000000000000000000000000000000000000'
AND `from` != '0x0000000000000000000000000000000000000000' -- remove mint
AND `to`!= '0x000000000000000000000000000000000000dEaD' -- remove burn
AND `to` != '0x0000000000000000000000000000000000000000' -- remove burn
AND `from` != '0xfcfc7130e8af8c016823fa06d00d7c512c61ac7f'  -- remove offical add liquid wallet
AND `to` != '0xfcfc7130e8af8c016823fa06d00d7c512c61ac7f'  -- remove offical add liquid wallet
AND success
"
722412,StepN 7 days Active Users (BSC),,"SELECT 
    COUNT(DISTINCT(
        CASE WHEN `to` = '0x6238872a0bd9f0e19073695532a7ed77ce93c69e' THEN `from` ELSE `to` END
    )) AS active_user_7days
FROM `bnb`.`transactions`
WHERE block_time >= (NOW() - '168 hours'::interval)
AND (`from` = '0x6238872a0bd9f0e19073695532a7ed77ce93c69e' OR `to` = '0x6238872a0bd9f0e19073695532a7ed77ce93c69e') -- StepN Wallet
AND `from` != '0x0000000000000000000000000000000000000000'
AND `from` != '0x0000000000000000000000000000000000000000' -- remove mint
AND `to`!= '0x000000000000000000000000000000000000dEaD' -- remove burn
AND `to` != '0x0000000000000000000000000000000000000000' -- remove burn
AND `from` != '0xfcfc7130e8af8c016823fa06d00d7c512c61ac7f'  -- remove offical add liquid wallet
AND `to` != '0xfcfc7130e8af8c016823fa06d00d7c512c61ac7f'  -- remove offical add liquid wallet
AND success
"
752754,StepN Shoes Flow On BSC Last 90 Days,,"SELECT 
    date_trunc('day', block_time) AS block_date,
    SUM(CASE WHEN topic2 = '0x0000000000000000000000006238872a0bd9f0e19073695532a7ed77ce93c69e' THEN 1 ELSE 0 END) AS out_shoes,
    SUM(CASE WHEN topic3 = '0x0000000000000000000000006238872a0bd9f0e19073695532a7ed77ce93c69e' THEN 1 ELSE 0 END) AS in_shoes,
    SUM(CASE WHEN topic3 = '0x0000000000000000000000006238872a0bd9f0e19073695532a7ed77ce93c69e' THEN 1 ELSE -1 END) AS net_shoes
FROM bnb.logs
WHERE 
block_time >= '2022-04-01 00:00'
AND contract_address = '0x69d60ad11feb699fe5feeeb16ac691df090bfd50'
AND (topic2 = '0x0000000000000000000000006238872a0bd9f0e19073695532a7ed77ce93c69e' OR topic3 = '0x0000000000000000000000006238872a0bd9f0e19073695532a7ed77ce93c69e')
AND topic2 != '0x000000000000000000000000fcfc7130e8af8c016823fa06d00d7c512c61ac7f' -- add gst liquidate wallet
AND topic3 != '0x000000000000000000000000fcfc7130e8af8c016823fa06d00d7c512c61ac7f' -- add gst liquidate wallet
AND topic2 != '0x0000000000000000000000000000000000000000000000000000000000000000' -- mint wallet
AND topic3 != '0x0000000000000000000000000000000000000000000000000000000000000000' -- mint wallet
AND topic2 != '0x0000000000000000000000009ead559a282f47a6e109382800f73a3a6c54a530' -- binance igo wallet
AND topic3 != '0x0000000000000000000000009ead559a282f47a6e109382800f73a3a6c54a530' -- binance igo wallet
GROUP BY block_date
ORDER BY block_date
LIMIT 90
"
704516,StepN Active Users On BSC Last 90 Days,,"WITH new_user_daily AS (
    SELECT 
        block_date,
        COUNT(1) AS new
    FROM (
        SELECT 
            (CASE WHEN `to` = '0x6238872a0bd9f0e19073695532a7ed77ce93c69e' THEN `from` ELSE `to` END) AS user_address,
            MIN(date_trunc('day', block_time)) AS block_date 
        FROM `bnb`.`transactions`
        WHERE block_time >= '2022-04-01 00:00'
        AND (`from` = '0x6238872a0bd9f0e19073695532a7ed77ce93c69e' OR `to` = '0x6238872a0bd9f0e19073695532a7ed77ce93c69e') -- StepN Wallet
        AND `from` != '0x0000000000000000000000000000000000000000'
        AND `from` != '0x0000000000000000000000000000000000000000' -- remove mint
        AND `to`!= '0x000000000000000000000000000000000000dEaD' -- remove burn
        AND `to` != '0x0000000000000000000000000000000000000000' -- remove burn
        AND `from` != '0xfcfc7130e8af8c016823fa06d00d7c512c61ac7f'  -- remove offical add liquid wallet
        AND `to` != '0xfcfc7130e8af8c016823fa06d00d7c512c61ac7f'  -- remove offical add liquid wallet
        AND success
        GROUP BY user_address
    ) 
    GROUP BY block_date
    ORDER BY block_date
    LIMIT 90
), all_user_daily AS (
    SELECT 
        date_trunc('day', block_time) AS block_date,
        COUNT(DISTINCT(
            CASE WHEN `to` = '0x6238872a0bd9f0e19073695532a7ed77ce93c69e' THEN `from` ELSE `to` END
        )) AS all
    FROM `bnb`.`transactions`
    WHERE block_time >= '2022-04-01 00:00'
    AND (`from` = '0x6238872a0bd9f0e19073695532a7ed77ce93c69e' OR `to` = '0x6238872a0bd9f0e19073695532a7ed77ce93c69e') -- StepN Wallet
    AND `from` != '0x0000000000000000000000000000000000000000'
    AND `from` != '0x0000000000000000000000000000000000000000' -- remove mint
    AND `to`!= '0x000000000000000000000000000000000000dEaD' -- remove burn
    AND `to` != '0x0000000000000000000000000000000000000000' -- remove burn
    AND `from` != '0xfcfc7130e8af8c016823fa06d00d7c512c61ac7f'  -- remove offical add liquid wallet
    AND `to` != '0xfcfc7130e8af8c016823fa06d00d7c512c61ac7f'  -- remove offical add liquid wallet
    AND success
    GROUP BY block_date
    LIMIT 90
)

SELECT 
    a.block_date AS block_date,
    (CASE WHEN new IS NULL THEN 0 ELSE new END) AS new,
    (CASE WHEN new IS NULL THEN all ELSE all - new END)AS existing,
    all
FROM all_user_daily a LEFT JOIN new_user_daily n
ON n.block_date = a.block_date
ORDER BY block_date
LIMIT 90

"
701110,StepN GMT Flow On BSC Last 90 Days ,,"-- SELECT 
--     date_trunc('day', evt_block_time) AS block_date,
--     SUM(CASE WHEN ""to"" = '\x6238872a0bd9f0e19073695532a7ed77ce93c69e' THEN value/1e8
--     ELSE 0 END) AS in_amt,
--     SUM(CASE WHEN ""from"" = '\x6238872a0bd9f0e19073695532a7ed77ce93c69e' THEN value/1e8
--     ELSE 0 END) AS out_amt,
--     SUM(CASE WHEN ""to"" = '\x6238872a0bd9f0e19073695532a7ed77ce93c69e' THEN value/1e8
--     ELSE -value/1e8 END) AS net_amt
-- FROM stepn.""GMT_evt_Transfer""
-- WHERE evt_block_time > (CURRENT_DATE - '91 days'::INTERVAL)
-- AND ""from"" != '\x0000000000000000000000000000000000000000' -- remove mint
-- AND ""to"" != '\x000000000000000000000000000000000000dEaD' -- remove burn
-- AND ""to"" != '\x0000000000000000000000000000000000000000' -- remove burn
-- AND ""from"" != '\xfcfc7130e8af8c016823fa06d00d7c512c61ac7f'  -- remove offical add liquid wallet
-- AND ""to"" != '\xfcfc7130e8af8c016823fa06d00d7c512c61ac7f'  -- remove offical add liquid wallet
-- AND (""from"" = '\x6238872a0bd9f0e19073695532a7ed77ce93c69e' OR ""to"" = '\x6238872a0bd9f0e19073695532a7ed77ce93c69e')
-- GROUP BY block_date
-- ORDER BY block_date



-- StepN hot wallet in hex 0x0000000000000000000000006238872a0bd9f0e19073695532a7ed77ce93c69e

SELECT
    SUM(
        CASE WHEN topic3 = '0x0000000000000000000000006238872a0bd9f0e19073695532a7ed77ce93c69e' THEN conv(substr(data, 3), 16, 10)/1e8
        WHEN topic2 = '0x0000000000000000000000006238872a0bd9f0e19073695532a7ed77ce93c69e' THEN 0 END
    ) AS in_amt, 
    SUM(
        CASE WHEN topic2 = '0x0000000000000000000000006238872a0bd9f0e19073695532a7ed77ce93c69e' THEN conv(substr(data, 3), 16, 10)/1e8
        WHEN topic3 = '0x0000000000000000000000006238872a0bd9f0e19073695532a7ed77ce93c69e' THEN 0 END
    ) AS out_amt, 
    SUM(
        CASE WHEN topic2 = '0x0000000000000000000000006238872a0bd9f0e19073695532a7ed77ce93c69e' THEN -conv(substr(data, 3), 16, 10)/1e8
        WHEN topic3 = '0x0000000000000000000000006238872a0bd9f0e19073695532a7ed77ce93c69e' THEN conv(substr(data, 3), 16, 10)/1e8 END
    ) AS net_amt, 
    COUNT(DISTINCT((
        CASE WHEN topic2 = '0x0000000000000000000000006238872a0bd9f0e19073695532a7ed77ce93c69e' THEN topic3
        WHEN topic3 = '0x0000000000000000000000006238872a0bd9f0e19073695532a7ed77ce93c69e' THEN topic2 END
    ))) AS user, 
    COUNT(tx_hash) AS transactions,
    date_trunc('day', block_time) AS block_date
FROM bnb.logs
WHERE block_time > '2022-04-01 00:00'
AND contract_address = '0x3019bf2a2ef8040c242c9a4c5c4bd4c81678b2a1'
AND (topic2 = '0x0000000000000000000000006238872a0bd9f0e19073695532a7ed77ce93c69e' OR topic3 = '0x0000000000000000000000006238872a0bd9f0e19073695532a7ed77ce93c69e')
AND topic2 != '0x000000000000000000000000fcfc7130e8af8c016823fa06d00d7c512c61ac7f' -- add gst liquidate wallet
AND topic3 != '0x000000000000000000000000fcfc7130e8af8c016823fa06d00d7c512c61ac7f' -- add gst liquidate wallet
AND topic2 != '0x0000000000000000000000000000000000000000000000000000000000000000' -- mint wallet
AND topic3 != '0x0000000000000000000000000000000000000000000000000000000000000000' -- mint wallet
GROUP BY block_date
ORDER BY block_date

"
722484,StepN 30 days Active Users (BSC),,"SELECT 
    COUNT(DISTINCT(
        CASE WHEN `to` = '0x6238872a0bd9f0e19073695532a7ed77ce93c69e' THEN `from` ELSE `to` END
    )) AS active_user_30days
FROM `bnb`.`transactions`
WHERE block_time >= (NOW() - '720 hours'::interval) 
AND block_time >= '2022-04-01'
AND (`from` = '0x6238872a0bd9f0e19073695532a7ed77ce93c69e' OR `to` = '0x6238872a0bd9f0e19073695532a7ed77ce93c69e') -- StepN Wallet
AND `from` != '0x0000000000000000000000000000000000000000'
AND `from` != '0x0000000000000000000000000000000000000000' -- remove mint
AND `to`!= '0x000000000000000000000000000000000000dEaD' -- remove burn
AND `to` != '0x0000000000000000000000000000000000000000' -- remove burn
AND `from` != '0xfcfc7130e8af8c016823fa06d00d7c512c61ac7f'  -- remove offical add liquid wallet
AND `to` != '0xfcfc7130e8af8c016823fa06d00d7c512c61ac7f'  -- remove offical add liquid wallet
AND success
"
719342,StepN TXs per user On BSC Last 90 Days,,"WITH bsc_tx_daily AS (

    SELECT 
        date_trunc('day', block_time) AS block_date,
        COUNT(1) AS tx_count,
        COUNT(DISTINCT(
            CASE WHEN `to` = '0x6238872a0bd9f0e19073695532a7ed77ce93c69e' THEN `from` ELSE `to` END
        )) AS users
    FROM `bnb`.`transactions`
    WHERE block_time >= '2022-04-01 00:00'
    AND (`from` = '0x6238872a0bd9f0e19073695532a7ed77ce93c69e' OR `to` = '0x6238872a0bd9f0e19073695532a7ed77ce93c69e') -- StepN Wallet
    AND `from` != '0x0000000000000000000000000000000000000000'
    AND `from` != '0x0000000000000000000000000000000000000000' -- remove mint
    AND `to`!= '0x000000000000000000000000000000000000dEaD' -- remove burn
    AND `to` != '0x0000000000000000000000000000000000000000' -- remove burn
    AND `from` != '0xfcfc7130e8af8c016823fa06d00d7c512c61ac7f'  -- remove offical add liquid wallet
    AND `to` != '0xfcfc7130e8af8c016823fa06d00d7c512c61ac7f'  -- remove offical add liquid wallet
    AND `from` != '0x69d60ad11feb699fe5feeeb16ac691df090bfd50'     -- remove STEPN nft contract
    AND `to` != '0x69d60ad11feb699fe5feeeb16ac691df090bfd50'     -- remove STEPN nft contract
    AND success
    GROUP BY block_date
    ORDER BY block_date
    LIMIT 90

)

SELECT 
    *, tx_count/users AS tx_per_user
FROM bsc_tx_daily

"
701114,StepN GST Cumulative Sum Flow On BSC Last 90 Days,,"-- the bsc data source delay serious, so drop it.

-- WITH gst_net_daily AS (
--     SELECT 
--         date_trunc('day', evt_block_time) AS block_date,
--         SUM(CASE WHEN ""to"" = '\x6238872a0bd9f0e19073695532a7ed77ce93c69e' THEN value/1e8
--         ELSE -value/1e8 END) AS net_amt
--     FROM green_satoshi_token.""GST_evt_Transfer""
--     WHERE evt_block_time > '2022-04-01 00:00'
--     AND ""from"" != '\x0000000000000000000000000000000000000000' -- remove mint
--     AND ""to"" != '\x000000000000000000000000000000000000dEaD' -- remove burn
--     AND ""to"" != '\x0000000000000000000000000000000000000000' -- remove burn
--     AND ""from"" != '\xfcfc7130e8af8c016823fa06d00d7c512c61ac7f'  -- remove offical add liquid wallet
--     AND ""to"" != '\xfcfc7130e8af8c016823fa06d00d7c512c61ac7f'  -- remove offical add liquid wallet
--     AND (""from"" = '\x6238872a0bd9f0e19073695532a7ed77ce93c69e' OR ""to"" = '\x6238872a0bd9f0e19073695532a7ed77ce93c69e')
--     GROUP BY block_date
--     ORDER BY block_date
-- )


-- StepN hot wallet in hex 0x0000000000000000000000006238872a0bd9f0e19073695532a7ed77ce93c69e

WITH gst_net_daily AS (
SELECT
    SUM(
        CASE WHEN topic2 = '0x0000000000000000000000006238872a0bd9f0e19073695532a7ed77ce93c69e' THEN -conv(substr(data, 3), 16, 10)/1e8
        WHEN topic3 = '0x0000000000000000000000006238872a0bd9f0e19073695532a7ed77ce93c69e' THEN conv(substr(data, 3), 16, 10)/1e8 END
    ) AS net_amt, 
    COUNT(DISTINCT((
        CASE WHEN topic2 = '0x0000000000000000000000006238872a0bd9f0e19073695532a7ed77ce93c69e' THEN topic3
        WHEN topic3 = '0x0000000000000000000000006238872a0bd9f0e19073695532a7ed77ce93c69e' THEN topic2 END
    ))) AS user, 
    COUNT(tx_hash) AS transactions,
    date_trunc('day', block_time) AS block_date
FROM bnb.logs
WHERE block_time > '2022-04-01 00:00'
AND contract_address = '0x4a2c860cec6471b9f5f5a336eb4f38bb21683c98'
AND (topic2 = '0x0000000000000000000000006238872a0bd9f0e19073695532a7ed77ce93c69e' OR topic3 = '0x0000000000000000000000006238872a0bd9f0e19073695532a7ed77ce93c69e')
AND topic2 != '0x000000000000000000000000fcfc7130e8af8c016823fa06d00d7c512c61ac7f' -- add gst liquidate wallet
AND topic3 != '0x000000000000000000000000fcfc7130e8af8c016823fa06d00d7c512c61ac7f' -- add gst liquidate wallet
AND topic2 != '0x0000000000000000000000000000000000000000000000000000000000000000' -- mint wallet
AND topic3 != '0x0000000000000000000000000000000000000000000000000000000000000000' -- mint wallet
GROUP BY block_date
ORDER BY block_date
)

SELECT 
    *,
    SUM(net_amt) OVER(ORDER BY block_date ROWS BETWEEN UNBOUNDED PRECEDING AND CURRENT ROW) AS cumsum_net_amt
FROM gst_net_daily
ORDER BY block_date
LIMIT 90

"
690950,StepN GST Flow On BSC Last 90 Days,,"-- the bsc data source delay serious, so drop it.

-- SELECT 
--     date_trunc('day', evt_block_time) AS block_date,
--     SUM(CASE WHEN ""to"" = '\x6238872a0bd9f0e19073695532a7ed77ce93c69e' THEN value/1e8
--     ELSE 0 END) AS in_amt,
--     SUM(CASE WHEN ""from"" = '\x6238872a0bd9f0e19073695532a7ed77ce93c69e' THEN value/1e8
--     ELSE 0 END) AS out_amt,
--     SUM(CASE WHEN ""to"" = '\x6238872a0bd9f0e19073695532a7ed77ce93c69e' THEN value/1e8
--     ELSE -value/1e8 END) AS net_amt
-- FROM green_satoshi_token.""GST_evt_Transfer""
-- WHERE evt_block_time > (CURRENT_DATE - '91 days'::INTERVAL)
-- AND ""from"" != '\x0000000000000000000000000000000000000000' -- remove mint
-- AND ""to"" != '\x000000000000000000000000000000000000dEaD' -- remove burn
-- AND ""to"" != '\x0000000000000000000000000000000000000000' -- remove burn
-- AND ""from"" != '\xfcfc7130e8af8c016823fa06d00d7c512c61ac7f'  -- remove offical add liquid wallet
-- AND ""to"" != '\xfcfc7130e8af8c016823fa06d00d7c512c61ac7f'  -- remove offical add liquid wallet
-- AND (""from"" = '\x6238872a0bd9f0e19073695532a7ed77ce93c69e' OR ""to"" = '\x6238872a0bd9f0e19073695532a7ed77ce93c69e')
-- GROUP BY block_date
-- ORDER BY block_date


-- StepN hot wallet in hex 0x0000000000000000000000006238872a0bd9f0e19073695532a7ed77ce93c69e

SELECT
    SUM(
        CASE WHEN topic3 = '0x0000000000000000000000006238872a0bd9f0e19073695532a7ed77ce93c69e' THEN conv(substr(data, 3), 16, 10)/1e8
        WHEN topic2 = '0x0000000000000000000000006238872a0bd9f0e19073695532a7ed77ce93c69e' THEN 0 END
    ) AS in_amt, 
    SUM(
        CASE WHEN topic2 = '0x0000000000000000000000006238872a0bd9f0e19073695532a7ed77ce93c69e' THEN conv(substr(data, 3), 16, 10)/1e8
        WHEN topic3 = '0x0000000000000000000000006238872a0bd9f0e19073695532a7ed77ce93c69e' THEN 0 END
    ) AS out_amt, 
    SUM(
        CASE WHEN topic2 = '0x0000000000000000000000006238872a0bd9f0e19073695532a7ed77ce93c69e' THEN -conv(substr(data, 3), 16, 10)/1e8
        WHEN topic3 = '0x0000000000000000000000006238872a0bd9f0e19073695532a7ed77ce93c69e' THEN conv(substr(data, 3), 16, 10)/1e8 END
    ) AS net_amt, 
    COUNT(DISTINCT((
        CASE WHEN topic2 = '0x0000000000000000000000006238872a0bd9f0e19073695532a7ed77ce93c69e' THEN topic3
        WHEN topic3 = '0x0000000000000000000000006238872a0bd9f0e19073695532a7ed77ce93c69e' THEN topic2 END
    ))) AS user, 
    COUNT(tx_hash) AS transactions,
    date_trunc('day', block_time) AS block_date
FROM bnb.logs
WHERE block_time > '2022-04-01 00:00'
AND contract_address = '0x4a2c860cec6471b9f5f5a336eb4f38bb21683c98'
AND (topic2 = '0x0000000000000000000000006238872a0bd9f0e19073695532a7ed77ce93c69e' OR topic3 = '0x0000000000000000000000006238872a0bd9f0e19073695532a7ed77ce93c69e')
AND topic2 != '0x000000000000000000000000fcfc7130e8af8c016823fa06d00d7c512c61ac7f' -- add gst liquidate wallet
AND topic3 != '0x000000000000000000000000fcfc7130e8af8c016823fa06d00d7c512c61ac7f' -- add gst liquidate wallet
AND topic2 != '0x0000000000000000000000000000000000000000000000000000000000000000' -- mint wallet
AND topic3 != '0x0000000000000000000000000000000000000000000000000000000000000000' -- mint wallet
GROUP BY block_date
ORDER BY block_date



"
690461,StepN BNB Flow On BSC Last 90 Days,,"
SELECT
    date_trunc('day', block_time) AS block_date,
    SUM(CASE WHEN to = '0x6238872a0bd9f0e19073695532a7ed77ce93c69e' THEN value/1e18
        ELSE 0 END) AS in_amt,
    SUM(CASE WHEN from = '0x6238872a0bd9f0e19073695532a7ed77ce93c69e' THEN value/1e18
        ELSE 0 END) AS out_amt,
    SUM(CASE WHEN to = '0x6238872a0bd9f0e19073695532a7ed77ce93c69e' THEN value/1e18
        ELSE -value/1e18 END) AS net_amt
FROM `bnb`.`transactions`
WHERE block_time > (CURRENT_DATE - ""91 days""::INTERVAL)
AND value > 0
AND (to = '0x6238872a0bd9f0e19073695532a7ed77ce93c69e' OR from = '0x6238872a0bd9f0e19073695532a7ed77ce93c69e')
AND success
GROUP BY block_date
ORDER BY block_date
LIMIT 90
"
691713,StepN GMT Cumulative Sum Flow On BSC Last 90 Days,,"WITH gmt_net_daily AS (
    -- SELECT 
    --     date_trunc('day', evt_block_time) AS block_date,
    --     SUM(CASE WHEN ""to"" = '\x6238872a0bd9f0e19073695532a7ed77ce93c69e' THEN value/1e8
    --     ELSE -value/1e8 END) AS net_Amt
    -- FROM stepn.""GMT_evt_Transfer""
    -- WHERE evt_block_time > (CURRENT_DATE - '91 days'::INTERVAL)
    -- AND ""from"" != '\x0000000000000000000000000000000000000000' -- remove mint
    -- AND ""to"" != '\x000000000000000000000000000000000000dEaD' -- remove burn
    -- AND ""to"" != '\x0000000000000000000000000000000000000000' -- remove burn
    -- AND ""from"" != '\xfcfc7130e8af8c016823fa06d00d7c512c61ac7f'  -- remove offical add liquid wallet
    -- AND ""to"" != '\xfcfc7130e8af8c016823fa06d00d7c512c61ac7f'  -- remove offical add liquid wallet
    -- AND (""from"" = '\x6238872a0bd9f0e19073695532a7ed77ce93c69e' OR ""to"" = '\x6238872a0bd9f0e19073695532a7ed77ce93c69e')
    -- GROUP BY block_date
    -- ORDER BY block_date
    SELECT
        SUM(
            CASE WHEN topic2 = '0x0000000000000000000000006238872a0bd9f0e19073695532a7ed77ce93c69e' THEN -conv(substr(data, 3), 16, 10)/1e8
            WHEN topic3 = '0x0000000000000000000000006238872a0bd9f0e19073695532a7ed77ce93c69e' THEN conv(substr(data, 3), 16, 10)/1e8 END
        ) AS net_amt, 
        COUNT(DISTINCT((
            CASE WHEN topic2 = '0x0000000000000000000000006238872a0bd9f0e19073695532a7ed77ce93c69e' THEN topic3
            WHEN topic3 = '0x0000000000000000000000006238872a0bd9f0e19073695532a7ed77ce93c69e' THEN topic2 END
        ))) AS user, 
        COUNT(tx_hash) AS transactions,
        date_trunc('day', block_time) AS block_date
    FROM bnb.logs
    WHERE block_time > '2022-04-01 00:00'
    AND contract_address = '0x3019bf2a2ef8040c242c9a4c5c4bd4c81678b2a1'
    AND (topic2 = '0x0000000000000000000000006238872a0bd9f0e19073695532a7ed77ce93c69e' OR topic3 = '0x0000000000000000000000006238872a0bd9f0e19073695532a7ed77ce93c69e')
    AND topic2 != '0x000000000000000000000000fcfc7130e8af8c016823fa06d00d7c512c61ac7f' -- add gst liquidate wallet
    AND topic3 != '0x000000000000000000000000fcfc7130e8af8c016823fa06d00d7c512c61ac7f' -- add gst liquidate wallet
    AND topic2 != '0x0000000000000000000000000000000000000000000000000000000000000000' -- mint wallet
    AND topic3 != '0x0000000000000000000000000000000000000000000000000000000000000000' -- mint wallet
    GROUP BY block_date
    ORDER BY block_date
)

SELECT 
    *,
    SUM(net_amt) OVER(ORDER BY block_date ROWS BETWEEN UNBOUNDED PRECEDING AND CURRENT ROW) AS cumsum_net_amt
FROM gmt_net_daily
ORDER BY block_date
LIMIT 90
"
862874,StepN Total Profit (BNB) on BSC,,"
SELECT
    SUM(value/1e18) AS cumsum_profit
FROM `bnb`.`transactions`
WHERE block_time > '2022-05-15 00:00'
AND value > 0
AND `from` = '0x6238872a0bd9f0e19073695532a7ed77ce93c69e'
AND `to` = '0xb7d0749a64345552ef01ff54d6864202215a09a1'
AND success

"
862958,StepN Profit distribution,,"SELECT
    SUM(value/1e18)*0.05 AS for_eco,
    SUM(value/1e18)*0.95 AS for_team
FROM `bnb`.`transactions`
WHERE block_time > '2022-05-15 00:00'
AND value > 0
AND from = '0x6238872a0bd9f0e19073695532a7ed77ce93c69e'
AND to = '0xb7d0749a64345552ef01ff54d6864202215a09a1'
AND success
"
862958,StepN Profit distribution,,"SELECT
    SUM(value/1e18)*0.05 AS for_eco,
    SUM(value/1e18)*0.95 AS for_team
FROM `bnb`.`transactions`
WHERE block_time > '2022-05-15 00:00'
AND value > 0
AND from = '0x6238872a0bd9f0e19073695532a7ed77ce93c69e'
AND to = '0xb7d0749a64345552ef01ff54d6864202215a09a1'
AND success
"
840427,StepN Shoes Cumulative Sum Flow On BSC,,"WITH net_shoes_daily AS (
    SELECT 
        date_trunc('day', block_time) AS block_date,
        SUM(CASE WHEN topic3 = '0x0000000000000000000000006238872a0bd9f0e19073695532a7ed77ce93c69e' THEN 1 ELSE -1 END) AS net_shoes
    FROM bnb.logs
    WHERE 
    block_time >= '2022-04-01 00:00'
    AND contract_address = '0x69d60ad11feb699fe5feeeb16ac691df090bfd50'
    AND (topic2 = '0x0000000000000000000000006238872a0bd9f0e19073695532a7ed77ce93c69e' OR topic3 = '0x0000000000000000000000006238872a0bd9f0e19073695532a7ed77ce93c69e')
    AND topic2 != '0x000000000000000000000000fcfc7130e8af8c016823fa06d00d7c512c61ac7f' -- add gst liquidate wallet
    AND topic3 != '0x000000000000000000000000fcfc7130e8af8c016823fa06d00d7c512c61ac7f' -- add gst liquidate wallet
    AND topic2 != '0x0000000000000000000000000000000000000000000000000000000000000000' -- mint wallet
    AND topic3 != '0x0000000000000000000000000000000000000000000000000000000000000000' -- mint wallet
    AND topic2 != '0x0000000000000000000000009ead559a282f47a6e109382800f73a3a6c54a530' -- binance igo wallet
    AND topic3 != '0x0000000000000000000000009ead559a282f47a6e109382800f73a3a6c54a530' -- binance igo wallet
    GROUP BY block_date
    ORDER BY block_date
)

SELECT 
    SUM(net_shoes) OVER(ORDER BY block_date) AS cumsum_net_shoes, * 
FROM net_shoes_daily
"
684350,[SOL] StepN Daily Active Users,,"

SELECT 
    block_date, 
    COUNT(distinct account_keys[0]) as active_users,
    COUNT(signer) as transactions, 
    COUNT(signer)/COUNT(distinct account_keys[0]) as trans_per_users, 
    ROUND((COUNT(signer) - LAG(COUNT(signer)) OVER(ORDER BY block_date ASC)) / LAG(COUNT(signer)) OVER(ORDER BY block_date ASC) * 100,2) AS growth_transactions,
    ROUND((COUNT(distinct account_keys[0]) - LAG(COUNT(distinct account_keys[0])) OVER(ORDER BY block_date ASC)) / LAG(COUNT(distinct account_keys[0])) OVER(ORDER BY block_date ASC) * 100,2) AS growth_users
FROM solana.transactions
WHERE 
    block_date >= (CURRENT_DATE - '30 days'::INTERVAL)
    AND block_date < CURRENT_DATE
    AND ( ARRAY_CONTAINS(account_keys,""STEPNq2UGeGSzCyGVr2nMQAzf8xuejwqebd84wcksCK"") -- Address deposit SOL from Wallet to Spending
    OR ARRAY_CONTAINS(account_keys,""HLS5Y68QSQgJP7wUbbbbCjEnMknVZrHXYDwwVaDcsdK7"") 
    OR ARRAY_CONTAINS(account_keys,""7i5KKsX2weiTkry7jA4ZwSuXGhs5eJBEjY8vVxR4pfRx"") 
    OR ARRAY_CONTAINS(account_keys,""AFbX8oGjGpmVFywbVouvhQSRmiW2aR1mohfahi4Y2AdB"") )
    AND error is NULL
GROUP BY
    block_date
ORDER BY 
    block_date desc"
686177,[BSC] StepN shoes minted,,"--SET TIMEZONE='Asia/Taipei';
--SHOW TIMEZONE;
SELECT 
    date_trunc('day', evt_block_time) AS block_date,
    COUNT(1) AS shoe_minted
FROM
    erc721.""ERC721_evt_Transfer""
WHERE
    ""contract_address"" ='\x69D60ad11fEB699fE5fEEeB16AC691dF090bfd50'
    AND
    ""from"" = '\x0000000000000000000000000000000000000000'
    AND 
    evt_block_time > '2022-04-12 00:00'  -- skip airdrop
GROUP BY block_date"
686205,"[BSC] StepN shoes, DAU relation",,"SET TIMEZONE='Asia/Taipei';
SHOW TIMEZONE;

WITH bsc_daily_users AS (
    SELECT 
        date_trunc('day', block_time) AS block_date
        ,count(distinct ""from"")  AS active_users
    FROM bsc.""transactions""
    WHERE block_time >= '2022-04-01'
      AND date_trunc('day', block_time) >= date_trunc('day', current_date) - '91 days'::interval
      AND date_trunc('day', block_time) <= date_trunc('day', now())
      AND ""to"" = '\x6238872a0bd9f0e19073695532a7ed77ce93c69e' -- STEPN HotWallet @BSC
    GROUP BY block_date
    ORDER BY 1 DESC 
), bsc_shoe_minted AS (
    SELECT 
        date_trunc('day', evt_block_time) AS block_date,
        COUNT(1) AS shoe_minted
    FROM
        erc721.""ERC721_evt_Transfer""
    WHERE
        ""contract_address"" ='\x69D60ad11fEB699fE5fEEeB16AC691dF090bfd50'
        AND
        ""from"" = '\x0000000000000000000000000000000000000000'
        AND 
        evt_block_time > '2022-04-12 00:00'  -- skip airdrop
    GROUP BY block_date
)

SELECT 
    dau.block_date,
    dau.active_users,
    minted.shoe_minted
FROM bsc_daily_users AS dau, bsc_shoe_minted AS minted
WHERE
    dau.block_date = minted.block_date"
684346,[BSC] StepN Daily Active Users,,"--SET TIMEZONE='Asia/Taipei';
--SHOW TIMEZONE;

select date_trunc('day', block_time),
       count(*)                 AS transactions,
       AVG(count(*)) OVER (ORDER BY date_trunc('day', block_time) ROWS BETWEEN 7 PRECEDING AND CURRENT ROW) 
                                AS avg_transactions,
       count(distinct ""from"")   AS active_users,
       AVG(count(distinct ""from"")) OVER (ORDER BY date_trunc('day', block_time) ROWS BETWEEN 7 PRECEDING AND CURRENT ROW) 
                                AS avg_dau
from bsc.""transactions""
where block_time >= '2022-04-01'
  and date_trunc('day', block_time) >= date_trunc('day', current_date) - '91 days'::interval
  --and date_trunc('day', block_time) < date_trunc('day', now())
  AND block_time < CURRENT_DATE
  and ""to"" = '\x6238872a0bd9f0e19073695532a7ed77ce93c69e' -- STEPN HotWallet @BSC
group by date_trunc('day', block_time)
order by 1 desc "
684358,[BSC] StepN 官方錢包 BNB 出入金,,"--SET TIMEZONE='Asia/Taipei';

WITH daily_bsc_withdraw_stepn AS (
    SELECT 
        date_trunc('day', block_time ) AS block_date,
        SUM(value * 10^(-19)) AS amount,
        'withdraw' AS tran_type
    FROM bsc.""transactions""
    WHERE 
        block_time >= CURRENT_DATE  - '28 days'::INTERVAL
        AND ""from"" = '\x6238872a0bd9f0e19073695532a7ed77ce93c69e'
        AND value > 0
        AND success = 'true'
    GROUP BY block_date
)

, daily_bsc_deposit_stepn AS (
    SELECT 
        date_trunc('day', block_time) AS block_date,
        SUM(value * 10^(-19)) AS amount,
        'deposit' AS tran_type
    FROM bsc.""transactions""
    WHERE 
        block_time >= CURRENT_DATE - '28 days'::INTERVAL
        AND ""to"" = '\x6238872a0bd9f0e19073695532a7ed77ce93c69e'
        AND value > 0
        AND success = 'true'
    GROUP BY block_date
)

SELECT * FROM daily_bsc_withdraw_stepn
UNION
SELECT * FROM daily_bsc_deposit_stepn"
684359,[SOL] StepN 官方錢包 SOL 出入金,,"SELECT 
    (block_date + INTERVAL '8 hour') AS time, 
    sum(case when account_keys[1] = ""STEPNq2UGeGSzCyGVr2nMQAzf8xuejwqebd84wcksCK"" and size(account_keys) = 3
             then (pre_balances[0] - post_balances[0])/power(10,9) else 0 end) as deposited_SOL, 
    sum(case when account_keys[0] = ""STEPNq2UGeGSzCyGVr2nMQAzf8xuejwqebd84wcksCK"" 
             then (pre_balances[0] - post_balances[0])/power(10,9) else 0 end) as withdrawn_SOL
FROM solana.transactions
WHERE 
    block_date >= (CURRENT_DATE - '30 days'::INTERVAL + INTERVAL '8 hour')
    AND block_date < CURRENT_DATE + INTERVAL '8 hour'
    AND (account_keys[1] = ""STEPNq2UGeGSzCyGVr2nMQAzf8xuejwqebd84wcksCK""
    OR account_keys[0] = ""STEPNq2UGeGSzCyGVr2nMQAzf8xuejwqebd84wcksCK"" )
    -- AND size(account_keys) = 3
    AND error is NULL
GROUP BY
    block_date
ORDER BY 
    block_date desc
"
686214,[SOL]STEPN Daily Shoes Minted,,"SELECT
    (block_date) AS block_date,
    COUNT(distinct post_token_balance['mint']) as shoes
    -- COUNT(distinct post_token_balance['mint']) filter (where (now() - block_time) <= interval '1 week') AS New_Shoes_7D
FROM
    solana.transactions
    LATERAL VIEW explode(post_token_balances) AS post_token_balance
WHERE 1=1
    AND block_date >= (CURRENT_DATE - '30 days'::INTERVAL)
    AND block_date < CURRENT_DATE
    AND signer = 'STEPNq2UGeGSzCyGVr2nMQAzf8xuejwqebd84wcksCK'
    AND array_contains(log_messages, 'Program TokenkegQfeZyiNwAJbNbGKPFXCWuBvf9Ss623VQ5DA invoke [1]')
    AND array_contains(log_messages, 'Program log: Instruction: InitializeMint')
    AND success is true
    AND error is NULL
GROUP BY  1 "
685513,[BSC] StepN Total Sneakers,,"SELECT 
    COUNT(1) AS total
FROM
    erc721.""ERC721_evt_Transfer""
WHERE
    ""contract_address"" ='\x69D60ad11fEB699fE5fEEeB16AC691dF090bfd50'
    AND
    ""from"" = '\x0000000000000000000000000000000000000000'"
631738,STEPN用户行为分析：日均卖出GST用户分布,,"with trade_gst_sum (
  SELECT 
    signer,
    date_part('day', MAX(block_date) - MIN(block_date)) + 1 as day_cnt,
    -- SUM(IF(post_token_balance.amount - pre_token_balance.amount > 0, 
    --         post_token_balance.amount - pre_token_balance.amount, 
    --         0)) as buy_gst_amount,
    -- 0 as buy_gst_amount,
    SUM(-IF(post_token_balance.amount - pre_token_balance.amount < 0, 
            post_token_balance.amount - pre_token_balance.amount, 
            0)) as sell_gst_amount,
    -- 0 as sell_gst_amount
    COUNT(signer) as cnt
  FROM
    solana.transactions
    LATERAL VIEW explode(instructions) i1 AS instruction 
    LATERAL VIEW explode(instruction.inner_instructions) ii1 AS inner_instruction 
    LATERAL VIEW explode(pre_token_balances) p1 AS pre_token_balance 
    LATERAL VIEW explode(post_token_balances) p2 AS post_token_balance 
  WHERE
    block_date >= '2022-04-08'
    AND block_date < '2022-04-22'
    AND ARRAY_CONTAINS(account_keys,""9r39vqrJuubgafaJ5aQyDWYAUQVJeyZyveBXeRqp7xev"")
    AND inner_instruction.executing_account = 'TokenkegQfeZyiNwAJbNbGKPFXCWuBvf9Ss623VQ5DA'
    AND 
        (
            -- (
            --     inner_instruction.account_arguments[0] = ""9r39vqrJuubgafaJ5aQyDWYAUQVJeyZyveBXeRqp7xev""
            --     AND
            --     pre_token_balance.account = inner_instruction.account_arguments[1]
            -- )
            -- OR
            (
                inner_instruction.account_arguments[1] = ""9r39vqrJuubgafaJ5aQyDWYAUQVJeyZyveBXeRqp7xev""
                AND
                pre_token_balance.account = inner_instruction.account_arguments[0]
            )
        )
    AND SIZE(inner_instruction.account_arguments) = 3
    AND pre_token_balance.account = post_token_balance.account
    AND error IS NULL
    GROUP BY signer
    
    -- LIMIT 100
)

, trade_distribute_table as (
    SELECT 
        signer, 
        -- sell_gst_amount,
        -- day_cnt,
        -- cnt,
        pow(floor(pow(if(sell_gst_amount/day_cnt > 220, 220, sell_gst_amount/day_cnt), 0.5)/0.02)*0.02,2) as m
    FROM trade_gst_sum
    WHERE
        cnt > 1 OR sell_gst_amount < 100
)



SELECT 
    COUNT(signer),
    m
FROM trade_distribute_table
WHERE m > 0
GROUP BY m
ORDER BY m
"
633268,STEPN用户行为分析：日均卖出GST用户分布统计,,"with trade_gst_sum (
  SELECT 
    signer,
    date_part('day', MAX(block_date) - MIN(block_date)) + 1 as day_cnt,
    -- SUM(IF(post_token_balance.amount - pre_token_balance.amount > 0, 
    --         post_token_balance.amount - pre_token_balance.amount, 
    --         0)) as buy_gst_amount,
    -- 0 as buy_gst_amount,
    SUM(-IF(post_token_balance.amount - pre_token_balance.amount < 0, 
            post_token_balance.amount - pre_token_balance.amount, 
            0)) as sell_gst_amount,
    -- 0 as sell_gst_amount
    COUNT(signer) as cnt
  FROM
    solana.transactions
    LATERAL VIEW explode(instructions) i1 AS instruction 
    LATERAL VIEW explode(instruction.inner_instructions) ii1 AS inner_instruction 
    LATERAL VIEW explode(pre_token_balances) p1 AS pre_token_balance 
    LATERAL VIEW explode(post_token_balances) p2 AS post_token_balance 
  WHERE
    block_date >= '2022-04-08'
    AND block_date < '2022-04-22'
    AND ARRAY_CONTAINS(account_keys,""9r39vqrJuubgafaJ5aQyDWYAUQVJeyZyveBXeRqp7xev"")
    AND inner_instruction.executing_account = 'TokenkegQfeZyiNwAJbNbGKPFXCWuBvf9Ss623VQ5DA'
    AND 
        (
            -- (
            --     inner_instruction.account_arguments[0] = ""9r39vqrJuubgafaJ5aQyDWYAUQVJeyZyveBXeRqp7xev""
            --     AND
            --     pre_token_balance.account = inner_instruction.account_arguments[1]
            -- )
            -- OR
            (
                inner_instruction.account_arguments[1] = ""9r39vqrJuubgafaJ5aQyDWYAUQVJeyZyveBXeRqp7xev""
                AND
                pre_token_balance.account = inner_instruction.account_arguments[0]
            )
        )
    AND SIZE(inner_instruction.account_arguments) = 3
    AND pre_token_balance.account = post_token_balance.account
    AND error IS NULL
    GROUP BY signer
    
    -- LIMIT 100
),

-- trade_gst_sum2 as (
--   SELECT 
--     signer,
--     -- buy_gst_amount,
--     sell_gst_amount,
--     -- IF(buy_gst_amount > -sell_gst_amount, buy_gst_amount, -sell_gst_amount) as volumn
--     sell_gst_amount as volumn
--   FROM trade_gst_sum
-- ),

trade_distribute_table as (
    SELECT 
        signer, 
        sell_gst_amount,
        sell_gst_amount/day_cnt as daily_sell_amount,
        IF(sell_gst_amount/day_cnt < 14.9, ""G01"",
        IF(sell_gst_amount/day_cnt < 21.8, ""G02"",
        IF(sell_gst_amount/day_cnt < 27.28, ""G03"",
        IF(sell_gst_amount/day_cnt < 32.79, ""G04"",
        IF(sell_gst_amount/day_cnt < 43.9, ""G05"",
        IF(sell_gst_amount/day_cnt < 54.8, ""G06"",
        IF(sell_gst_amount/day_cnt < 65.9, ""G07"",
        IF(sell_gst_amount/day_cnt < 76.5, ""G08"",
        IF(sell_gst_amount/day_cnt < 87.9, ""G09"",
        IF(sell_gst_amount/day_cnt < 109.56, ""G10"",
        IF(sell_gst_amount/day_cnt >= 109.56, ""G11"",""G_OTHER"")
        )))))))))) AS user_group
    FROM trade_gst_sum
    WHERE
        cnt > 1 OR sell_gst_amount < 100
)

-- add pool amount
-- , orca_gst_swap_pool_add as (
--     SELECT
--         SUM(orca_post_gst_balance.amount - orca_pre_gst_balance.amount) AS orca_gst_add_amount
--     FROM
--         solana.transactions
--         LATERAL VIEW explode(account_keys) t1 AS orca_usdc_account
--         LATERAL VIEW explode(pre_token_balances) t2 AS orca_pre_usdc_balance
--         LATERAL VIEW explode(post_token_balances) t3 AS orca_post_usdc_balance
--         LATERAL VIEW explode(account_keys) k1 AS orca_gst_account
--         LATERAL VIEW explode(pre_token_balances) k2 AS orca_pre_gst_balance
--         LATERAL VIEW explode(post_token_balances) k3 AS orca_post_gst_balance
--         LATERAL VIEW explode(account_keys) k1 AS user_usdc_account
--         LATERAL VIEW explode(pre_token_balances) k2 AS user_pre_usdc_balance
--         LATERAL VIEW explode(post_token_balances) k3 AS user_post_usdc_balance
--     WHERE
--         block_date >= '2022-04-08'
--         AND block_date < '2022-04-22'
--         AND orca_usdc_account = ""7LFnr5YgUyEgPMCLGNQ9N7wM5MFRNqCuRawLZTe5q4c7""
--         AND orca_pre_usdc_balance.account = orca_usdc_account
--         AND orca_post_usdc_balance.account = orca_usdc_account
--         AND orca_pre_usdc_balance.mint = ""EPjFWdd5AufqSSqeM2qN1xzybapC8G4wEGGkZwyTDt1v""
--         AND orca_post_usdc_balance.mint = ""EPjFWdd5AufqSSqeM2qN1xzybapC8G4wEGGkZwyTDt1v""
--         AND error IS NULL
--         AND orca_gst_account = ""9r39vqrJuubgafaJ5aQyDWYAUQVJeyZyveBXeRqp7xev""
--         AND orca_pre_gst_balance.account = orca_gst_account
--         AND orca_post_gst_balance.account = orca_gst_account
--         AND orca_pre_gst_balance.mint = ""AFbX8oGjGpmVFywbVouvhQSRmiW2aR1mohfahi4Y2AdB""
--         AND orca_post_gst_balance.mint = ""AFbX8oGjGpmVFywbVouvhQSRmiW2aR1mohfahi4Y2AdB""     
--         AND orca_post_gst_balance.amount - orca_pre_gst_balance.amount > 0
--         AND orca_post_usdc_balance.amount - orca_pre_usdc_balance.amount > 0
--         AND user_usdc_account <> ""7LFnr5YgUyEgPMCLGNQ9N7wM5MFRNqCuRawLZTe5q4c7""
--         AND user_pre_usdc_balance.account = user_usdc_account
--         AND user_post_usdc_balance.account = user_usdc_account
--         AND user_pre_usdc_balance.mint = ""EPjFWdd5AufqSSqeM2qN1xzybapC8G4wEGGkZwyTDt1v""
--         AND user_post_usdc_balance.mint = ""EPjFWdd5AufqSSqeM2qN1xzybapC8G4wEGGkZwyTDt1v""
-- )


    SELECT 
        COUNT(signer),
        -- SUM(sell_gst_amount) - IF(user_group = 'G11', 1906415.15748, 0) AS sell_gst_amount,
        SUM(sell_gst_amount) AS sell_gst_amount,
        user_group
    FROM trade_distribute_table
    WHERE sell_gst_amount > 0
    GROUP BY user_group
    ORDER BY user_group

"
633268,STEPN用户行为分析：日均卖出GST用户分布统计,,"with trade_gst_sum (
  SELECT 
    signer,
    date_part('day', MAX(block_date) - MIN(block_date)) + 1 as day_cnt,
    -- SUM(IF(post_token_balance.amount - pre_token_balance.amount > 0, 
    --         post_token_balance.amount - pre_token_balance.amount, 
    --         0)) as buy_gst_amount,
    -- 0 as buy_gst_amount,
    SUM(-IF(post_token_balance.amount - pre_token_balance.amount < 0, 
            post_token_balance.amount - pre_token_balance.amount, 
            0)) as sell_gst_amount,
    -- 0 as sell_gst_amount
    COUNT(signer) as cnt
  FROM
    solana.transactions
    LATERAL VIEW explode(instructions) i1 AS instruction 
    LATERAL VIEW explode(instruction.inner_instructions) ii1 AS inner_instruction 
    LATERAL VIEW explode(pre_token_balances) p1 AS pre_token_balance 
    LATERAL VIEW explode(post_token_balances) p2 AS post_token_balance 
  WHERE
    block_date >= '2022-04-08'
    AND block_date < '2022-04-22'
    AND ARRAY_CONTAINS(account_keys,""9r39vqrJuubgafaJ5aQyDWYAUQVJeyZyveBXeRqp7xev"")
    AND inner_instruction.executing_account = 'TokenkegQfeZyiNwAJbNbGKPFXCWuBvf9Ss623VQ5DA'
    AND 
        (
            -- (
            --     inner_instruction.account_arguments[0] = ""9r39vqrJuubgafaJ5aQyDWYAUQVJeyZyveBXeRqp7xev""
            --     AND
            --     pre_token_balance.account = inner_instruction.account_arguments[1]
            -- )
            -- OR
            (
                inner_instruction.account_arguments[1] = ""9r39vqrJuubgafaJ5aQyDWYAUQVJeyZyveBXeRqp7xev""
                AND
                pre_token_balance.account = inner_instruction.account_arguments[0]
            )
        )
    AND SIZE(inner_instruction.account_arguments) = 3
    AND pre_token_balance.account = post_token_balance.account
    AND error IS NULL
    GROUP BY signer
    
    -- LIMIT 100
),

-- trade_gst_sum2 as (
--   SELECT 
--     signer,
--     -- buy_gst_amount,
--     sell_gst_amount,
--     -- IF(buy_gst_amount > -sell_gst_amount, buy_gst_amount, -sell_gst_amount) as volumn
--     sell_gst_amount as volumn
--   FROM trade_gst_sum
-- ),

trade_distribute_table as (
    SELECT 
        signer, 
        sell_gst_amount,
        sell_gst_amount/day_cnt as daily_sell_amount,
        IF(sell_gst_amount/day_cnt < 14.9, ""G01"",
        IF(sell_gst_amount/day_cnt < 21.8, ""G02"",
        IF(sell_gst_amount/day_cnt < 27.28, ""G03"",
        IF(sell_gst_amount/day_cnt < 32.79, ""G04"",
        IF(sell_gst_amount/day_cnt < 43.9, ""G05"",
        IF(sell_gst_amount/day_cnt < 54.8, ""G06"",
        IF(sell_gst_amount/day_cnt < 65.9, ""G07"",
        IF(sell_gst_amount/day_cnt < 76.5, ""G08"",
        IF(sell_gst_amount/day_cnt < 87.9, ""G09"",
        IF(sell_gst_amount/day_cnt < 109.56, ""G10"",
        IF(sell_gst_amount/day_cnt >= 109.56, ""G11"",""G_OTHER"")
        )))))))))) AS user_group
    FROM trade_gst_sum
    WHERE
        cnt > 1 OR sell_gst_amount < 100
)

-- add pool amount
-- , orca_gst_swap_pool_add as (
--     SELECT
--         SUM(orca_post_gst_balance.amount - orca_pre_gst_balance.amount) AS orca_gst_add_amount
--     FROM
--         solana.transactions
--         LATERAL VIEW explode(account_keys) t1 AS orca_usdc_account
--         LATERAL VIEW explode(pre_token_balances) t2 AS orca_pre_usdc_balance
--         LATERAL VIEW explode(post_token_balances) t3 AS orca_post_usdc_balance
--         LATERAL VIEW explode(account_keys) k1 AS orca_gst_account
--         LATERAL VIEW explode(pre_token_balances) k2 AS orca_pre_gst_balance
--         LATERAL VIEW explode(post_token_balances) k3 AS orca_post_gst_balance
--         LATERAL VIEW explode(account_keys) k1 AS user_usdc_account
--         LATERAL VIEW explode(pre_token_balances) k2 AS user_pre_usdc_balance
--         LATERAL VIEW explode(post_token_balances) k3 AS user_post_usdc_balance
--     WHERE
--         block_date >= '2022-04-08'
--         AND block_date < '2022-04-22'
--         AND orca_usdc_account = ""7LFnr5YgUyEgPMCLGNQ9N7wM5MFRNqCuRawLZTe5q4c7""
--         AND orca_pre_usdc_balance.account = orca_usdc_account
--         AND orca_post_usdc_balance.account = orca_usdc_account
--         AND orca_pre_usdc_balance.mint = ""EPjFWdd5AufqSSqeM2qN1xzybapC8G4wEGGkZwyTDt1v""
--         AND orca_post_usdc_balance.mint = ""EPjFWdd5AufqSSqeM2qN1xzybapC8G4wEGGkZwyTDt1v""
--         AND error IS NULL
--         AND orca_gst_account = ""9r39vqrJuubgafaJ5aQyDWYAUQVJeyZyveBXeRqp7xev""
--         AND orca_pre_gst_balance.account = orca_gst_account
--         AND orca_post_gst_balance.account = orca_gst_account
--         AND orca_pre_gst_balance.mint = ""AFbX8oGjGpmVFywbVouvhQSRmiW2aR1mohfahi4Y2AdB""
--         AND orca_post_gst_balance.mint = ""AFbX8oGjGpmVFywbVouvhQSRmiW2aR1mohfahi4Y2AdB""     
--         AND orca_post_gst_balance.amount - orca_pre_gst_balance.amount > 0
--         AND orca_post_usdc_balance.amount - orca_pre_usdc_balance.amount > 0
--         AND user_usdc_account <> ""7LFnr5YgUyEgPMCLGNQ9N7wM5MFRNqCuRawLZTe5q4c7""
--         AND user_pre_usdc_balance.account = user_usdc_account
--         AND user_post_usdc_balance.account = user_usdc_account
--         AND user_pre_usdc_balance.mint = ""EPjFWdd5AufqSSqeM2qN1xzybapC8G4wEGGkZwyTDt1v""
--         AND user_post_usdc_balance.mint = ""EPjFWdd5AufqSSqeM2qN1xzybapC8G4wEGGkZwyTDt1v""
-- )


    SELECT 
        COUNT(signer),
        -- SUM(sell_gst_amount) - IF(user_group = 'G11', 1906415.15748, 0) AS sell_gst_amount,
        SUM(sell_gst_amount) AS sell_gst_amount,
        user_group
    FROM trade_distribute_table
    WHERE sell_gst_amount > 0
    GROUP BY user_group
    ORDER BY user_group

"
639505,GST单笔购入的次数分布,,"with trade_gst_sum (
  SELECT 
    signer,
    IF(post_token_balance.amount - pre_token_balance.amount > 0, 
            post_token_balance.amount - pre_token_balance.amount, 
            0) as buy_gst_amount
    -- 0 as buy_gst_amount,
    -- SUM(-IF(post_token_balance.amount - pre_token_balance.amount < 0, 
    --         post_token_balance.amount - pre_token_balance.amount, 
    --         0)) as sell_gst_amount,
    -- 0 as sell_gst_amount
    
  FROM
    solana.transactions
    LATERAL VIEW explode(instructions) i1 AS instruction 
    LATERAL VIEW explode(instruction.inner_instructions) ii1 AS inner_instruction 
    LATERAL VIEW explode(pre_token_balances) p1 AS pre_token_balance 
    LATERAL VIEW explode(post_token_balances) p2 AS post_token_balance 
  WHERE
    block_date >= '2022-04-08'
    AND block_date < '2022-04-22'
    AND ARRAY_CONTAINS(account_keys,""9r39vqrJuubgafaJ5aQyDWYAUQVJeyZyveBXeRqp7xev"")
    AND inner_instruction.executing_account = 'TokenkegQfeZyiNwAJbNbGKPFXCWuBvf9Ss623VQ5DA'
    AND 
        (
            (
                inner_instruction.account_arguments[0] = ""9r39vqrJuubgafaJ5aQyDWYAUQVJeyZyveBXeRqp7xev""
                AND
                pre_token_balance.account = inner_instruction.account_arguments[1]
            )
            -- OR
            -- (
            --     inner_instruction.account_arguments[1] = ""9r39vqrJuubgafaJ5aQyDWYAUQVJeyZyveBXeRqp7xev""
            --     AND
            --     pre_token_balance.account = inner_instruction.account_arguments[0]
            -- )
        )
    AND SIZE(inner_instruction.account_arguments) = 3
    AND pre_token_balance.account = post_token_balance.account
    AND error IS NULL
    
    -- LIMIT 100
)

, trade_distribute_table as (
    SELECT 
        buy_gst_amount,
        IF(buy_gst_amount < 80,
        floor(buy_gst_amount),
        pow(floor(pow(if(buy_gst_amount > 5000, 5000, buy_gst_amount), 0.5)/1)*1,2)) as m
    FROM trade_gst_sum

)



SELECT 
    COUNT(m),
    m
FROM trade_distribute_table
WHERE m > 0
GROUP BY m
ORDER BY m
"
639600,GST单笔购入的数据分类统计,,"with trade_gst_sum (
  SELECT 
    signer,
    IF(post_token_balance.amount - pre_token_balance.amount > 0, 
            post_token_balance.amount - pre_token_balance.amount, 
            0) as buy_gst_amount
    -- 0 as buy_gst_amount,
    -- SUM(-IF(post_token_balance.amount - pre_token_balance.amount < 0, 
    --         post_token_balance.amount - pre_token_balance.amount, 
    --         0)) as sell_gst_amount,
    -- 0 as sell_gst_amount
    
  FROM
    solana.transactions
    LATERAL VIEW explode(instructions) i1 AS instruction 
    LATERAL VIEW explode(instruction.inner_instructions) ii1 AS inner_instruction 
    LATERAL VIEW explode(pre_token_balances) p1 AS pre_token_balance 
    LATERAL VIEW explode(post_token_balances) p2 AS post_token_balance 
  WHERE
    block_date >= '2022-04-08'
    AND block_date < '2022-04-22'
    AND ARRAY_CONTAINS(account_keys,""9r39vqrJuubgafaJ5aQyDWYAUQVJeyZyveBXeRqp7xev"")
    AND inner_instruction.executing_account = 'TokenkegQfeZyiNwAJbNbGKPFXCWuBvf9Ss623VQ5DA'
    AND 
        (
            (
                inner_instruction.account_arguments[0] = ""9r39vqrJuubgafaJ5aQyDWYAUQVJeyZyveBXeRqp7xev""
                AND
                pre_token_balance.account = inner_instruction.account_arguments[1]
            )
            -- OR
            -- (
            --     inner_instruction.account_arguments[1] = ""9r39vqrJuubgafaJ5aQyDWYAUQVJeyZyveBXeRqp7xev""
            --     AND
            --     pre_token_balance.account = inner_instruction.account_arguments[0]
            -- )
        )
    AND SIZE(inner_instruction.account_arguments) = 3
    AND pre_token_balance.account = post_token_balance.account
    AND error IS NULL
    
    -- LIMIT 100
)

, user_group_distribute AS (
    SELECT 
        IF(buy_gst_amount <= 37, ""G1"",
        IF(buy_gst_amount > 37 AND buy_gst_amount <= 80, ""G2"",
        IF(buy_gst_amount > 80 AND buy_gst_amount <= 484, ""G3"",
        ""G4""))) AS user_group,
        buy_gst_amount
    FROM trade_gst_sum
)

SELECT 
    user_group,
    SUM(buy_gst_amount)
FROM
    user_group_distribute
GROUP BY user_group
"
639702,单笔存入GST到Spending的行为分布数据统计,,"WITH user_deposit_gst as (
    SELECT 
        -- id,
        -- block_date, 
        -- signer,
        (pre_token_balances[0].amount - post_token_balances[0].amount) as gst_amount_change
    FROM solana.transactions
    -- LATERAL VIEW explode(instructions) i1 AS instruction 
    -- LATERAL VIEW posexplode(account_keys) a1 AS account_key_idx, account_key
    -- LATERAL VIEW posexplode(pre_balances) p1 AS pre_balance_idx, pre_balance 
    -- LATERAL VIEW posexplode(post_balances) p2 AS post_balance_idx, post_balance 
    WHERE 
        block_date >= '2022-04-08'
        AND block_date < '2022-04-22'
        AND ARRAY_CONTAINS(account_keys, ""HLS5Y68QSQgJP7wUbbbbCjEnMknVZrHXYDwwVaDcsdK7"")
        AND (SIZE(account_keys) = 4 OR SIZE(account_keys) = 5)
        AND account_keys[0] <> ""STEPNq2UGeGSzCyGVr2nMQAzf8xuejwqebd84wcksCK""
        AND instructions[0].executing_account = ""TokenkegQfeZyiNwAJbNbGKPFXCWuBvf9Ss623VQ5DA""
        AND SIZE(instructions) = 1
        -- AND ARRAY_CONTAINS(instruction.account_arguments, ""STEPNq2UGeGSzCyGVr2nMQAzf8xuejwqebd84wcksCK"")
        -- AND account_key_idx = pre_balance_idx
        -- AND account_key_idx = post_balance_idx
        -- AND account_key <> ""STEPNq2UGeGSzCyGVr2nMQAzf8xuejwqebd84wcksCK""
        -- AND ARRAY_CONTAINS(instruction.account_arguments, account_key)
        -- AND ((pre_balance - post_balance) > 10000000 OR (pre_balance - post_balance) < -10000000)
        AND error is NULL
    -- ORDER BY 
    --     block_date desc
    -- LIMIT 100
)

, user_group_distribute AS (
    SELECT 
        IF(gst_amount_change <= 37, ""G1"",
        IF(gst_amount_change > 37 AND gst_amount_change <= 80, ""G2"",
        IF(gst_amount_change > 80 AND gst_amount_change <= 484, ""G3"",
        ""G4""))) AS user_group,
        gst_amount_change
    FROM user_deposit_gst
)

SELECT 
    user_group,
    SUM(gst_amount_change)
FROM
    user_group_distribute
GROUP BY user_group
"
630795,存取SOL的用户分布,,"with deposit_sum as (
    SELECT 
        signer,
        sum((pre_balances[0] - post_balances[0]))/power(10,9) as sol_deposit
    FROM solana.transactions
    WHERE 
        block_date >= '2022-04-07'
        AND block_date < '2022-04-22'
        AND ARRAY_CONTAINS(account_keys, 'STEPNq2UGeGSzCyGVr2nMQAzf8xuejwqebd84wcksCK')
        AND SIZE(instructions) = 1
        AND instructions[0].executing_account = ""11111111111111111111111111111111""
        AND instructions[0].account_arguments[1] = ""STEPNq2UGeGSzCyGVr2nMQAzf8xuejwqebd84wcksCK""
        AND signer <> ""STEPNq2UGeGSzCyGVr2nMQAzf8xuejwqebd84wcksCK""
        AND ((pre_balances[0] - post_balances[0]) > 10000000 OR (pre_balances[0] - post_balances[0]) < -10000000)
        AND error is NULL
    GROUP BY signer
    ORDER BY sol_deposit DESC
    -- LIMIT 100
),

withdraw_sum as (
    SELECT 
        account_key as signer,
        sum((pre_balance - post_balance))/power(10,9) as sol_withdraw
    FROM solana.transactions
    LATERAL VIEW explode(instructions) i1 AS instruction 
    LATERAL VIEW posexplode(account_keys) a1 AS account_key_idx, account_key
    LATERAL VIEW posexplode(pre_balances) p1 AS pre_balance_idx, pre_balance 
    LATERAL VIEW posexplode(post_balances) p2 AS post_balance_idx, post_balance 
    WHERE 
        block_date >= '2022-04-08'
        AND block_date < '2022-04-22'
        -- AND id = ""5ZVX4ws5ct9j2pAuYncds21JX6C5qkM1XCicBFvb7NZSKnEJV7UmGXkkULr4mu2Eo46jLXb8XygpfZpBDQKv4TCW""
        AND ARRAY_CONTAINS(account_keys, ""STEPNq2UGeGSzCyGVr2nMQAzf8xuejwqebd84wcksCK"")
        AND instruction.executing_account = ""11111111111111111111111111111111""
        AND instruction.account_arguments[0] = ""STEPNq2UGeGSzCyGVr2nMQAzf8xuejwqebd84wcksCK""
        AND instruction.account_arguments[1] = account_key
        AND account_key_idx = pre_balance_idx
        AND account_key_idx = post_balance_idx
        AND account_key <> ""STEPNq2UGeGSzCyGVr2nMQAzf8xuejwqebd84wcksCK""
        AND ((pre_balance - post_balance) > 10000000 OR (pre_balance - post_balance) < -10000000)
        AND error is NULL
    GROUP BY account_key
),


deposit_withdraw_sum as (
    SELECT  
        deposit_sum.signer as signer,
        IF(ISNULL(deposit_sum.sol_deposit), 0, deposit_sum.sol_deposit) as sol_deposit,
        IF(ISNULL(withdraw_sum.sol_withdraw), 0, withdraw_sum.sol_withdraw) as sol_withdraw,
        (deposit_sum.sol_deposit - IF(withdraw_sum.sol_withdraw IS NULL, 0, withdraw_sum.sol_withdraw)) as volume
    FROM 
        deposit_sum FULL JOIN withdraw_sum
    ON deposit_sum.signer = withdraw_sum.signer
),

deposit_distribute_table as (
    SELECT 
        signer, 
        sol_deposit,
        sol_withdraw,
        pow(floor(pow(if(volume > 200, 200, volume), 0.5)/0.2)*0.2,2) as m
    FROM deposit_withdraw_sum
    -- WHERE sol_deposit <= 200
    -- GROUP BY sol_deposit
    -- ORDER BY sol_deposit
)

SELECT 
    COUNT(signer),
    -- SUM(sol_deposit),
    -- SUM(sol_withdraw),
    m
FROM deposit_distribute_table
GROUP BY m
ORDER BY m"
631080,用户分类数据统计,,"with deposit_sum as (
    SELECT 
        signer,
        sum((pre_balances[0] - post_balances[0]))/power(10,9) as sol_deposit
    FROM solana.transactions
    WHERE 
        block_date >= '2022-04-08'
        AND block_date < '2022-04-22'
        AND ARRAY_CONTAINS(account_keys, 'STEPNq2UGeGSzCyGVr2nMQAzf8xuejwqebd84wcksCK')
        AND SIZE(instructions) = 1
        AND instructions[0].executing_account = ""11111111111111111111111111111111""
        AND instructions[0].account_arguments[1] = ""STEPNq2UGeGSzCyGVr2nMQAzf8xuejwqebd84wcksCK""
        AND signer <> ""STEPNq2UGeGSzCyGVr2nMQAzf8xuejwqebd84wcksCK""
        AND ((pre_balances[0] - post_balances[0]) > 10000000 OR (pre_balances[0] - post_balances[0]) < -10000000)
        AND error is NULL
    GROUP BY signer
    ORDER BY sol_deposit DESC
    -- LIMIT 100
),

withdraw_sum as (
    SELECT 
        account_key as signer,
        sum((pre_balance - post_balance))/power(10,9) as sol_withdraw
    FROM solana.transactions
    LATERAL VIEW explode(instructions) i1 AS instruction 
    LATERAL VIEW posexplode(account_keys) a1 AS account_key_idx, account_key
    LATERAL VIEW posexplode(pre_balances) p1 AS pre_balance_idx, pre_balance 
    LATERAL VIEW posexplode(post_balances) p2 AS post_balance_idx, post_balance 
    WHERE 
        block_date >= '2022-04-08'
        AND block_date < '2022-04-22'
        -- AND id = ""5ZVX4ws5ct9j2pAuYncds21JX6C5qkM1XCicBFvb7NZSKnEJV7UmGXkkULr4mu2Eo46jLXb8XygpfZpBDQKv4TCW""
        AND ARRAY_CONTAINS(account_keys, ""STEPNq2UGeGSzCyGVr2nMQAzf8xuejwqebd84wcksCK"")
        AND instruction.executing_account = ""11111111111111111111111111111111""
        AND instruction.account_arguments[0] = ""STEPNq2UGeGSzCyGVr2nMQAzf8xuejwqebd84wcksCK""
        AND instruction.account_arguments[1] = account_key
        AND account_key_idx = pre_balance_idx
        AND account_key_idx = post_balance_idx
        AND account_key <> ""STEPNq2UGeGSzCyGVr2nMQAzf8xuejwqebd84wcksCK""
        AND ((pre_balance - post_balance) > 10000000 OR (pre_balance - post_balance) < -10000000)
        AND error is NULL
    GROUP BY account_key
),


deposit_withdraw_sum as (
    SELECT  
        deposit_sum.signer as signer,
        deposit_sum.sol_deposit as sol_deposit,
        withdraw_sum.sol_withdraw as sol_withdraw,
        (deposit_sum.sol_deposit - IF(withdraw_sum.sol_withdraw IS NULL, 0, withdraw_sum.sol_withdraw)) as volume
    FROM 
        deposit_sum FULL JOIN withdraw_sum
    ON deposit_sum.signer = withdraw_sum.signer
),

deposit_distribute_table as (
    SELECT 
        signer, 
        sol_deposit,
        sol_withdraw,
        IF(sol_deposit >= 54.76, ""1.Super User"", IF(sol_deposit >= 21.16, ""2.High Level User"", ""3.Normal User"")) AS user_type
    FROM deposit_withdraw_sum
    -- WHERE sol_deposit <= 200
    -- GROUP BY sol_deposit
    -- ORDER BY sol_deposit
)

SELECT 
    COUNT(signer),
    SUM(sol_deposit),
    SUM(sol_withdraw),
    SUM(sol_deposit + sol_withdraw),
    user_type
FROM deposit_distribute_table
GROUP BY user_type
ORDER BY user_type DESC"
640031,GMT单笔购入的次数分布,,"with trade_gmt_sum (
  SELECT
    signer,
    IF(post_token_balance.amount - pre_token_balance.amount > 0,
            post_token_balance.amount - pre_token_balance.amount,
            0) as buy_gmt_amount
    -- 0 as buy_gmt_amount,
    -- SUM(-IF(post_token_balance.amount - pre_token_balance.amount < 0,
    --         post_token_balance.amount - pre_token_balance.amount,
    --         0)) as sell_gmt_amount,
    -- 0 as sell_gmt_amount

  FROM
    solana.transactions
    LATERAL VIEW explode(instructions) i1 AS instruction
    LATERAL VIEW explode(instruction.inner_instructions) ii1 AS inner_instruction
    LATERAL VIEW explode(pre_token_balances) p1 AS pre_token_balance
    LATERAL VIEW explode(post_token_balances) p2 AS post_token_balance
  WHERE
    block_date > CURRENT_DATE - '14 days'::INTERVAL
    AND block_date <= CURRENT_DATE
    AND ARRAY_CONTAINS(account_keys,""BTpvbpTArnekGgbXRqjfSvp7gENtHXvZCAwuUKQNYMeN"")
    AND inner_instruction.executing_account = 'TokenkegQfeZyiNwAJbNbGKPFXCWuBvf9Ss623VQ5DA'
    AND        
        (
            (
                inner_instruction.account_arguments[0] = ""BTpvbpTArnekGgbXRqjfSvp7gENtHXvZCAwuUKQNYMeN""
                AND
                pre_token_balance.account = inner_instruction.account_arguments[1]
            )
            -- OR
            -- ( 
            --     inner_instruction.account_arguments[1] = ""9r39vqrJuubgafaJ5aQyDWYAUQVJeyZyveBXeRqp7xev""
            --     AND
            --     pre_token_balance.account = inner_instruction.account_arguments[0]
            -- )
        )
    AND SIZE(inner_instruction.account_arguments) = 3
    AND pre_token_balance.account = post_token_balance.account
    AND error IS NULL

    -- LIMIT 100
)

, trade_distribute_table as (
    SELECT
        buy_gmt_amount,
        IF(buy_gmt_amount < 1000,
        floor(buy_gmt_amount),
        pow(floor(pow(if(buy_gmt_amount > 1000, 1000, buy_gmt_amount), 0.5)/2)*2,2)) as m
    FROM trade_gmt_sum
)
SELECT
    IF(COUNT(m) > 10000, 10000, COUNT(m)),
    -- COUNT(m),
    m
FROM trade_distribute_table
WHERE m > 0 AND m < 650
-- WHERE m > 0
GROUP BY m
ORDER BY m
"
631080,用户分类数据统计,,"with deposit_sum as (
    SELECT 
        signer,
        sum((pre_balances[0] - post_balances[0]))/power(10,9) as sol_deposit
    FROM solana.transactions
    WHERE 
        block_date >= '2022-04-08'
        AND block_date < '2022-04-22'
        AND ARRAY_CONTAINS(account_keys, 'STEPNq2UGeGSzCyGVr2nMQAzf8xuejwqebd84wcksCK')
        AND SIZE(instructions) = 1
        AND instructions[0].executing_account = ""11111111111111111111111111111111""
        AND instructions[0].account_arguments[1] = ""STEPNq2UGeGSzCyGVr2nMQAzf8xuejwqebd84wcksCK""
        AND signer <> ""STEPNq2UGeGSzCyGVr2nMQAzf8xuejwqebd84wcksCK""
        AND ((pre_balances[0] - post_balances[0]) > 10000000 OR (pre_balances[0] - post_balances[0]) < -10000000)
        AND error is NULL
    GROUP BY signer
    ORDER BY sol_deposit DESC
    -- LIMIT 100
),

withdraw_sum as (
    SELECT 
        account_key as signer,
        sum((pre_balance - post_balance))/power(10,9) as sol_withdraw
    FROM solana.transactions
    LATERAL VIEW explode(instructions) i1 AS instruction 
    LATERAL VIEW posexplode(account_keys) a1 AS account_key_idx, account_key
    LATERAL VIEW posexplode(pre_balances) p1 AS pre_balance_idx, pre_balance 
    LATERAL VIEW posexplode(post_balances) p2 AS post_balance_idx, post_balance 
    WHERE 
        block_date >= '2022-04-08'
        AND block_date < '2022-04-22'
        -- AND id = ""5ZVX4ws5ct9j2pAuYncds21JX6C5qkM1XCicBFvb7NZSKnEJV7UmGXkkULr4mu2Eo46jLXb8XygpfZpBDQKv4TCW""
        AND ARRAY_CONTAINS(account_keys, ""STEPNq2UGeGSzCyGVr2nMQAzf8xuejwqebd84wcksCK"")
        AND instruction.executing_account = ""11111111111111111111111111111111""
        AND instruction.account_arguments[0] = ""STEPNq2UGeGSzCyGVr2nMQAzf8xuejwqebd84wcksCK""
        AND instruction.account_arguments[1] = account_key
        AND account_key_idx = pre_balance_idx
        AND account_key_idx = post_balance_idx
        AND account_key <> ""STEPNq2UGeGSzCyGVr2nMQAzf8xuejwqebd84wcksCK""
        AND ((pre_balance - post_balance) > 10000000 OR (pre_balance - post_balance) < -10000000)
        AND error is NULL
    GROUP BY account_key
),


deposit_withdraw_sum as (
    SELECT  
        deposit_sum.signer as signer,
        deposit_sum.sol_deposit as sol_deposit,
        withdraw_sum.sol_withdraw as sol_withdraw,
        (deposit_sum.sol_deposit - IF(withdraw_sum.sol_withdraw IS NULL, 0, withdraw_sum.sol_withdraw)) as volume
    FROM 
        deposit_sum FULL JOIN withdraw_sum
    ON deposit_sum.signer = withdraw_sum.signer
),

deposit_distribute_table as (
    SELECT 
        signer, 
        sol_deposit,
        sol_withdraw,
        IF(sol_deposit >= 54.76, ""1.Super User"", IF(sol_deposit >= 21.16, ""2.High Level User"", ""3.Normal User"")) AS user_type
    FROM deposit_withdraw_sum
    -- WHERE sol_deposit <= 200
    -- GROUP BY sol_deposit
    -- ORDER BY sol_deposit
)

SELECT 
    COUNT(signer),
    SUM(sol_deposit),
    SUM(sol_withdraw),
    SUM(sol_deposit + sol_withdraw),
    user_type
FROM deposit_distribute_table
GROUP BY user_type
ORDER BY user_type DESC"
631080,用户分类数据统计,,"with deposit_sum as (
    SELECT 
        signer,
        sum((pre_balances[0] - post_balances[0]))/power(10,9) as sol_deposit
    FROM solana.transactions
    WHERE 
        block_date >= '2022-04-08'
        AND block_date < '2022-04-22'
        AND ARRAY_CONTAINS(account_keys, 'STEPNq2UGeGSzCyGVr2nMQAzf8xuejwqebd84wcksCK')
        AND SIZE(instructions) = 1
        AND instructions[0].executing_account = ""11111111111111111111111111111111""
        AND instructions[0].account_arguments[1] = ""STEPNq2UGeGSzCyGVr2nMQAzf8xuejwqebd84wcksCK""
        AND signer <> ""STEPNq2UGeGSzCyGVr2nMQAzf8xuejwqebd84wcksCK""
        AND ((pre_balances[0] - post_balances[0]) > 10000000 OR (pre_balances[0] - post_balances[0]) < -10000000)
        AND error is NULL
    GROUP BY signer
    ORDER BY sol_deposit DESC
    -- LIMIT 100
),

withdraw_sum as (
    SELECT 
        account_key as signer,
        sum((pre_balance - post_balance))/power(10,9) as sol_withdraw
    FROM solana.transactions
    LATERAL VIEW explode(instructions) i1 AS instruction 
    LATERAL VIEW posexplode(account_keys) a1 AS account_key_idx, account_key
    LATERAL VIEW posexplode(pre_balances) p1 AS pre_balance_idx, pre_balance 
    LATERAL VIEW posexplode(post_balances) p2 AS post_balance_idx, post_balance 
    WHERE 
        block_date >= '2022-04-08'
        AND block_date < '2022-04-22'
        -- AND id = ""5ZVX4ws5ct9j2pAuYncds21JX6C5qkM1XCicBFvb7NZSKnEJV7UmGXkkULr4mu2Eo46jLXb8XygpfZpBDQKv4TCW""
        AND ARRAY_CONTAINS(account_keys, ""STEPNq2UGeGSzCyGVr2nMQAzf8xuejwqebd84wcksCK"")
        AND instruction.executing_account = ""11111111111111111111111111111111""
        AND instruction.account_arguments[0] = ""STEPNq2UGeGSzCyGVr2nMQAzf8xuejwqebd84wcksCK""
        AND instruction.account_arguments[1] = account_key
        AND account_key_idx = pre_balance_idx
        AND account_key_idx = post_balance_idx
        AND account_key <> ""STEPNq2UGeGSzCyGVr2nMQAzf8xuejwqebd84wcksCK""
        AND ((pre_balance - post_balance) > 10000000 OR (pre_balance - post_balance) < -10000000)
        AND error is NULL
    GROUP BY account_key
),


deposit_withdraw_sum as (
    SELECT  
        deposit_sum.signer as signer,
        deposit_sum.sol_deposit as sol_deposit,
        withdraw_sum.sol_withdraw as sol_withdraw,
        (deposit_sum.sol_deposit - IF(withdraw_sum.sol_withdraw IS NULL, 0, withdraw_sum.sol_withdraw)) as volume
    FROM 
        deposit_sum FULL JOIN withdraw_sum
    ON deposit_sum.signer = withdraw_sum.signer
),

deposit_distribute_table as (
    SELECT 
        signer, 
        sol_deposit,
        sol_withdraw,
        IF(sol_deposit >= 54.76, ""1.Super User"", IF(sol_deposit >= 21.16, ""2.High Level User"", ""3.Normal User"")) AS user_type
    FROM deposit_withdraw_sum
    -- WHERE sol_deposit <= 200
    -- GROUP BY sol_deposit
    -- ORDER BY sol_deposit
)

SELECT 
    COUNT(signer),
    SUM(sol_deposit),
    SUM(sol_withdraw),
    SUM(sol_deposit + sol_withdraw),
    user_type
FROM deposit_distribute_table
GROUP BY user_type
ORDER BY user_type DESC"
640305,买入GMT的用户数据统计,,"with trade_gmt_sum (
  SELECT 
    signer,
    date_part('day', MAX(block_date) - MIN(block_date)) + 1 as day_cnt,
    SUM(IF(post_token_balance.amount - pre_token_balance.amount > 0, 
            post_token_balance.amount - pre_token_balance.amount, 
            0)) as buy_gmt_amount,
    -- 0 as buy_gmt_amount,
    -- SUM(-IF(post_token_balance.amount - pre_token_balance.amount < 0, 
    --         post_token_balance.amount - pre_token_balance.amount, 
    --         0)) as sell_gmt_amount,
    -- 0 as sell_gmt_amount
    COUNT(signer) as cnt,
    COUNT(signer)/(date_part('day', MAX(block_date) - MIN(block_date)) + 1) AS cnt_dialy
  FROM
    solana.transactions
    LATERAL VIEW explode(instructions) i1 AS instruction 
    LATERAL VIEW explode(instruction.inner_instructions) ii1 AS inner_instruction 
    LATERAL VIEW explode(pre_token_balances) p1 AS pre_token_balance 
    LATERAL VIEW explode(post_token_balances) p2 AS post_token_balance 
  WHERE
    block_date > CURRENT_DATE - '14 days'::INTERVAL
    AND block_date <= CURRENT_DATE
    AND ARRAY_CONTAINS(account_keys,""BTpvbpTArnekGgbXRqjfSvp7gENtHXvZCAwuUKQNYMeN"")
    AND inner_instruction.executing_account = 'TokenkegQfeZyiNwAJbNbGKPFXCWuBvf9Ss623VQ5DA'
    AND 
        (
            (
                inner_instruction.account_arguments[0] = ""BTpvbpTArnekGgbXRqjfSvp7gENtHXvZCAwuUKQNYMeN""
                AND
                pre_token_balance.account = inner_instruction.account_arguments[1]
            )
            -- OR
            -- (
            --     inner_instruction.account_arguments[1] = ""BTpvbpTArnekGgbXRqjfSvp7gENtHXvZCAwuUKQNYMeN""
            --     AND
            --     pre_token_balance.account = inner_instruction.account_arguments[0]
            -- )
        )
    AND SIZE(inner_instruction.account_arguments) = 3
    AND pre_token_balance.account = post_token_balance.account
    AND error IS NULL
    GROUP BY signer
    -- ORDER BY cnt_dialy
    -- HAVING cnt < 2 AND buy_gmt_amount > 100
    -- LIMIT 100
)

, trade_gmt_sum_inactive_account AS (
    SELECT 
        SUM(buy_gmt_amount) AS amount,
        ""inactive_user"" AS user_type
    FROM 
        trade_gmt_sum
    WHERE cnt = 1
    
)

, trade_gmt_abnormal_account AS (
    SELECT
        SUM(buy_gmt_amount) AS amount,
        ""trader"" AS user_type
    FROM 
        trade_gmt_sum
    WHERE cnt_dialy >= 8
    AND signer <> ""BURN8w15M1uHG1caYV4PHLwNRHoaANGJkugfunDk52hL""
)

, trade_gmt_normal_users AS (
    SELECT 
        SUM(buy_gmt_amount) AS amount,
        ""normal_user"" AS user_type
    FROM 
        trade_gmt_sum
    WHERE cnt_dialy < 8 AND cnt > 1
)

, trade_gmt_stepn_burn AS (
    SELECT
        SUM(buy_gmt_amount) AS amount,
        ""stepn_burn"" AS user_type
    FROM 
        trade_gmt_sum
    WHERE 
        signer = ""BURN8w15M1uHG1caYV4PHLwNRHoaANGJkugfunDk52hL""
)

SELECT * FROM trade_gmt_sum_inactive_account
UNION 
SELECT * FROM trade_gmt_abnormal_account
UNION
SELECT * FROM trade_gmt_normal_users
UNION
SELECT * FROM trade_gmt_stepn_burn"
